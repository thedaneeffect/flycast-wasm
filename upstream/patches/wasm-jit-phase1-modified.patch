diff --git a/CMakeLists.txt b/CMakeLists.txt
index 878b5d5..88626f9 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -1,1653 +1,1666 @@
-if(APPLE AND NOT LIBRETRO)
-	# Requirement from SDL
-	# Minimum version for $<LINK_LIBRARY:feature,library-list>
-	cmake_minimum_required(VERSION 3.24)
-else()
-	cmake_minimum_required(VERSION 3.22.1)
-endif()
-
-find_program(CCACHE_PROGRAM ccache)
-if(CCACHE_PROGRAM)
-	set(CMAKE_C_COMPILER_LAUNCHER ${CCACHE_PROGRAM} CACHE STRING "Compiler launcher for C.")
-	set(CMAKE_CXX_COMPILER_LAUNCHER ${CCACHE_PROGRAM} CACHE STRING "Compiler launcher for CXX.")
-endif()
-
-set(SENTRY_UPLOAD_URL "" CACHE STRING "Sentry upload URL")
-
-set(CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/shell/cmake")
-
-# Set WINDOWS_STORE flag for UWP builds
-if(CMAKE_SYSTEM_NAME STREQUAL "WindowsStore")
-	set(WINDOWS_STORE TRUE)
-endif()
-
-# Set Windows 7 as minimum version for MinGW build
-if(MINGW)
-	add_compile_definitions(_WIN32_WINNT=0x0601 WINVER=0x0601)
-	add_link_options("-Wl,--subsystem,windows:6.1")
-endif()
-
-if(APPLE)
-	if(CMAKE_SYSTEM_NAME STREQUAL iOS)
-		set(CMAKE_OSX_DEPLOYMENT_TARGET "12.0" CACHE STRING "Minimum iOS deployment version")
-		set(CMAKE_OSX_ARCHITECTURES "arm64" CACHE STRING "")
-	elseif(CMAKE_SYSTEM_NAME STREQUAL tvOS)
-		set(CMAKE_OSX_DEPLOYMENT_TARGET "12.0" CACHE STRING "Minimum tvOS deployment version")
-		set(CMAKE_OSX_ARCHITECTURES "arm64" CACHE STRING "")
-	else()
-		set(CMAKE_OSX_DEPLOYMENT_TARGET "10.15" CACHE STRING "Minimum macOS deployment version")
-		set(CMAKE_OSX_ARCHITECTURES "x86_64;arm64" CACHE STRING "")
-	endif()
-	set(ZLIB_LIBRARY "-lz" CACHE STRING "Use generic linker flag for Xcode to support multiple SDKs")
-endif()
-
-if(LIBRETRO)
-	project(flycast_libretro)
-else()
-	project(flycast)
-endif()
-
-set(CMAKE_CXX_STANDARD 17)
-set(CMAKE_CXX_STANDARD_REQUIRED ON)
-if(CMAKE_SYSTEM_NAME MATCHES "NetBSD|Haiku" OR NINTENDO_SWITCH)
-	set(CMAKE_CXX_EXTENSIONS ON)
-else()
-	set(CMAKE_CXX_EXTENSIONS OFF)
-endif()
-
-include(DetectArchitecture)
-if(NOT DEFINED ARCHITECTURE)
-	message(FATAL_ERROR "Unsupported architecture encountered. Ending CMake generation.")
-endif()
-message(STATUS "Target architecture: ${ARCHITECTURE}")
-
-if(CMAKE_CXX_COMPILER MATCHES "webos" OR
-   CMAKE_CXX_COMPILER MATCHES "starfish")
-	set(WEBOS ON)
-endif()
-
-set(USE_HOST_SDL_DEFAULT OFF)
-if(NOT APPLE AND (NOT UNIX OR CMAKE_SYSTEM_NAME MATCHES "DragonFly|FreeBSD|OpenBSD|NetBSD|Haiku"))
-	set(USE_HOST_SDL_DEFAULT ON)
-endif()
-
-option(ENABLE_CTEST "Enables unit tests" OFF)
-option(ENABLE_OPROFILE "Enable OProfile" OFF)
-option(TEST_AUTOMATION "Enable test automation" OFF)
-option(ENABLE_LOG "Enable full logging" OFF)
-option(ASAN "Enable address sanitizer" OFF)
-option(USE_GLES "Use GLES[3] API" OFF)
-option(USE_GLES2 "Use GLES2 API" OFF)
-option(USE_HOST_GLSLANG "Use host glslang" OFF)
-option(USE_HOST_LIBZIP "Use host libzip" ON)
-option(USE_HOST_SDL "Use host SDL library" ${USE_HOST_SDL_DEFAULT})
-option(USE_HOST_LIBCHDR "Use host libchdr" OFF)
-option(USE_OPENMP "Use OpenMP if available" ON)
-option(USE_VULKAN "Build with Vulkan support" ON)
-option(USE_DX9 "Build with Direct3D 9 support" ON)
-option(USE_DX11 "Build with Direct3D 11 support" ON)
-option(LIBRETRO "Build libretro core" OFF)
-option(USE_OPENGL "Use OpenGL API" ON)
-option(USE_VIDEOCORE "RPI: use the legacy Broadcom GLES libraries" OFF)
-option(USE_ALSA "Build with ALSA support" ON)
-option(USE_LIBAO "Build with AO support" ON)
-option(USE_OSS "Build with OSS support" OFF)
-option(USE_PULSEAUDIO "Build with PulseAudio support" ON)
-option(USE_BREAKPAD "Build and link with breakpad library" ON)
-option(USE_LUA "Build with Lua support" ON)
-option(ENABLE_GDB_SERVER "Build with GDB debugging support" OFF)
-option(ENABLE_DC_PROFILER "Build with support for target machine (SH4) profiler" OFF)
-option(ENABLE_FC_PROFILER "Build with support for host app (Flycast) profiler" OFF)
-option(USE_DISCORD "Use Discord Presence API" OFF)
-option(USE_LIBCDIO "Use libcdio for CDROM access" OFF)
-
-if(IOS AND NOT LIBRETRO)
-	set(USE_VULKAN OFF CACHE BOOL "Force vulkan off" FORCE)
-endif()
-
-if(WEBOS)
-	set(USE_GLES2 ON CACHE BOOL "Use GLES2 API" FORCE)
-	set(USE_OPENMP OFF CACHE BOOL "Force openmp off" FORCE)
-	set(USE_VULKAN OFF CACHE BOOL "Force vulkan off" FORCE)
-endif()
-
-include(GNUInstallDirs)
-include(CMakeRC)
-
-if(ENABLE_CTEST)
-	include(CTest)
-	add_compile_definitions(FLYCAST_TEST_FILES="${CMAKE_CURRENT_SOURCE_DIR}/tests/files")
-endif()
-
-if(IOS AND NOT LIBRETRO)
-	set(CMAKE_Swift_LANGUAGE_VERSION 5.0)
-	enable_language(Swift)
-endif()
-
-find_package(Git)
-if(GIT_FOUND AND EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/.git")
-	execute_process(
-		COMMAND ${GIT_EXECUTABLE} describe --tags --always
-		WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
-		OUTPUT_VARIABLE GIT_VERSION
-		OUTPUT_STRIP_TRAILING_WHITESPACE
-	)
-	execute_process(
-		COMMAND ${GIT_EXECUTABLE} rev-parse --short HEAD
-		WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
-		OUTPUT_VARIABLE GIT_HASH
-		OUTPUT_STRIP_TRAILING_WHITESPACE
-	)
-else()
-	set(GIT_VERSION "v0.0.0-0-g000000000")
-	set(GIT_HASH "000000000")
-endif()
-
-if(WINDOWS_STORE)
-	string(REGEX REPLACE "[Vv]" "" MS_VERSION ${GIT_VERSION})
-	string(REPLACE "-" "." MS_VERSION ${MS_VERSION})
-	string(REGEX REPLACE "\.g[0-9a-f]+" "" MS_VERSION ${MS_VERSION})
-	string(REGEX MATCHALL "[0-9]+" VERSION_PARTS ${MS_VERSION})
-	list(LENGTH VERSION_PARTS VERSION_PARTS_LENGTH)
-	if(VERSION_PARTS_LENGTH EQUAL 2)
-		string(APPEND MS_VERSION ".0.0")
-	elseif(VERSION_PARTS_LENGTH EQUAL 3)
-		string(APPEND MS_VERSION ".0")
-	endif()
-endif()
-
-string(TIMESTAMP BUILD_TIMESTAMP UTC)
-configure_file("${CMAKE_CURRENT_SOURCE_DIR}/core/version.h.in" "${CMAKE_CURRENT_SOURCE_DIR}/core/version.h" @ONLY)
-
-if(NINTENDO_SWITCH)
-	set(USE_VULKAN OFF)
-	enable_language(ASM)
-
-	if(LIBRETRO)
-		add_library(${PROJECT_NAME} STATIC core/emulator.cpp)
-		target_compile_definitions(${PROJECT_NAME} PRIVATE LIBRETRO HAVE_LIBNX HAVE_OPENGL HAVE_OIT)
-		find_path(GLEXT_H_INCLUDE_DIR NAMES GL/glext.h REQUIRED)
-		target_include_directories(${PROJECT_NAME} PRIVATE ${GLEXT_H_INCLUDE_DIR})
-		set_target_properties(${PROJECT_NAME} PROPERTIES OUTPUT_NAME "flycast_libretro_libnx")
-		set(CMAKE_STATIC_LIBRARY_PREFIX "")
-	else()
-		add_executable(${PROJECT_NAME} core/emulator.cpp)
-	endif()
-	if(USE_GLES)
-		target_compile_definitions(${PROJECT_NAME} PRIVATE GLES)
-	endif()
-	# asio
-	target_compile_definitions(${PROJECT_NAME} PRIVATE
-		ASIO_DISABLE_LOCAL_SOCKETS
-		ASIO_DISABLE_SERIAL_PORT
-		ESHUTDOWN=110
-		SA_RESTART=0
-		SA_NOCLDWAIT=0
-		IMGUI_DISABLE_DEFAULT_SHELL_FUNCTIONS)
-
-elseif(LIBRETRO)
-	add_library(${PROJECT_NAME} SHARED core/emulator.cpp)
-	if(APPLE)
-		if(NOT IOS)
-			set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,-undefined,error")
-		endif()
-		set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,-exported_symbols_list,${CMAKE_CURRENT_SOURCE_DIR}/shell/libretro/libretro.osx.def")
-	else()
-		if(NOT CMAKE_SYSTEM_NAME STREQUAL "OpenBSD")
-			set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,--no-undefined")
-		endif()
-	endif()
-	set_target_properties(${PROJECT_NAME} PROPERTIES OUTPUT_NAME "flycast_libretro"
-	  XCODE_ATTRIBUTE_CODE_SIGNING_ALLOWED "NO"
-	  XCODE_ATTRIBUTE_CODE_SIGN_IDENTITY ""
-    )
-	set(CMAKE_SHARED_LIBRARY_PREFIX "")
-	set(CMAKE_POSITION_INDEPENDENT_CODE ON)
-	target_compile_definitions(${PROJECT_NAME} PRIVATE LIBRETRO)
-	if(APPLE)
-		find_library(FOUNDATION Foundation)
-		target_link_libraries(${PROJECT_NAME} PRIVATE ${FOUNDATION})
-	endif()
-	if(ANDROID OR USE_GLES)
-		target_compile_definitions(${PROJECT_NAME} PRIVATE GLES GLES3 HAVE_OPENGLES HAVE_OPENGLES3 HAVE_OIT)
-    elseif(IOS)
-		target_compile_definitions(${PROJECT_NAME} PRIVATE GLES GLES3 HAVE_OPENGLES HAVE_OPENGLES3)
-		find_library(OPENGLES OpenGLES)
-		find_library(GLKIT GLKit)
-		target_link_libraries(${PROJECT_NAME} PRIVATE ${OPENGLES} ${GLKIT})
-	elseif(USE_GLES2)
-		target_compile_definitions(${PROJECT_NAME} PRIVATE GLES GLES2 HAVE_OPENGLES HAVE_OPENGLES2)
-		if(USE_VIDEOCORE)
-			target_compile_definitions(${PROJECT_NAME} PRIVATE TARGET_NO_STENCIL)
-			target_link_libraries(${PROJECT_NAME} PRIVATE "-lbrcmGLESv2")
-			target_link_directories(${PROJECT_NAME} PRIVATE "/opt/vc/lib")
-		else()
-			target_link_libraries(${PROJECT_NAME} PRIVATE "-lGLESv2")
-		endif()
-	elseif(USE_OPENGL)
-		if (CMAKE_SYSTEM_NAME MATCHES "FreeBSD|OpenBSD|NetBSD")
-			find_package(OpenGL REQUIRED)
-			if(CMAKE_VERSION VERSION_LESS 3.29.0)
-				target_include_directories(${PROJECT_NAME} PRIVATE ${OPENGL_INCLUDE_DIR})
-			else()
-				target_include_directories(${PROJECT_NAME} PRIVATE ${OPENGL_INCLUDE_DIRS})
-			endif()
-		endif()
-		target_compile_definitions(${PROJECT_NAME} PRIVATE HAVE_OPENGL)
-		if(APPLE)
-			set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,-framework,OpenGL")
-		else()
-			target_compile_definitions(${PROJECT_NAME} PRIVATE HAVE_OIT)
-		endif()
-	endif()
-elseif(ANDROID)
-	add_library(${PROJECT_NAME} SHARED core/emulator.cpp)
-	set(CMAKE_C_FLAGS_DEBUG "${CMAKE_C_FLAGS_RELEASE} -O3")
-	set(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_RELEASE} -O3")
-	target_compile_options(${PROJECT_NAME} PRIVATE -fno-stack-protector)
-	set(CMAKE_ANDROID_STL_TYPE "c++_static")
-elseif(WIN32)
-	if(BUILD_TESTING)
-		add_executable(${PROJECT_NAME} core/emulator.cpp)
-	else()
-		add_executable(${PROJECT_NAME} WIN32 core/emulator.cpp)
-	endif()
-	if(CMAKE_GENERATOR MATCHES "Visual Studio")
-		if(NOT CMAKE_VS_GLOBALS MATCHES "(^|;)UseMultiToolTask=")
-			list(APPEND CMAKE_VS_GLOBALS UseMultiToolTask=true)
-		endif()
-		if(NOT CMAKE_VS_GLOBALS MATCHES "(^|;)EnforceProcessCountAcrossBuilds=")
-			list(APPEND CMAKE_VS_GLOBALS EnforceProcessCountAcrossBuilds=true)
-		endif()
-		set_property(DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR} PROPERTY VS_STARTUP_PROJECT ${PROJECT_NAME})
-	endif()
-elseif(APPLE)
-	add_executable(${PROJECT_NAME} MACOSX_BUNDLE core/emulator.cpp)
-else()
-	add_executable(${PROJECT_NAME} core/emulator.cpp)
-endif()
-
-set_target_properties(${PROJECT_NAME} PROPERTIES
-		CMAKE_CXX_STANDARD 20
-		CMAKE_CXX_STANDARD_REQUIRED ON)
-
-if(WINDOWS_STORE)
-	set(USE_OPENGL OFF)
-	set(USE_VULKAN OFF)
-endif()
-
-set_target_properties(${PROJECT_NAME} PROPERTIES LINK_FLAGS_RELEASE -s)
-if(MSVC)
-	target_compile_options(${PROJECT_NAME} PRIVATE /GR /GS-)
-	if(WINDOWS_STORE)
-		target_compile_options(${PROJECT_NAME} PRIVATE /ZW)
-	endif()
-else()
-	target_compile_options(${PROJECT_NAME} PRIVATE
-		$<$<COMPILE_LANGUAGE:CXX>:-fno-strict-aliasing>
-		$<$<COMPILE_LANGUAGE:CXX>:-Wall>)
-endif()
-
-if(APPLE AND NOT IOS)
-	set(TARGET_MAC ON)
-endif()
-
-target_compile_definitions(${PROJECT_NAME} PRIVATE
-		$<$<BOOL:${APPLE}>:GL_SILENCE_DEPRECATION>
-		$<$<BOOL:${ENABLE_LOG}>:DEBUGFAST>
-		$<$<BOOL:${IOS}>:TARGET_IPHONE>
-		$<$<BOOL:${TARGET_MAC}>:TARGET_MAC>
-		$<$<BOOL:${IOS}>:GLES>
-		$<$<BOOL:${IOS}>:GLES3>
-		$<$<BOOL:${IOS}>:GLES_SILENCE_DEPRECATION>
-		$<$<BOOL:${MSVC}>:_CRT_NONSTDC_NO_WARNINGS>
-		$<$<BOOL:${MSVC}>:_CRT_SECURE_NO_WARNINGS>
-		$<$<BOOL:${MSVC}>:_WINSOCK_DEPRECATED_NO_WARNING>
-		$<$<BOOL:${MSVC}>:NOMINMAX>
-		$<$<BOOL:${TEST_AUTOMATION}>:TEST_AUTOMATION>
-		$<$<BOOL:${WINDOWS_STORE}>:WINDOWS_STORE>
-		$<$<BOOL:${WINDOWS_STORE}>:TARGET_UWP>
-		$<$<BOOL:${WINDOWS_STORE}>:NOCRYPT>
-		$<$<BOOL:${WINDOWS_STORE}>:_WIN32_WINNT=0x0A00>
-		$<$<OR:$<BOOL:${MINGW}>,$<BOOL:${MSVC}>>:_USE_MATH_DEFINES>)
-
-if(UNIX AND NOT ANDROID AND NOT APPLE)
-	execute_process(COMMAND getconf PAGESIZE OUTPUT_VARIABLE PAGE_SIZE OUTPUT_STRIP_TRAILING_WHITESPACE)
-	target_compile_definitions(${PROJECT_NAME} PRIVATE PAGE_SIZE=${PAGE_SIZE})
-endif()
-
-if(NOT "${SENTRY_UPLOAD_URL}" STREQUAL "")
-	target_compile_definitions(${PROJECT_NAME} PRIVATE SENTRY_UPLOAD="${SENTRY_UPLOAD_URL}")
-endif()
-
-target_include_directories(${PROJECT_NAME} PRIVATE core core/deps core/deps/stb core/deps/json core/deps/asio/asio/include)
-if(LIBRETRO)
-	target_include_directories(${PROJECT_NAME} PRIVATE shell/libretro)
-endif()
-if(NINTENDO_SWITCH)
-	target_include_directories(${PROJECT_NAME} PRIVATE shell/switch)
-endif()
-
-if(CMAKE_SYSTEM_NAME STREQUAL "OpenBSD")
-	target_link_options(${PROJECT_NAME} PRIVATE "-Wl,--no-execute-only")
-endif()
-
-if(USE_BREAKPAD AND NOT LIBRETRO)
-	find_program(SH_EXECUTABLE sh)
-	if((ANDROID AND NOT CMAKE_HOST_SYSTEM_NAME STREQUAL "Windows") OR (MINGW AND SH_EXECUTABLE) OR (CMAKE_SYSTEM_NAME STREQUAL "Linux"))
-		add_subdirectory(core/deps/breakpad)
-		if(WIN32)
-			target_link_options(${PROJECT_NAME} PRIVATE "-Wl,--build-id")
-		endif()
-		target_link_libraries(${PROJECT_NAME} PUBLIC breakpad_client)
-		target_compile_definitions(${PROJECT_NAME} PRIVATE USE_BREAKPAD)
-	elseif(APPLE AND NOT IOS)
-		target_sources(${PROJECT_NAME} PRIVATE
-			core/deps/breakpad/src/client/minidump_file_writer-inl.h
-			core/deps/breakpad/src/client/minidump_file_writer.cc
-			core/deps/breakpad/src/client/minidump_file_writer.h
-			core/deps/breakpad/src/client/mac/handler/breakpad_nlist_64.cc
-			core/deps/breakpad/src/client/mac/handler/breakpad_nlist_64.h
-			core/deps/breakpad/src/client/mac/handler/dynamic_images.cc
-			core/deps/breakpad/src/client/mac/handler/dynamic_images.h
-			core/deps/breakpad/src/client/mac/handler/exception_handler.cc
-			core/deps/breakpad/src/client/mac/handler/exception_handler.h
-			core/deps/breakpad/src/client/mac/handler/minidump_generator.cc
-			core/deps/breakpad/src/client/mac/handler/minidump_generator.h
-			core/deps/breakpad/src/client/mac/handler/protected_memory_allocator.cc
-			core/deps/breakpad/src/client/mac/handler/protected_memory_allocator.h
-			core/deps/breakpad/src/client/mac/crash_generation/ConfigFile.h
-			core/deps/breakpad/src/client/mac/crash_generation/ConfigFile.mm
-			core/deps/breakpad/src/client/mac/crash_generation/client_info.h
-			core/deps/breakpad/src/client/mac/crash_generation/crash_generation_client.h
-			core/deps/breakpad/src/client/mac/crash_generation/crash_generation_client.cc
-			core/deps/breakpad/src/common/convert_UTF.cc
-			core/deps/breakpad/src/common/convert_UTF.h
-			core/deps/breakpad/src/common/md5.cc
-			core/deps/breakpad/src/common/string_conversion.cc
-			core/deps/breakpad/src/common/string_conversion.h
-			core/deps/breakpad/src/common/mac/file_id.cc
-			core/deps/breakpad/src/common/mac/file_id.h
-			core/deps/breakpad/src/common/mac/MachIPC.mm
-			core/deps/breakpad/src/common/mac/MachIPC.h
-			core/deps/breakpad/src/common/mac/bootstrap_compat.cc
-			core/deps/breakpad/src/common/mac/bootstrap_compat.h
-			core/deps/breakpad/src/common/mac/macho_id.cc
-			core/deps/breakpad/src/common/mac/macho_id.h
-			core/deps/breakpad/src/common/mac/macho_utilities.cc
-			core/deps/breakpad/src/common/mac/macho_utilities.h
-			core/deps/breakpad/src/common/mac/macho_walker.cc
-			core/deps/breakpad/src/common/mac/macho_walker.h
-			core/deps/breakpad/src/common/mac/string_utilities.cc
-			core/deps/breakpad/src/common/mac/string_utilities.h
-		)
-		target_include_directories(${PROJECT_NAME} PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/core/deps/breakpad/src)
-		target_compile_definitions(${PROJECT_NAME} PRIVATE USE_BREAKPAD)
-		add_custom_target(dump_syms COMMAND xcodebuild -project ${CMAKE_CURRENT_SOURCE_DIR}/core/deps/breakpad/src/tools/mac/dump_syms/dump_syms.xcodeproj -target dump_syms -configuration Release CONFIGURATION_BUILD_DIR=${CMAKE_CURRENT_SOURCE_DIR}/build/breakpad)
-		ADD_DEPENDENCIES(${PROJECT_NAME} dump_syms)
-
-		if(${CMAKE_GENERATOR} MATCHES "^Xcode.*")
-			add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
-				COMMAND sleep 20
-				COMMAND mkdir -p ../symbols
-				COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/build/breakpad/dump_syms
-					-a x86_64
-					-g ${CMAKE_CURRENT_BINARY_DIR}/$<CONFIG>/Flycast.app.dSYM
-					$<TARGET_FILE:flycast> > ../symbols/Flycast-x64.sym
-				COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/build/breakpad/dump_syms
-					-a arm64
-					-g ${CMAKE_CURRENT_BINARY_DIR}/$<CONFIG>/Flycast.app.dSYM
-					$<TARGET_FILE:flycast> > ../symbols/Flycast-arm64.sym
-			)
-		else()
-			add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
-				COMMAND sleep 20
-				COMMAND mkdir -p ../symbols
-				COMMAND dsymutil $<TARGET_FILE:flycast>
-					-o ${CMAKE_CURRENT_BINARY_DIR}/Flycast.app.dSYM
-				COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/build/breakpad/dump_syms
-					-a x86_64
-					-g ${CMAKE_CURRENT_BINARY_DIR}/Flycast.app.dSYM
-					$<TARGET_FILE:flycast> > ../symbols/Flycast-x64.sym
-				COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/build/breakpad/dump_syms
-					-a arm64
-					-g ${CMAKE_CURRENT_BINARY_DIR}/Flycast.app.dSYM
-					$<TARGET_FILE:flycast> > ../symbols/Flycast-arm64.sym
-			)
-		endif()
-	endif()
-endif()
-
-if(USE_OPENMP)
-	if(APPLE AND IS_DIRECTORY "/opt/homebrew/opt/libomp")
-		list(PREPEND CMAKE_PREFIX_PATH "/opt/homebrew/opt/libomp")
-		message(STATUS "Found and using Homebrew libomp hint.")
-	endif()
-	find_package(OpenMP)
-	if(OpenMP_CXX_FOUND)
-		if(MINGW)
-			target_link_libraries(${PROJECT_NAME} PRIVATE -lpthread)
-			target_link_options(${PROJECT_NAME} PRIVATE -fopenmp -static)
-			target_compile_options(${PROJECT_NAME} PRIVATE -fopenmp)
-		elseif(ANDROID)
-			# Reference: https://android.googlesource.com/platform/ndk/+/refs/heads/master/tests/device/openmp/CMakeLists.txt
-			set_target_properties(${PROJECT_NAME} PROPERTIES COMPILE_OPTIONS -fopenmp)
-			target_link_libraries(${PROJECT_NAME} PRIVATE -fopenmp -static-openmp)
-		else()
-			target_link_libraries(${PROJECT_NAME} PRIVATE OpenMP::OpenMP_CXX)
-		endif()
-	endif()
-endif()
-
-option(BUILD_SHARED_LIBS "Build shared library" OFF)
-set(XXHASH_BUILD_XXHSUM OFF CACHE BOOL "Build the xxhsum binary")
-add_subdirectory(core/deps/xxHash/cmake_unofficial)
-target_link_libraries(${PROJECT_NAME} PRIVATE xxHash::xxhash)
-
-option(BUILD_SHARED_LIBS "Build shared library" OFF)
-add_subdirectory(core/deps/glm)
-target_link_libraries(${PROJECT_NAME} PRIVATE glm::glm)
-
-if(USE_VULKAN)
-	if(USE_HOST_GLSLANG)
-		find_package(glslang REQUIRED)
-	else()
-		option(BUILD_EXTERNAL "Build external dependencies in /External" OFF)
-		option(ENABLE_SPVREMAPPER "Enables building of SPVRemapper" OFF)
-		option(ENABLE_GLSLANG_BINARIES "Builds glslang and spirv-remap" OFF)
-		option(ENABLE_HLSL "Enables HLSL input support" OFF)
-		option(ENABLE_OPT "Enables spirv-opt capability if present" OFF)
-		option(ENABLE_PCH "Enables Precompiled header" OFF)
-		add_subdirectory(core/deps/glslang EXCLUDE_FROM_ALL)
-	endif()
-	target_link_libraries(${PROJECT_NAME} PRIVATE glslang::glslang-default-resource-limits glslang::SPIRV)
-endif()
-
-if(NOT LIBRETRO)
-	if(USE_OSS)
-		target_compile_definitions(${PROJECT_NAME} PRIVATE USE_OSS)
-	endif()
-
-	if(USE_ALSA)
-		find_package(ALSA)
-		if(ALSA_FOUND AND NOT ANDROID)
-			target_compile_definitions(${PROJECT_NAME} PRIVATE USE_ALSA)
-			target_include_directories(${PROJECT_NAME} PRIVATE ${ALSA_INCLUDE_DIRS})
-			target_link_libraries(${PROJECT_NAME} PRIVATE ${ALSA_LIBRARIES})
-		endif()
-	endif()
-
-	if(MINGW)
-		target_link_libraries(${PROJECT_NAME} PRIVATE "-static-libgcc -static-libstdc++")
-	endif()
-
-	if(NOT ANDROID AND NOT IOS)
-		if (NOT NINTENDO_SWITCH)
-			# DreamLink enabled for non-mobile Linux, MacOS, and Windows
-			target_compile_definitions(${PROJECT_NAME} PRIVATE USE_DREAMLINK_DEVICES=1)
-			set(USE_DREAMLINK_DEVICES ON) # Must be set before adding core/sdl
-
-			if (WINDOWS_STORE)
-				# Use winrt implementation of the DreamPicoPort-API
-				option(DREAMPICOPORT_WITH_LIBUSB "Use libusb to access DreamPicoPort-API" OFF)
-			elseif (CMAKE_SYSTEM_NAME MATCHES "DragonFly|FreeBSD|NetBSD|OpenBSD|Haiku")
-				find_package(PkgConfig REQUIRED)
-   	 			pkg_check_modules(LIBUSB REQUIRED libusb-1.0)
-
-				set(DREAMPICOPORT_LIBUSB_LIBRARIES "${LIBUSB_LIBRARIES}" CACHE STRING "Name of the libusb library to link against")
-				set(DREAMPICOPORT_LIBUSB_INCLUDE_DIRS "${LIBUSB_INCLUDE_DIRS}" CACHE STRING "Path to libusb include directory, when applicable")
-			else()
-				if(MINGW)
-					# Shim 'windowsapp' to prevent libusb from linking against the UWP library
-					# and link against standard desktop libraries instead for Windows 7 support.
-					if(NOT TARGET windowsapp)
-						add_library(windowsapp INTERFACE)
-						target_link_libraries(windowsapp INTERFACE advapi32 ole32 shell32 user32)
-					endif()
-				endif()
-				# libusb
-				add_subdirectory(core/deps/DreamPicoPort-API/ext/libusb-cmake)
-			endif()
-
-			# DreamPicoPort-API
-			option(DREAMPICOPORT_ADD_LIBUSB "Add internal libusb library" OFF) # Already included above, when applicable
-			add_subdirectory(core/deps/DreamPicoPort-API EXCLUDE_FROM_ALL)
-			target_link_libraries(${PROJECT_NAME} PRIVATE dream_pico_port_api)
-		endif()
-
-		if(USE_HOST_SDL)
-			find_package(SDL2 2.0.9)
-		endif()
-		if(NOT SDL2_FOUND)
-			set(SDL_TEST_ENABLED_BY_DEFAULT OFF)
-			add_subdirectory(core/deps/SDL EXCLUDE_FROM_ALL)
-			set(SDL2_FOUND 1)
-		endif()
-
-		# SDL2::SDL2main may or may not be available. It is e.g. required by Windows GUI applications
-		if(TARGET SDL2::SDL2main AND NOT BUILD_TESTING)
-			# It has an implicit dependency on SDL2 functions, so it MUST be added before SDL2::SDL2 (or SDL2::SDL2-static)
-			target_link_libraries(${PROJECT_NAME} PRIVATE SDL2::SDL2main)
-		endif()
-
-		if((APPLE OR WIN32) AND TARGET SDL2::SDL2-static)
-			target_link_libraries(${PROJECT_NAME} PRIVATE SDL2::SDL2-static)
-		elseif(TARGET SDL2::SDL2)
-			target_link_libraries(${PROJECT_NAME} PRIVATE SDL2::SDL2)
-		else()
-			target_include_directories(${PROJECT_NAME} PRIVATE ${SDL2_INCLUDE_DIRS})
-			target_link_libraries(${PROJECT_NAME} PRIVATE ${SDL2_LIBRARIES})
-		endif()
-
-		target_compile_definitions(${PROJECT_NAME} PRIVATE USE_SDL USE_SDL_AUDIO)
-		add_subdirectory(core/sdl)
-
-		if((UNIX AND NOT APPLE) OR NINTENDO_SWITCH)
-			find_package(CURL REQUIRED)
-			target_link_libraries(${PROJECT_NAME} PRIVATE CURL::libcurl)
-		endif()
-	endif()
-
-	find_package(ZLIB)
-	if(TARGET ZLIB::ZLIB AND NOT ANDROID AND (NOT WIN32 OR WINDOWS_STORE))
-		set(WITH_SYSTEM_ZLIB ON CACHE BOOL "Use system provided zlib library")
-		target_link_libraries(${PROJECT_NAME} PRIVATE ZLIB::ZLIB)
-	endif()
-
-	if(USE_LUA)
-		find_package(Lua 5.2)
-		if(NOT APPLE AND LUA_FOUND)
-			target_compile_definitions(${PROJECT_NAME} PRIVATE USE_LUA)
-			target_include_directories(${PROJECT_NAME} PRIVATE ${LUA_INCLUDE_DIR} core/deps/luabridge/Source)
-			list(TRANSFORM LUA_LIBRARIES REPLACE "\.dll" "")
-			target_link_libraries(${PROJECT_NAME} PRIVATE ${LUA_LIBRARIES})
-		endif()
-	endif()
-endif()
-
-find_package(PkgConfig)
-
-if(NOT WITH_SYSTEM_ZLIB)
-    option(ZLIB_BUILD_EXAMPLES "Enable Zlib Examples" OFF)
-    add_subdirectory("core/deps/libchdr/deps/zlib-1.3.1" EXCLUDE_FROM_ALL)
-	set_target_properties(zlibstatic PROPERTIES POSITION_INDEPENDENT_CODE ON)
-	target_link_libraries(${PROJECT_NAME} PRIVATE zlibstatic)
-	# help libzip find the package
-	set(ZLIB_RELATIVE_PATH "core/deps/libchdr/deps/zlib-1.3.1")
-	set(ZLIB_INCLUDE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/${ZLIB_RELATIVE_PATH}" "${CMAKE_CURRENT_BINARY_DIR}/${ZLIB_RELATIVE_PATH}")
-endif()
-
-if(PKG_CONFIG_FOUND AND USE_HOST_LIBCHDR)
-	pkg_check_modules(LIBCHDR IMPORTED_TARGET libchdr)
-	target_link_libraries(${PROJECT_NAME} PRIVATE PkgConfig::LIBCHDR)
-else()
-	option(ZSTD_BUILD_SHARED "BUILD SHARED LIBRARIES" OFF)
-	option(ZSTD_BUILD_PROGRAMS "BUILD PROGRAMS" OFF)
-	option(ZSTD_LEGACY_SUPPORT "LEGACY SUPPORT" OFF)
-	add_subdirectory(core/deps/libchdr/deps/zstd-1.5.6/build/cmake EXCLUDE_FROM_ALL)
-	target_link_libraries(${PROJECT_NAME} PRIVATE libzstd_static)
-
-	option(WITH_SYSTEM_ZSTD "Use system provided zstd library" ON)
-	add_subdirectory(core/deps/libchdr EXCLUDE_FROM_ALL)
-	target_link_libraries(${PROJECT_NAME} PRIVATE chdr-static)
-	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/libchdr/include)
-endif()
-
-if(PKG_CONFIG_FOUND AND NOT ANDROID AND NOT APPLE AND NOT LIBRETRO)
-	if(USE_LIBAO)
-		pkg_check_modules(AO IMPORTED_TARGET ao)
-		if(AO_FOUND)
-			target_compile_definitions(${PROJECT_NAME} PRIVATE USE_LIBAO)
-			target_link_libraries(${PROJECT_NAME} PRIVATE PkgConfig::AO)
-		endif()
-	endif()
-
-	if(NOT SDL2_FOUND)
-		pkg_check_modules(LIBEVDEV IMPORTED_TARGET libevdev)
-		if(LIBEVDEV_FOUND)
-			target_compile_definitions(${PROJECT_NAME} PRIVATE USE_EVDEV)
-			target_link_libraries(${PROJECT_NAME} PRIVATE PkgConfig::LIBEVDEV)
-
-			pkg_check_modules(LIBUDEV IMPORTED_TARGET libudev)
-			if(LIBUDEV_FOUND)
-				target_compile_definitions(${PROJECT_NAME} PRIVATE USE_UDEV)
-				target_link_libraries(${PROJECT_NAME} PRIVATE PkgConfig::LIBUDEV)
-			endif()
-		endif()
-	endif()
-
-	if(USE_PULSEAUDIO)
-		pkg_check_modules(LIBPULSE IMPORTED_TARGET libpulse)
-		if(LIBPULSE_FOUND)
-			target_compile_definitions(${PROJECT_NAME} PRIVATE USE_PULSEAUDIO)
-			target_link_libraries(${PROJECT_NAME} PRIVATE PkgConfig::LIBPULSE)
-		endif()
-	endif()
-
-	if(USE_HOST_LIBZIP)
-		pkg_check_modules(LIBZIP IMPORTED_TARGET libzip)
-		if(LIBZIP_FOUND)
-			target_link_libraries(${PROJECT_NAME} PRIVATE PkgConfig::LIBZIP)
-		endif()
-	endif()
-
-	if(ENABLE_OPROFILE)
-		target_compile_definitions(${PROJECT_NAME} PRIVATE DYNA_OPROF)
-		target_link_libraries(${PROJECT_NAME} PRIVATE opagent)
-	endif()
-
-	find_package(MiniUPnPc)
-	if(MINIUPNP_FOUND)
-		target_include_directories(${PROJECT_NAME} PRIVATE ${MINIUPNP_INCLUDE_DIRS})
-		target_link_libraries(${PROJECT_NAME} PRIVATE ${MINIUPNP_LIBRARIES})
-	endif()
-endif()
-
-if(UNIX AND NOT APPLE AND NOT ANDROID)
-	add_definitions(
-		-DFLYCAST_DATADIR="${CMAKE_INSTALL_FULL_DATADIR}/${PROJECT_NAME}/"
-		-DFLYCAST_SYSCONFDIR="${CMAKE_INSTALL_FULL_SYSCONFDIR}/${PROJECT_NAME}/"
-	)
-
-	if(USE_GLES2)
-		target_compile_definitions(${PROJECT_NAME} PRIVATE GLES GLES2)
-		if(USE_VIDEOCORE)
-			target_compile_definitions(${PROJECT_NAME} PRIVATE TARGET_VIDEOCORE USE_OMX)
-			target_link_libraries(${PROJECT_NAME} PRIVATE "-lbrcmGLESv2")
-			target_link_directories(${PROJECT_NAME} PRIVATE "/opt/vc/lib")
-		endif()
-	elseif(USE_GLES)
-		target_compile_definitions(${PROJECT_NAME} PRIVATE GLES GLES3)
-	endif()
-
-	find_package(Threads REQUIRED)
-	target_link_libraries(${PROJECT_NAME} PRIVATE Threads::Threads)
-	if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU" AND "x86_64" IN_LIST ARCHITECTURE AND NOT LIBRETRO)
-		set_target_properties(${PROJECT_NAME} PROPERTIES POSITION_INDEPENDENT_CODE False)
-		if(${CMAKE_VERSION} VERSION_LESS "3.14.0")
-			set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -no-pie")
-		endif()
-	endif()
-
-	if(NOT SDL2_FOUND AND NOT LIBRETRO)
-		find_package(X11 REQUIRED)
-		if(X11_FOUND)
-			target_compile_definitions(${PROJECT_NAME} PRIVATE SUPPORT_X11)
-			target_include_directories(${PROJECT_NAME} PRIVATE ${X11_INCLUDE_DIR})
-			target_link_libraries(${PROJECT_NAME} PRIVATE ${X11_LIBRARIES})
-		endif()
-	endif()
-
-	find_library(LIBRT rt)
-	if(LIBRT)
-		target_link_libraries(${PROJECT_NAME} PRIVATE ${LIBRT})
-	endif()
-
-	target_link_libraries(${PROJECT_NAME} PRIVATE ${CMAKE_DL_LIBS})
-endif()
-
-if(ASAN)
-	if(ANDROID)
-		target_compile_options(${PROJECT_NAME} PRIVATE -fsanitize=address -fno-omit-frame-pointer)
-		set_target_properties(${PROJECT_NAME} PROPERTIES LINK_FLAGS -fsanitize=address)
-	else()
-		target_compile_options(${PROJECT_NAME} PRIVATE -fsanitize=address -static-libasan)
-		set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -fsanitize=address -static-libasan")
-	endif()
-endif()
-
-if(ANDROID AND "arm" IN_LIST ARCHITECTURE)
-	enable_language(ASM)
-	option(LIBUNWIND_ENABLE_SHARED "Build libunwind as a shared library." OFF)
-	add_subdirectory(core/deps/libunwind/libunwind)
-	target_link_libraries(${PROJECT_NAME} PRIVATE unwind_static)
-endif()
-
-if(ANDROID AND NOT LIBRETRO)
-	set(BUILD_SHARED_LIBS OFF)
-	add_subdirectory(core/deps/oboe)
-	target_compile_definitions(${PROJECT_NAME} PRIVATE USE_OBOE)
-	target_link_libraries(${PROJECT_NAME} PRIVATE oboe)
-endif()
-
-target_sources(${PROJECT_NAME} PRIVATE
-		core/deps/chdpsr/cdipsr.cpp
-		core/deps/chdpsr/cdipsr.h)
-
-add_subdirectory(core/deps/nowide EXCLUDE_FROM_ALL)
-target_link_libraries(${PROJECT_NAME} PRIVATE nowide::nowide)
-
-if(NOT MINIUPNP_FOUND)
-	if(NINTENDO_SWITCH)
-		target_compile_definitions(${PROJECT_NAME} PRIVATE FEAT_NO_MINIUPNPC)
-	else()
-		option(UPNPC_BUILD_SHARED "Build shared library" OFF)
-		option(UPNPC_BUILD_TESTS "Build test executables" OFF)
-		option(UPNPC_BUILD_SAMPLE "Build sample executables" OFF)
-		option(UPNPC_NO_INSTALL "Disable installation" ON)
-		add_subdirectory(core/deps/miniupnpc)
-		if(WINDOWS_STORE OR MINGW)
-			get_target_property(miniupnpc-private-defs miniupnpc-private INTERFACE_COMPILE_DEFINITIONS)
-			list(REMOVE_ITEM miniupnpc-private-defs "_WIN32_WINNT=0x0501")
-			set_property(TARGET miniupnpc-private PROPERTY INTERFACE_COMPILE_DEFINITIONS ${miniupnpc-private-defs})
-		endif()
-		target_link_libraries(${PROJECT_NAME} PRIVATE miniupnpc::miniupnpc)
-	endif()
-endif()
-
-if(NOT LIBZIP_FOUND OR NINTENDO_SWITCH)
-	option(ENABLE_COMMONCRYPTO "Enable use of CommonCrypto" OFF)
-	option(ENABLE_GNUTLS "Enable use of GnuTLS" OFF)
-	option(ENABLE_MBEDTLS "Enable use of mbed TLS" OFF)
-	option(ENABLE_OPENSSL "Enable use of OpenSSL" OFF)
-	option(ENABLE_WINDOWS_CRYPTO "Enable use of Windows cryptography libraries" OFF)
-	option(ENABLE_BZIP2 "Enable use of BZip2" OFF)
-	option(ENABLE_LZMA "Enable use of LZMA" OFF)
-	option(ENABLE_ZSTD "Enable use of Zstandard" ON)
-	option(BUILD_TOOLS "Build tools in the src directory (zipcmp, zipmerge, ziptool)" OFF)
-	option(BUILD_REGRESS "Build regression tests" OFF)
-	option(BUILD_EXAMPLES "Build examples" OFF)
-	option(BUILD_DOC "Build documentation" OFF)
-	option(BUILD_SHARED_LIBS "Build shared libraries" OFF)
-	option(LIBZIP_DO_INSTALL "Install libzip and the related files" OFF)
-	add_subdirectory(core/deps/libzip EXCLUDE_FROM_ALL)
-	target_link_libraries(${PROJECT_NAME} PRIVATE libzip::zip)
-endif()
-
-if(USE_LIBCDIO)
-	if(PKG_CONFIG_FOUND)
-		pkg_check_modules(CDIO IMPORTED_TARGET libcdio)
-		if(CDIO_FOUND)
-			target_compile_definitions(${PROJECT_NAME} PRIVATE USE_LIBCDIO)
-			if(MINGW)
-				# Force static link
-				target_link_libraries(${PROJECT_NAME} PRIVATE "-l:libcdio.a -l:libiconv.a -lwinmm")
-			else()
-				target_link_libraries(${PROJECT_NAME} PRIVATE PkgConfig::CDIO)
-			endif()
-		endif()
-	endif()
-	if(NOT CDIO_FOUND)
-		find_package(libcdio)
-		if(TARGET libcdio::libcdio)
-			target_compile_definitions(${PROJECT_NAME} PRIVATE USE_LIBCDIO)
-			target_link_libraries(${PROJECT_NAME} PRIVATE libcdio::libcdio)
-		endif()
-	endif()
-endif()
-
-if(WIN32)
-	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/dirent)
-endif()
-
-if(NOT LIBRETRO AND NOT NINTENDO_SWITCH)
-	target_compile_definitions(${PROJECT_NAME} PRIVATE USE_ICE)
-	# libjuice
-	option(BUILD_SHARED_LIBS "Build shared libraries" OFF)
-	option(NO_SERVER "Disable server support" ON)
-	option(NO_TESTS "Disable tests build" ON)
-	add_subdirectory(core/deps/libjuice EXCLUDE_FROM_ALL)
-	target_link_libraries(${PROJECT_NAME} PRIVATE LibJuice::LibJuiceStatic)
-
-	# websocket++
-	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/websocketpp)
-	target_compile_definitions(${PROJECT_NAME} PRIVATE ASIO_STANDALONE)
-	if (MSVC)
-		target_compile_definitions(${PROJECT_NAME} PRIVATE
-			_WEBSOCKETPP_CPP11_FUNCTIONAL_
-			_WEBSOCKETPP_CPP11_SYSTEM_ERROR_
-			_WEBSOCKETPP_CPP11_RANDOM_DEVICE_
-			_WEBSOCKETPP_CPP11_MEMORY_
-			_WEBSOCKETPP_CPP11_TYPE_TRAITS_)
-	elseif(MINGW)
-		target_compile_definitions(${PROJECT_NAME} PRIVATE _WEBSOCKETPP_CPP11_THREAD_)
-	else()
-		target_compile_definitions(${PROJECT_NAME} PRIVATE _WEBSOCKETPP_CPP11_STL_)
-	endif()
-endif()
-
-set(TINYGETTEXT_WO_ICONV ON)
-add_subdirectory(core/deps/tinygettext EXCLUDE_FROM_ALL)
-target_include_directories(${PROJECT_NAME} PRIVATE core/deps/tinygettext/include)
-target_link_libraries(${PROJECT_NAME} PRIVATE tinygettext::tinygettext)
-
-target_include_directories(${PROJECT_NAME} PRIVATE core/deps/picotcp/include core/deps/picotcp/modules)
-target_sources(${PROJECT_NAME} PRIVATE
-		core/deps/picotcp/include/arch/pico_arm9.h
-		core/deps/picotcp/include/arch/pico_atsamd21j18.h
-		core/deps/picotcp/include/arch/pico_avr.h
-		core/deps/picotcp/include/arch/pico_cortex_m.h
-		core/deps/picotcp/include/arch/pico_dos.h
-		core/deps/picotcp/include/arch/pico_esp8266.h
-		core/deps/picotcp/include/arch/pico_generic_gcc.h
-		core/deps/picotcp/include/arch/pico_linux.h
-		core/deps/picotcp/include/arch/pico_mbed.h
-		core/deps/picotcp/include/arch/pico_msp430.h
-		core/deps/picotcp/include/arch/pico_msvc.h
-		core/deps/picotcp/include/arch/pico_none.h
-		core/deps/picotcp/include/arch/pico_pic24.h
-		core/deps/picotcp/include/arch/pico_pic32.h
-		core/deps/picotcp/include/arch/pico_posix.h
-		core/deps/picotcp/include/heap.h
-		core/deps/picotcp/include/pico_addressing.h
-		core/deps/picotcp/include/pico_config.h
-		core/deps/picotcp/include/pico_constants.h
-		core/deps/picotcp/include/pico_defines.h
-		core/deps/picotcp/include/pico_defines_msvc.h
-		core/deps/picotcp/include/pico_device.h
-		core/deps/picotcp/include/pico_eth.h
-		core/deps/picotcp/include/pico_frame.h
-		core/deps/picotcp/include/pico_md5.h
-		core/deps/picotcp/include/pico_module_eth.h
-		core/deps/picotcp/include/pico_protocol.h
-		core/deps/picotcp/include/pico_queue.h
-		core/deps/picotcp/include/pico_socket.h
-		core/deps/picotcp/include/pico_socket_multicast.h
-		core/deps/picotcp/include/pico_stack.h
-		core/deps/picotcp/include/pico_tree.h
-		core/deps/picotcp/modules/pico_arp.c
-		core/deps/picotcp/modules/pico_dev_ppp.c
-		core/deps/picotcp/modules/pico_dhcp_common.c
-		core/deps/picotcp/modules/pico_dhcp_common.h
-		core/deps/picotcp/modules/pico_dhcp_server.c
-		core/deps/picotcp/modules/pico_dhcp_server.h
-		core/deps/picotcp/modules/pico_dns_client.c
-		core/deps/picotcp/modules/pico_dns_common.c
-		core/deps/picotcp/modules/pico_ethernet.c
-		core/deps/picotcp/modules/pico_fragments.c
-		core/deps/picotcp/modules/pico_icmp4.c
-		core/deps/picotcp/modules/pico_ipv4.c
-		core/deps/picotcp/modules/pico_socket_tcp.c
-		core/deps/picotcp/modules/pico_socket_udp.c
-		core/deps/picotcp/modules/pico_strings.c
-		core/deps/picotcp/modules/pico_tcp.c
-		core/deps/picotcp/modules/pico_udp.c
-		core/deps/picotcp/stack/pico_device.c
-		core/deps/picotcp/stack/pico_frame.c
-		core/deps/picotcp/stack/pico_md5.c
-		core/deps/picotcp/stack/pico_protocol.c
-		core/deps/picotcp/stack/pico_socket.c
-		core/deps/picotcp/stack/pico_socket_multicast.c
-		core/deps/picotcp/stack/pico_stack.c
-		core/deps/picotcp/stack/pico_tree.c)
-
-target_compile_definitions(${PROJECT_NAME} PRIVATE _7ZIP_ST)
-target_sources(${PROJECT_NAME} PRIVATE core/deps/lzma/7zArcIn.c core/deps/lzma/7zBuf.c core/deps/lzma/7zCrc.c core/deps/lzma/7zCrcOpt.c core/deps/lzma/7zDec.c core/deps/lzma/7zFile.c core/deps/lzma/7zStream.c core/deps/lzma/Alloc.c core/deps/lzma/Bcj2.c core/deps/lzma/Bra86.c core/deps/lzma/Bra.c core/deps/lzma/BraIA64.c core/deps/lzma/CpuArch.c core/deps/lzma/Delta.c core/deps/lzma/LzFind.c core/deps/lzma/Lzma2Dec.c core/deps/lzma/Lzma86Dec.c core/deps/lzma/Lzma86Enc.c core/deps/lzma/LzmaDec.c core/deps/lzma/LzmaEnc.c core/deps/lzma/LzmaLib.c core/deps/lzma/Sort.c)
-add_subdirectory(core/deps/libelf)
-target_link_libraries(${PROJECT_NAME} PRIVATE elf)
-if(NOT LIBRETRO)
-	target_compile_definitions(${PROJECT_NAME} PRIVATE
-		IMGUI_DISABLE_DEMO_WINDOWS
-		IMGUI_DISABLE_DEBUG_TOOLS
-		IMGUI_DEFINE_MATH_OPERATORS)
-	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/imgui core/deps/imgui/backends)
-	target_sources(${PROJECT_NAME} PRIVATE
-		core/deps/imgui/imgui.cpp
-		core/deps/imgui/imgui_demo.cpp
-		core/deps/imgui/imgui_draw.cpp
-		core/deps/imgui/imgui_cjk.cpp
-		core/deps/imgui/imgui_stdlib.cpp
-		core/deps/imgui/imgui_tables.cpp
-		core/deps/imgui/imgui_widgets.cpp)
-
-	if(ENABLE_FC_PROFILER)
-		target_include_directories(${PROJECT_NAME} PRIVATE core/deps/implot)
-		target_sources(${PROJECT_NAME} PRIVATE
-			core/deps/implot/implot.h
-			core/deps/implot/implot.cpp
-			core/deps/implot/implot_internal.h
-			core/deps/implot/implot_items.cpp)
-	endif()
-endif()
-target_sources(${PROJECT_NAME} PRIVATE core/deps/xbrz/xbrz.cpp)
-target_sources(${PROJECT_NAME} PRIVATE core/deps/md5/md5.cpp)
-
-if(USE_DISCORD AND NOT LIBRETRO)
-	option(BUILD_EXAMPLES "Build example apps" OFF)
-	add_subdirectory(core/deps/discord-rpc EXCLUDE_FROM_ALL)
-	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/discord-rpc/include)
-	target_link_libraries(${PROJECT_NAME} PRIVATE discord-rpc)
-	target_compile_definitions(${PROJECT_NAME} PRIVATE USE_DISCORD)
-endif()
-
-target_link_libraries(${PROJECT_NAME} PRIVATE flycast::res)
-
-if(LIBRETRO)
-	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/libretro-common/include)
-	target_sources(${PROJECT_NAME} PRIVATE
-		core/deps/libretro-common/memmap/memalign.c
-		core/deps/libretro-common/file/file_path.c
-		core/deps/libretro-common/vfs/vfs_implementation.c
-		core/deps/libretro-common/encodings/encoding_utf.c
-		core/deps/libretro-common/compat/compat_strl.c
-		core/deps/libretro-common/compat/fopen_utf8.c
-		core/deps/libretro-common/compat/compat_strcasestr.c
-		core/deps/libretro-common/file/retro_dirent.c
-		core/deps/libretro-common/string/stdstring.c)
-	if(USE_OPENGL)
-		target_sources(${PROJECT_NAME} PRIVATE
-			core/deps/libretro-common/glsm/glsm.c
-			core/deps/libretro-common/glsym/rglgen.c)
-		if(ANDROID OR IOS OR USE_GLES)
-			target_sources(${PROJECT_NAME} PRIVATE core/deps/libretro-common/glsym/glsym_es3.c)
-		elseif(USE_GLES2)
-			target_sources(${PROJECT_NAME} PRIVATE core/deps/libretro-common/glsym/glsym_es2.c)
-		else()
-			target_sources(${PROJECT_NAME} PRIVATE core/deps/libretro-common/glsym/glsym_gl.c)
-		endif()
-	endif()
-	target_sources(${PROJECT_NAME} PRIVATE
-		shell/libretro/audiostream.cpp
-		shell/libretro/keyboard_map.h
-		shell/libretro/libretro_core_option_defines.h
-		shell/libretro/libretro_core_options_intl.h
-		shell/libretro/libretro_core_options.h
-		shell/libretro/libretro.cpp
-		shell/libretro/LogManager.cpp
-		shell/libretro/LogManager.h
-		shell/libretro/option.cpp
-		shell/libretro/oslib.cpp
-		shell/libretro/vmu_xhair.cpp)
-	if(APPLE)
-		target_sources(${PROJECT_NAME} PRIVATE shell/libretro/oslib_apple.mm)
-	endif()
-	if(WIN32)
-		target_link_libraries(${PROJECT_NAME} PRIVATE mswsock)
-	endif()
-endif()
-
-add_subdirectory(core/archive)
-add_subdirectory(core/cfg)
-add_subdirectory(core/hw)
-add_subdirectory(core/imgread)
-add_subdirectory(core/input)
-add_subdirectory(core/log)
-add_subdirectory(core/network)
-add_subdirectory(core/oslib)
-add_subdirectory(core/audio)
-add_subdirectory(core/reios)
-add_subdirectory(core/achievements)
-add_subdirectory(core/ui)
-add_subdirectory(core/lua)
-add_subdirectory(core/profiler)
-add_subdirectory(core/wsi)
-
-include(resources/resources.cmake)
-
-if(WIN32)
-	target_sources(${PROJECT_NAME} PRIVATE
-			core/windows/comptr.h
-			core/windows/fault_handler.cpp
-			core/windows/unwind_info.cpp
-			core/windows/win_vmem.cpp)
-else()
-	target_sources(${PROJECT_NAME} PRIVATE
-			core/linux/common.cpp
-			core/linux/context.cpp
-			core/linux/posix_vmem.cpp
-			core/linux/unwind_info.cpp)
-	if(NINTENDO_SWITCH)
-		add_subdirectory(shell/switch)
-	endif()
-endif()
-
-if(NOT LIBRETRO)
-	target_sources(${PROJECT_NAME} PRIVATE
-			core/linux-dist/evdev.cpp
-			core/linux-dist/evdev.h
-			core/linux-dist/icon.h
-			core/linux-dist/x11.cpp
-			core/linux-dist/x11.h
-			core/linux-dist/x11_keyboard.h)
-endif()
-
-if(NOT LIBRETRO)
-	target_sources(${PROJECT_NAME} PRIVATE
-			core/deps/rcheevos/src/rc_client_raintegration.c
-			core/deps/rcheevos/src/rc_client.c
-			core/deps/rcheevos/src/rc_compat.c
-			core/deps/rcheevos/src/rc_util.c
-			core/deps/rcheevos/src/rc_version.c
-			core/deps/rcheevos/src/rapi/rc_api_common.c
-			core/deps/rcheevos/src/rapi/rc_api_editor.c
-			core/deps/rcheevos/src/rapi/rc_api_info.c
-			core/deps/rcheevos/src/rapi/rc_api_runtime.c
-			core/deps/rcheevos/src/rapi/rc_api_user.c
-			core/deps/rcheevos/src/rcheevos/alloc.c
-			core/deps/rcheevos/src/rcheevos/condition.c
-			core/deps/rcheevos/src/rcheevos/condset.c
-			core/deps/rcheevos/src/rcheevos/consoleinfo.c
-			core/deps/rcheevos/src/rcheevos/format.c
-			core/deps/rcheevos/src/rcheevos/lboard.c
-			core/deps/rcheevos/src/rcheevos/memref.c
-			core/deps/rcheevos/src/rcheevos/operand.c
-			core/deps/rcheevos/src/rcheevos/rc_validate.c
-			core/deps/rcheevos/src/rcheevos/richpresence.c
-			core/deps/rcheevos/src/rcheevos/runtime_progress.c
-			core/deps/rcheevos/src/rcheevos/runtime.c
-			core/deps/rcheevos/src/rcheevos/trigger.c
-			core/deps/rcheevos/src/rcheevos/value.c
-			core/deps/rcheevos/src/rhash/aes.c
-			core/deps/rcheevos/src/rhash/cdreader.c
-			core/deps/rcheevos/src/rhash/hash.c
-			core/deps/rcheevos/src/rhash/md5.c
-			core/deps/rcheevos/src/rurl/url.c)
-	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/rcheevos/include)
-	target_compile_definitions(${PROJECT_NAME} PRIVATE USE_RACHIEVEMENTS RC_DISABLE_LUA)
-endif()
-
-if(USE_OPENGL)
-	target_compile_definitions(${PROJECT_NAME} PRIVATE USE_OPENGL)
-
-	target_sources(${PROJECT_NAME} PRIVATE
-			core/rend/gles/glcache.h
-			core/rend/gles/gldraw.cpp
-			core/rend/gles/gles.cpp
-			core/rend/gles/gles.h
-			core/rend/gles/gltex.cpp
-			core/rend/gles/quad.cpp
-			core/rend/gles/postprocess.cpp
-			core/rend/gles/postprocess.h
-			core/rend/gles/naomi2.cpp
-			core/rend/gles/naomi2.h)
-
-	if(NOT LIBRETRO)
-		target_sources(${PROJECT_NAME} PRIVATE
-				core/deps/imgui/backends/imgui_impl_opengl3.cpp
-				core/deps/imgui/backends/imgui_impl_opengl3.h
-				core/rend/gles/opengl_driver.cpp
-				core/rend/gles/opengl_driver.h)
-	endif()
-
-	if(NOT (APPLE OR USE_GLES2))
-		target_sources(${PROJECT_NAME} PRIVATE
-				core/rend/gl4/abuffer.cpp
-				core/rend/gl4/gl4.h
-				core/rend/gl4/gldraw.cpp
-				core/rend/gl4/gles.cpp
-				core/rend/gl4/gl4naomi2.cpp
-				core/rend/gl4/gl4naomi2.h)
-	endif()
-endif()
-
-target_sources(${PROJECT_NAME} PRIVATE
-		core/build.h
-		core/cheats.cpp
-		core/cheats.h
-		core/emulator.h
-		core/nullDC.cpp
-		core/serialize.cpp
-		core/serialize.h
-		core/stdclass.cpp
-		core/stdclass.h
-		core/types.h
-		core/debug/gdb_server.h)
-
-target_sources(${PROJECT_NAME} PRIVATE
-		core/rend/CustomTexture.cpp
-		core/rend/CustomTexture.h
-		core/rend/osd.cpp
-		core/rend/osd.h
-		core/rend/sorter.cpp
-		core/rend/sorter.h
-		core/rend/tileclip.h
-		core/rend/TexCache.cpp
-		core/rend/TexCache.h
-		core/rend/texconv.cpp
-		core/rend/texconv.h
-		core/rend/norend/norend.cpp)
-
-if(USE_VULKAN)
-	target_compile_definitions(${PROJECT_NAME} PUBLIC VK_ENABLE_BETA_EXTENSIONS VK_NO_PROTOTYPES)
-	if(ANDROID)
-		target_compile_definitions(${PROJECT_NAME} PUBLIC VK_USE_PLATFORM_ANDROID_KHR)
-	elseif(X11_FOUND)
-		target_compile_definitions(${PROJECT_NAME} PUBLIC VK_USE_PLATFORM_XLIB_KHR)
-	elseif(WIN32)
-		target_compile_definitions(${PROJECT_NAME} PUBLIC VK_USE_PLATFORM_WIN32_KHR)
-	elseif(APPLE)
-		target_compile_definitions(${PROJECT_NAME} PUBLIC VK_USE_PLATFORM_METAL_EXT)
-	endif()
-
-	add_subdirectory(core/deps/Vulkan-Headers)
-	target_link_libraries(${PROJECT_NAME} PRIVATE Vulkan::Headers)
-
-	add_subdirectory(core/deps/VulkanMemoryAllocator)
-	target_compile_options(VulkanMemoryAllocator INTERFACE $<$<AND:$<COMPILE_LANGUAGE:CXX>,$<CXX_COMPILER_ID:AppleClang,Clang>>:-Wno-nullability-completeness>)
-	target_link_libraries(${PROJECT_NAME} PRIVATE GPUOpen::VulkanMemoryAllocator)
-
-	if(ANDROID AND NOT LIBRETRO AND "arm64" IN_LIST ARCHITECTURE)
-		add_subdirectory(core/deps/libadrenotools)
-		target_link_libraries(${PROJECT_NAME} PRIVATE adrenotools)
-	endif()
-
-	target_compile_definitions(${PROJECT_NAME} PRIVATE USE_VULKAN HAVE_VULKAN)
-	target_sources(${PROJECT_NAME} PRIVATE
-			core/rend/vulkan/oit/oit_buffer.h
-			core/rend/vulkan/oit/oit_drawer.cpp
-			core/rend/vulkan/oit/oit_drawer.h
-			core/rend/vulkan/oit/oit_pipeline.cpp
-			core/rend/vulkan/oit/oit_pipeline.h
-			core/rend/vulkan/oit/oit_renderer.cpp
-			core/rend/vulkan/oit/oit_renderpass.cpp
-			core/rend/vulkan/oit/oit_renderpass.h
-			core/rend/vulkan/oit/oit_shaders.cpp
-			core/rend/vulkan/oit/oit_shaders.h
-			core/rend/vulkan/adreno.cpp
-			core/rend/vulkan/buffer.cpp
-			core/rend/vulkan/buffer.h
-			core/rend/vulkan/commandpool.cpp
-			core/rend/vulkan/commandpool.h
-			core/rend/vulkan/compiler.cpp
-			core/rend/vulkan/compiler.h
-			core/rend/vulkan/drawer.cpp
-			core/rend/vulkan/drawer.h
-			core/rend/vulkan/pipeline.cpp
-			core/rend/vulkan/pipeline.h
-			core/rend/vulkan/quad.cpp
-			core/rend/vulkan/quad.h
-			core/rend/vulkan/shaders.cpp
-			core/rend/vulkan/shaders.h
-			core/rend/vulkan/texture.cpp
-			core/rend/vulkan/texture.h
-			core/rend/vulkan/utils.h
-			core/rend/vulkan/vmallocator.cpp
-			core/rend/vulkan/vmallocator.h
-			core/rend/vulkan/overlay.cpp
-			core/rend/vulkan/overlay.h
-			core/rend/vulkan/vulkan_context.h
-			core/rend/vulkan/vulkan.h
-			core/rend/vulkan/vulkan_renderer.cpp)
-	if(LIBRETRO)
-		target_sources(${PROJECT_NAME} PRIVATE
-				core/rend/vulkan/vk_context_lr.cpp
-				core/rend/vulkan/vk_context_lr.h)
-	else()
-		target_compile_definitions(${PROJECT_NAME} PUBLIC IMGUI_IMPL_VULKAN_NO_PROTOTYPES)
-		target_sources(${PROJECT_NAME} PRIVATE
-				core/rend/vulkan/vulkan_driver.h
-				core/rend/vulkan/vulkan_context.cpp
-				core/deps/imgui/backends/imgui_impl_vulkan.cpp
-				core/deps/imgui/backends/imgui_impl_vulkan.h)
-		if(CMAKE_SIZEOF_VOID_P EQUAL 4)
-			target_compile_definitions(${PROJECT_NAME} PRIVATE ImTextureID=ImU64)
-		endif()
-	endif()
-endif()
-
-if(WIN32 AND USE_DX9 AND NOT LIBRETRO AND NOT WINDOWS_STORE AND ("x86" IN_LIST ARCHITECTURE OR "x86_64" IN_LIST ARCHITECTURE))
-	set(REND_DX9_FILES
-		core/rend/dx9/d3d_overlay.h
-		core/rend/dx9/d3d_overlay.cpp
-		core/rend/dx9/d3d_renderer.h
-		core/rend/dx9/d3d_renderer.cpp
-		core/rend/dx9/d3d_shaders.h
-		core/rend/dx9/d3d_shaders.cpp
-		core/rend/dx9/d3d_texture.h
-		core/rend/dx9/d3d_texture.cpp
-		core/rend/dx9/dx9_driver.h
-		core/rend/dx9/dxcontext.cpp
-		core/rend/dx9/dxcontext.h
-		core/deps/imgui/backends/imgui_impl_dx9.h
-		core/deps/imgui/backends/imgui_impl_dx9.cpp)
-	target_sources(${PROJECT_NAME} PRIVATE ${REND_DX9_FILES})
-
-	if(NOT MINGW)
-		set_source_files_properties(${REND_DX9_FILES} PROPERTIES INCLUDE_DIRECTORIES "$ENV{DXSDK_DIR}/Include")
-	endif()
-	target_compile_definitions(${PROJECT_NAME} PRIVATE USE_DX9)
-endif()
-
-if(WIN32 AND USE_DX11)
-	if(NOT LIBRETRO)
-		target_sources(${PROJECT_NAME} PRIVATE
-			core/deps/imgui/backends/imgui_impl_dx11.cpp
-			core/deps/imgui/backends/imgui_impl_dx11.h)
-	endif()
-	target_sources(${PROJECT_NAME} PRIVATE
-		core/rend/dx11/dx11_driver.h
-		core/rend/dx11/dx11_overlay.cpp
-		core/rend/dx11/dx11_overlay.h
-		core/rend/dx11/dx11_renderer.cpp
-		core/rend/dx11/dx11_renderer.h
-		core/rend/dx11/dx11_renderstate.h
-		core/rend/dx11/dx11_renderstate.cpp
-		core/rend/dx11/dx11_shaders.cpp
-		core/rend/dx11/dx11_shaders.h
-		core/rend/dx11/dx11_texture.cpp
-		core/rend/dx11/dx11_texture.h
-		core/rend/dx11/dx11context.cpp
-		core/rend/dx11/dx11context.h
-		core/rend/dx11/dx11context_lr.cpp
-		core/rend/dx11/dx11context_lr.h
-		core/rend/dx11/dx11_driver.h
-		core/rend/dx11/dx11_naomi2.cpp
-		core/rend/dx11/dx11_naomi2.h
-		core/rend/dx11/oit/dx11_oitbuffers.h
-		core/rend/dx11/oit/dx11_oitrenderer.cpp
-		core/rend/dx11/oit/dx11_oitshaders.cpp
-		core/rend/dx11/oit/dx11_oitshaders.h)
-
-	target_compile_definitions(${PROJECT_NAME} PRIVATE HAVE_D3D11)
-	target_link_libraries(${PROJECT_NAME} PRIVATE d3d11 d3dcompiler dxgi)
-endif()
-
-if(ENABLE_GDB_SERVER)
-
-	target_sources(${PROJECT_NAME} PRIVATE
-		core/debug/gdb_server.cpp)
-
-	target_compile_definitions(${PROJECT_NAME} PRIVATE GDB_SERVER)
-endif()
-
-if("arm" IN_LIST ARCHITECTURE AND NOT APPLE)
-	if(MSVC)
-		target_compile_options(${PROJECT_NAME} PRIVATE "/Zc:__cplusplus")
-	endif()
-	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/vixl)
-	target_sources(${PROJECT_NAME} PRIVATE
-		core/rec-ARM/rec_arm.cpp
-		core/deps/vixl/aarch32/location-aarch32.cc
-		core/deps/vixl/aarch32/location-aarch32.h
-		core/deps/vixl/aarch32/assembler-aarch32.cc
-		core/deps/vixl/aarch32/assembler-aarch32.h
-		core/deps/vixl/aarch32/instructions-aarch32.cc
-		core/deps/vixl/aarch32/instructions-aarch32.h
-		core/deps/vixl/aarch32/constants-aarch32.cc
-		core/deps/vixl/aarch32/constants-aarch32.h
-		core/deps/vixl/aarch32/macro-assembler-aarch32.cc
-		core/deps/vixl/aarch32/macro-assembler-aarch32.h
-		core/deps/vixl/aarch32/operands-aarch32.cc
-		core/deps/vixl/aarch32/operands-aarch32.h
-		core/deps/vixl/assembler-base-vixl.h
-		core/deps/vixl/code-buffer-vixl.cc
-		core/deps/vixl/code-buffer-vixl.h
-		core/deps/vixl/code-generation-scopes-vixl.h
-		core/deps/vixl/compiler-intrinsics-vixl.cc
-		core/deps/vixl/compiler-intrinsics-vixl.h
-		core/deps/vixl/cpu-features.cc
-		core/deps/vixl/cpu-features.h
-		core/deps/vixl/globals-vixl.h
-		core/deps/vixl/invalset-vixl.h
-		core/deps/vixl/macro-assembler-interface.h
-		core/deps/vixl/platform-vixl.h
-		core/deps/vixl/pool-manager.h
-		core/deps/vixl/pool-manager-impl.h
-		core/deps/vixl/utils-vixl.cc
-		core/deps/vixl/utils-vixl.h)
-endif()
-if("arm64" IN_LIST ARCHITECTURE)
-	if(MSVC)
-		target_compile_options(${PROJECT_NAME} PRIVATE "/Zc:__cplusplus")
-	endif()
-	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/vixl)
-	target_sources(${PROJECT_NAME} PRIVATE
-		core/deps/vixl/aarch64/abi-aarch64.h
-		core/deps/vixl/aarch64/assembler-aarch64.cc
-		core/deps/vixl/aarch64/assembler-aarch64.h
-		core/deps/vixl/aarch64/assembler-sve-aarch64.cc
-		core/deps/vixl/aarch64/constants-aarch64.h
-		core/deps/vixl/aarch64/instructions-aarch64.cc
-		core/deps/vixl/aarch64/instructions-aarch64.h
-		core/deps/vixl/aarch64/macro-assembler-aarch64.cc
-		core/deps/vixl/aarch64/macro-assembler-aarch64.h
-		core/deps/vixl/aarch64/macro-assembler-sve-aarch64.cc
-		core/deps/vixl/aarch64/operands-aarch64.cc
-		core/deps/vixl/aarch64/operands-aarch64.h
-		core/deps/vixl/aarch64/registers-aarch64.cc
-		core/deps/vixl/aarch64/registers-aarch64.h
-		core/deps/vixl/aarch64/pointer-auth-aarch64.cc
-		core/deps/vixl/aarch64/simulator-constants-aarch64.h
-		core/deps/vixl/assembler-base-vixl.h
-		core/deps/vixl/code-buffer-vixl.cc
-		core/deps/vixl/code-buffer-vixl.h
-		core/deps/vixl/code-generation-scopes-vixl.h
-		core/deps/vixl/compiler-intrinsics-vixl.cc
-		core/deps/vixl/compiler-intrinsics-vixl.h
-		core/deps/vixl/cpu-features.cc
-		core/deps/vixl/cpu-features.h
-		core/deps/vixl/globals-vixl.h
-		core/deps/vixl/invalset-vixl.h
-		core/deps/vixl/macro-assembler-interface.h
-		core/deps/vixl/platform-vixl.h
-		core/deps/vixl/pool-manager.h
-		core/deps/vixl/pool-manager-impl.h
-		core/deps/vixl/utils-vixl.cc
-		core/deps/vixl/utils-vixl.h)
-	target_sources(${PROJECT_NAME} PRIVATE core/rec-ARM64/rec_arm64.cpp core/rec-ARM64/arm64_regalloc.h)
-endif()
-if("x86" IN_LIST ARCHITECTURE OR "x86_64" IN_LIST ARCHITECTURE)
-	add_subdirectory(core/deps/xbyak EXCLUDE_FROM_ALL)
-	target_link_libraries(${PROJECT_NAME} PRIVATE xbyak::xbyak)
-	if(CMAKE_SIZEOF_VOID_P EQUAL 4)
-		target_sources(${PROJECT_NAME} PRIVATE
-			core/rec-x64/xbyak_base.h
-			core/rec-x86/rec_x86.h
-			core/rec-x86/x86_regalloc.h
-			core/rec-x86/rec_x86.cpp
-			core/rec-x86/x86_ops.cpp)
-	elseif(CMAKE_SIZEOF_VOID_P EQUAL 8)
-		target_sources(${PROJECT_NAME} PRIVATE
-			core/rec-x64/xbyak_base.h
-			core/rec-x64/rec_x64.cpp
-			core/rec-x64/x64_regalloc.h)
-	endif()
-endif()
-
-if((USE_OPENGL OR USE_GLES2 OR USE_GLES) AND NOT LIBRETRO)
-	add_library(glad STATIC core/deps/glad/src/gl.c)
-	if(NOT APPLE AND NOT WIN32 AND NOT SDL2_FOUND)
-		# When SDL2 is not found, we can use EGL with ANativeWindow (Android) or X11
-		target_sources(glad PRIVATE core/deps/glad/src/egl.c)
-	endif()
-	target_include_directories(glad PUBLIC core/deps/glad/include)
-	target_link_libraries(${PROJECT_NAME} PRIVATE glad)
-endif()
-
-if(NOT LIBRETRO)
-	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/ggpo/include core/deps/ggpo/lib/ggpo)
-	target_sources(${PROJECT_NAME} PRIVATE
-		core/deps/ggpo/lib/ggpo/bitvector.cpp
-		core/deps/ggpo/lib/ggpo/bitvector.h
-		core/deps/ggpo/lib/ggpo/game_input.cpp
-		core/deps/ggpo/lib/ggpo/game_input.h
-		core/deps/ggpo/lib/ggpo/input_queue.cpp
-		core/deps/ggpo/lib/ggpo/input_queue.h
-		core/deps/ggpo/lib/ggpo/main.cpp
-		core/deps/ggpo/lib/ggpo/platform_linux.cpp
-		core/deps/ggpo/lib/ggpo/platform_linux.h
-		core/deps/ggpo/lib/ggpo/platform_windows.cpp
-		core/deps/ggpo/lib/ggpo/platform_windows.h
-		core/deps/ggpo/lib/ggpo/poll.cpp
-		core/deps/ggpo/lib/ggpo/ggpo_poll.h
-		core/deps/ggpo/lib/ggpo/ring_buffer.h
-		core/deps/ggpo/lib/ggpo/static_buffer.h
-		core/deps/ggpo/lib/ggpo/sync.cpp
-		core/deps/ggpo/lib/ggpo/sync.h
-		core/deps/ggpo/lib/ggpo/timesync.cpp
-		core/deps/ggpo/lib/ggpo/timesync.h
-		core/deps/ggpo/lib/ggpo/ggpo_types.h
-
-		core/deps/ggpo/lib/ggpo/backends/backend.h
-		core/deps/ggpo/lib/ggpo/backends/p2p.cpp
-		core/deps/ggpo/lib/ggpo/backends/p2p.h
-		core/deps/ggpo/lib/ggpo/backends/spectator.cpp
-		core/deps/ggpo/lib/ggpo/backends/spectator.h
-		core/deps/ggpo/lib/ggpo/backends/synctest.cpp
-		core/deps/ggpo/lib/ggpo/backends/synctest.h
-
-		core/deps/ggpo/lib/ggpo/network/udp_msg.h
-		core/deps/ggpo/lib/ggpo/network/udp_proto.cpp
-		core/deps/ggpo/lib/ggpo/network/udp_proto.h
-		core/deps/ggpo/lib/ggpo/network/udp.cpp
-		core/deps/ggpo/lib/ggpo/network/udp.h)
-
-	if(ANDROID)
-		target_compile_definitions(${PROJECT_NAME} PRIVATE GLES GLES3)
-		add_subdirectory(shell/android-studio/flycast/src/main/jni/src)
-		target_link_libraries(${PROJECT_NAME} PRIVATE android log)
-
-	elseif(APPLE)
-		string(TIMESTAMP YEAR "%Y")
-		string(REGEX MATCH "^[^-]+" TAG_VERSION ${GIT_VERSION})
-		if(IOS)
-			set_property(TARGET ${PROJECT_NAME} PROPERTY XCODE_ATTRIBUTE_SWIFT_VERSION "5.0")
-			add_subdirectory(shell/apple/emulator-ios/AltKit)
-			target_link_libraries(${PROJECT_NAME} PRIVATE AltKit)
-
-			target_sources(${PROJECT_NAME} PRIVATE
-					shell/apple/common/http_client.mm
-					shell/apple/common/util.mm
-					shell/apple/emulator-ios/emulator/AppDelegate.h
-					shell/apple/emulator-ios/emulator/AppDelegate.mm
-					shell/apple/emulator-ios/emulator/ios_main.mm
-					shell/apple/emulator-ios/emulator/ios_gamepad.h
-					shell/apple/emulator-ios/emulator/ios_keyboard.h
-					shell/apple/emulator-ios/emulator/ios_mouse.h
-					shell/apple/emulator-ios/emulator/FlycastViewController.h
-					shell/apple/emulator-ios/emulator/FlycastViewController.mm
-					shell/apple/emulator-ios/emulator/PadViewController.h
-					shell/apple/emulator-ios/emulator/PadViewController.mm
-					shell/apple/emulator-ios/emulator/EditPadViewController.h
-					shell/apple/emulator-ios/emulator/EditPadViewController.mm
-					shell/apple/emulator-ios/emulator/EmulatorView.h
-					shell/apple/emulator-ios/emulator/EmulatorView.mm
-					shell/apple/emulator-ios/emulator/main.m
-					shell/apple/emulator-ios/emulator/iCade-iOS/iCadeReaderView.h
-					shell/apple/emulator-ios/emulator/iCade-iOS/iCadeReaderView.m
-					shell/apple/emulator-ios/emulator/iCade-iOS/iCadeState.h)
-			target_compile_options(${PROJECT_NAME} PRIVATE $<$<COMPILE_LANGUAGE:CXX>:-fobjc-arc -fmodules>)
-			set_source_files_properties(shell/apple/emulator-ios/emulator/FlycastViewController.mm PROPERTIES COMPILE_OPTIONS -fcxx-modules)
-			set_source_files_properties(shell/apple/emulator-ios/emulator/iCade-iOS/iCadeReaderView.m PROPERTIES COMPILE_OPTIONS -fno-objc-arc)
-
-			set(IOS_RESOURCES
-				shell/apple/emulator-ios/emulator/Images.xcassets
-				shell/apple/emulator-ios/emulator/FlycastStoryboard.storyboard
-				shell/apple/emulator-ios/emulator/LaunchScreen.storyboard
-				shell/apple/emulator-ios/emulator/PadViewController.xib
-				shell/apple/emulator-ios/emulator/EditPadViewController.xib)
-			target_sources(${PROJECT_NAME} PRIVATE ${IOS_RESOURCES})
-			source_group("Resources" FILES ${IOS_RESOURCES})
-			set_source_files_properties(${IOS_RESOURCES} PROPERTIES MACOSX_PACKAGE_LOCATION "Resources")
-
-			set_target_properties(${PROJECT_NAME} PROPERTIES
-				OUTPUT_NAME "Flycast"
-				MACOSX_BUNDLE YES
-				MACOSX_BUNDLE_EXECUTABLE_NAME "Flycast"
-				MACOSX_BUNDLE_INFO_STRING ""
-				MACOSX_BUNDLE_GUI_IDENTIFIER "com.flyinghead.Flycast"
-				MACOSX_BUNDLE_BUNDLE_NAME "com.flyinghead.Flycast"
-				MACOSX_BUNDLE_LONG_VERSION_STRING "${GIT_VERSION}"
-				MACOSX_BUNDLE_SHORT_VERSION_STRING "${TAG_VERSION}"
-				MACOSX_BUNDLE_BUNDLE_VERSION "${GIT_HASH}"
-				MACOSX_BUNDLE_COPYRIGHT "Copyright  ${YEAR} Flycast contributors. All rights reserved."
-				MACOSX_BUNDLE_INFO_PLIST ${CMAKE_CURRENT_SOURCE_DIR}/shell/apple/emulator-ios/plist.in
-
-				XCODE_ATTRIBUTE_DEBUG_INFORMATION_FORMAT "dwarf-with-dsym"
-				XCODE_ATTRIBUTE_GCC_PREFIX_HEADER "${CMAKE_CURRENT_SOURCE_DIR}/shell/apple/emulator-ios/emulator/flycast-ios-Prefix.pch"
-				XCODE_ATTRIBUTE_GCC_PRECOMPILE_PREFIX_HEADER "YES"
-				XCODE_ATTRIBUTE_CODE_SIGNING_ALLOWED "NO"
-				XCODE_ATTRIBUTE_CODE_SIGN_IDENTITY ""
-				XCODE_ATTRIBUTE_TARGETED_DEVICE_FAMILY "1,2"
-				XCODE_ATTRIBUTE_CLANG_ENABLE_OBJC_ARC YES
-				XCODE_ATTRIBUTE_COMBINE_HIDPI_IMAGES NO
-				XCODE_ATTRIBUTE_ASSETCATALOG_COMPILER_APPICON_NAME "AppIcon"
-				XCODE_ATTRIBUTE_PRODUCT_BUNDLE_IDENTIFIER "com.flyinghead.Flycast")
-
-			find_library(UIKIT UIKit)
-			find_library(FOUNDATION Foundation)
-			find_library(GLKIT GLKit)
-			find_library(GAMECONTROLLER GameController)
-			find_library(AUDIOTOOLBOX AudioToolbox)
-			find_library(AVFOUNDATION AVFoundation)
-			target_link_libraries(${PROJECT_NAME} PRIVATE
-				${UIKIT}
-				${FOUNDATION}
-				${GLKIT}
-				${GAMECONTROLLER}
-				${AUDIOTOOLBOX}
-				${AVFOUNDATION})
-
-			add_custom_target(Flycast.IPA ALL
-				DEPENDS ${PROJECT_NAME}
-				COMMENT "Building IPA"
-				COMMAND mkdir -p ${CMAKE_CURRENT_BINARY_DIR}/Payload
-				COMMAND rm -rf ${CMAKE_CURRENT_BINARY_DIR}/Payload/*
-				COMMAND cp -r ${CMAKE_CURRENT_BINARY_DIR}/$<CONFIG>-${CMAKE_OSX_SYSROOT}/Flycast.app ${CMAKE_CURRENT_BINARY_DIR}/Payload
-				COMMAND for lib in ${CMAKE_CURRENT_BINARY_DIR}/Payload/Flycast.app/Frameworks/*.dylib
-				COMMAND do xcrun bitcode_strip -r $lib -o $lib
-				COMMAND done
-				COMMAND ldid -S${CMAKE_CURRENT_SOURCE_DIR}/shell/apple/emulator-ios/emulator/flycast.entitlements ${CMAKE_CURRENT_BINARY_DIR}/Payload/Flycast.app/Flycast
-				COMMAND ${CMAKE_COMMAND} -E tar "cfv" "${CMAKE_CURRENT_BINARY_DIR}/$<CONFIG>-${CMAKE_OSX_SYSROOT}/Flycast.ipa" --format=zip ${CMAKE_CURRENT_BINARY_DIR}/Payload)
-		else()
-
-			add_subdirectory(core/deps/Syphon)
-			target_link_libraries(${PROJECT_NAME} PRIVATE Syphon)
-			add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
-				COMMAND ${CMAKE_COMMAND} -E copy ${SYPHON_METALLIB}
-				$<TARGET_FILE_DIR:flycast>/../Resources/)
-			target_compile_definitions(${PROJECT_NAME} PRIVATE VIDEO_ROUTING)
-
-			target_sources(${PROJECT_NAME} PRIVATE
-					shell/apple/common/http_client.mm
-					shell/apple/common/util.mm
-					shell/apple/emulator-osx/emulator-osx/SDLApplicationDelegate.h
-					shell/apple/emulator-osx/emulator-osx/SDLApplicationDelegate.mm
-					shell/apple/emulator-osx/emulator-osx/osx-main.mm)
-			set(ASSETS shell/apple/emulator-osx/emulator-osx/Images.xcassets)
-			target_sources(${PROJECT_NAME} PRIVATE ${ASSETS})
-			source_group("Resources" FILES ${ASSETS})
-			set_source_files_properties(${ASSETS} PROPERTIES MACOSX_PACKAGE_LOCATION "Resources")
-
-			set_target_properties(${PROJECT_NAME} PROPERTIES
-				OUTPUT_NAME "Flycast"
-				MACOSX_BUNDLE_INFO_PLIST ${CMAKE_CURRENT_SOURCE_DIR}/shell/apple/emulator-osx/MacOSXBundleInfo.plist.in
-				MACOSX_BUNDLE_EXECUTABLE_NAME "Flycast"
-				MACOSX_BUNDLE_INFO_STRING ""
-				MACOSX_BUNDLE_ICON_FILE "AppIcon"
-				MACOSX_BUNDLE_GUI_IDENTIFIER "com.flyinghead.Flycast"
-				MACOSX_BUNDLE_LONG_VERSION_STRING "${GIT_VERSION}"
-				MACOSX_BUNDLE_SHORT_VERSION_STRING "${TAG_VERSION}"
-				MACOSX_BUNDLE_BUNDLE_VERSION "${GIT_HASH}"
-				MACOSX_BUNDLE_BUNDLE_NAME "Flycast"
-				MACOSX_BUNDLE_COPYRIGHT "Copyright  ${YEAR} Flycast contributors. All rights reserved."
-				XCODE_ATTRIBUTE_DEBUG_INFORMATION_FORMAT "dwarf"
-				XCODE_ATTRIBUTE_DEBUG_INFORMATION_FORMAT[variant=RelWithDebInfo] "dwarf-with-dsym"
-				XCODE_ATTRIBUTE_CLANG_DEBUG_INFORMATION_LEVEL[variant=RelWithDebInfo] "line-tables-only"
-				XCODE_ATTRIBUTE_DEPLOYMENT_POSTPROCESSING[variant=RelWithDebInfo] YES
-				XCODE_ATTRIBUTE_ASSETCATALOG_COMPILER_APPICON_NAME "AppIcon"
-				XCODE_ATTRIBUTE_PRODUCT_BUNDLE_IDENTIFIER "com.flyinghead.Flycast"
-				BUILD_WITH_INSTALL_RPATH TRUE
-				INSTALL_RPATH "@loader_path/../Frameworks"
-			)
-
-			find_library(AUDIO_UNIT_LIBRARY AudioUnit)
-			find_library(FOUNDATION_LIBRARY Foundation)
-			find_library(AUDIO_TOOLBOX_LIBRARY AudioToolbox)
-			find_library(METAL_LIBRARY Metal)
-			find_library(IOSURFACE_LIBRARY IOSurface)
-			find_library(MULTITOUCH_SUPPORT_LIBRARY MultitouchSupport /System/Library/PrivateFrameworks)
-
-			target_link_libraries(${PROJECT_NAME} PRIVATE
-				${AUDIO_UNIT_LIBRARY}
-				${FOUNDATION_LIBRARY}
-				${AUDIO_TOOLBOX_LIBRARY}
-				${METAL_LIBRARY}
-				${IOSURFACE_LIBRARY}
-				${MULTITOUCH_SUPPORT_LIBRARY})
-
-			add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
-				COMMAND ${CMAKE_COMMAND} -E copy "$ENV{VULKAN_SDK}/lib/libMoltenVK.dylib"
-				$<TARGET_FILE_DIR:flycast>/../Frameworks/libvulkan.dylib)
-		endif()
-	elseif(UNIX)
-		if(NOT BUILD_TESTING)
-			target_sources(${PROJECT_NAME} PRIVATE
-					core/linux-dist/main.cpp)
-		endif()
-	elseif(WIN32)
-		target_sources(${PROJECT_NAME} PRIVATE
-			core/windows/rawinput.cpp
-			core/windows/rawinput.h)
-		if(NOT BUILD_TESTING)
-			target_sources(${PROJECT_NAME} PRIVATE core/windows/winmain.cpp)
-		endif()
-		if(WINDOWS_STORE)
-			file(READ shell/uwp/Package.appxmanifest MANIFEST)
-			string(REPLACE "9.9.9.9" ${MS_VERSION} MANIFEST ${MANIFEST})
-			file(WRITE ${CMAKE_BINARY_DIR}/Package.appxmanifest ${MANIFEST})
-			set(ResourceFiles ${CMAKE_BINARY_DIR}/Package.appxmanifest
-					shell/uwp/flycast150.png
-					shell/uwp/flycast50.png
-					shell/uwp/flycast44.png
-					shell/uwp/splash.png
-					shell/uwp/flycast44.targetsize-48_altform-unplated.png
-					shell/uwp/flycast44.targetsize-48_altform-lightunplated.png
-					core/deps/SDL/src/main/winrt/SDL2-WinRTResource_BlankCursor.cur
-					core/deps/SDL/src/main/winrt/SDL2-WinRTResources.rc)
-			target_sources(${PROJECT_NAME} PRIVATE
-				${ResourceFiles}
-				shell/uwp/http_client.cpp)
-			if(NOT BUILD_TESTING)
-				target_sources(${PROJECT_NAME} PRIVATE core/deps/SDL/src/main/winrt/SDL_winrt_main_NonXAML.cpp)
-			endif()
-			set_target_properties(${PROJECT_NAME} PROPERTIES RESOURCE "${ResourceFiles}")
-		else()
-			if(NOT BUILD_TESTING AND ("x86" IN_LIST ARCHITECTURE OR "x86_64" IN_LIST ARCHITECTURE))
-				target_include_directories(${PROJECT_NAME} PRIVATE core/deps/Spout/SPOUTSDK/SpoutGL)
-				target_include_directories(${PROJECT_NAME} PRIVATE core/deps/Spout/SPOUTSDK/SpoutDirectX/SpoutDX)
-				SET(SPOUT_BUILD_CMT OFF CACHE BOOL "For Visual Studio - build /MT to link runtime libraries" FORCE)
-				SET(SPOUT_BUILD_SPOUTDX ON CACHE BOOL "Build SpoutDX DirectX11 support library" FORCE)
-				SET(SPOUT_BUILD_LIBRARY OFF CACHE BOOL "Build C-compatible cross compiler library" FORCE)
-				SET(SKIP_INSTALL_ALL ON CACHE BOOL "Install headers and libraries" FORCE)
-				add_subdirectory(core/deps/Spout)
-				target_link_libraries(${PROJECT_NAME} PRIVATE Spout_static SpoutDX_static)
-				target_compile_definitions(${PROJECT_NAME} PRIVATE VIDEO_ROUTING)
-			endif()
-
-			target_sources(${PROJECT_NAME} PRIVATE shell/windows/flycast.rc)
-			target_link_libraries(${PROJECT_NAME} PRIVATE dsound winmm ws2_32 wsock32 xinput9_1_0 cfgmgr32 wininet psapi setupapi)
-		endif()
-	endif()
-endif()
-
-if(BUILD_TESTING)
-	add_subdirectory(core/deps/googletest EXCLUDE_FROM_ALL)
-	add_subdirectory(tests)
-endif()
-
-if(NINTENDO_SWITCH)
-	if(LIBRETRO)
-		add_custom_target(combined ALL
-			COMMAND ${CMAKE_AR} -x $<TARGET_FILE:xxHash::xxhash>
-			COMMAND ${CMAKE_AR} -x $<TARGET_FILE:chdr-static>
-			COMMAND ${CMAKE_AR} -x $<TARGET_FILE:zip>
-			COMMAND ${CMAKE_AR} -x $<TARGET_FILE:elf>
-			COMMAND ${CMAKE_AR} -x $<TARGET_FILE:flycast::res>
-			COMMAND ${CMAKE_AR} -rs flycast_libretro_libnx.a *.o
-			COMMAND rm *.o
-			WORKING_DIRECTORY ${CMAKE_BINARY_DIR}/${CMAKE_ARCHIVE_OUTPUT_DIRECTORY}
-			DEPENDS xxHash::xxhash chdr-static zip ${PROJECT_NAME})
-	else()
-		nx_generate_nacp(flycast.nacp NAME "Flycast" AUTHOR "flyinghead, M4xw" VERSION "${GIT_VERSION}")
-		nx_create_nro(flycast NACP flycast.nacp ICON "${CMAKE_SOURCE_DIR}/shell/switch/flycast.jpeg")
-	endif()
-endif()
-
-if(IOS)
-	install(FILES "${CMAKE_CURRENT_BINARY_DIR}/$<CONFIG>-${CMAKE_OSX_SYSROOT}/Flycast.ipa" TYPE BIN)
-elseif(NINTENDO_SWITCH AND NOT LIBRETRO)
-	install(FILES ${CMAKE_BINARY_DIR}/flycast.nro DESTINATION "${CMAKE_INSTALL_BINDIR}")
-elseif(LIBRETRO)
-	install(TARGETS ${PROJECT_NAME} DESTINATION "${CMAKE_INSTALL_LIBDIR}/libretro")
-else()
-	install(TARGETS ${PROJECT_NAME} DESTINATION "${CMAKE_INSTALL_BINDIR}")
-endif()
-
-if(UNIX AND NOT APPLE AND NOT ANDROID AND NOT LIBRETRO)
-	install(FILES shell/linux/man/${PROJECT_NAME}.1
-		DESTINATION "${CMAKE_INSTALL_MANDIR}/man1"
-	)
-	install(FILES shell/linux/${PROJECT_NAME}.desktop
-		DESTINATION "${CMAKE_INSTALL_DATAROOTDIR}/applications"
-	)
-	install(FILES shell/linux/${PROJECT_NAME}.png
-		DESTINATION "${CMAKE_INSTALL_DATAROOTDIR}/pixmaps"
-	)
-	install(FILES shell/linux/org.${PROJECT_NAME}.Flycast.metainfo.xml
-		DESTINATION "${CMAKE_INSTALL_DATAROOTDIR}/metainfo"
-	)
-	foreach(size 16 32 64 128 256 512)
-		install(FILES
-			shell/apple/emulator-osx/emulator-osx/Images.xcassets/AppIcon.appiconset/Icon-${size}.png
-			DESTINATION
-			"${CMAKE_INSTALL_DATAROOTDIR}/icons/hicolor/${size}x${size}/apps"
-			RENAME ${PROJECT_NAME}.png
-		)
-	endforeach()
-endif()
-
-if(${CMAKE_GENERATOR} MATCHES "^Xcode.*|^Visual Studio.*")
-	file(GLOB_RECURSE SRC_FILES *.h *.cpp *.c *.cc *.mm)
-	source_group(TREE ${CMAKE_CURRENT_SOURCE_DIR} FILES ${SRC_FILES})
-endif()
+if(APPLE AND NOT LIBRETRO)
+	# Requirement from SDL
+	# Minimum version for $<LINK_LIBRARY:feature,library-list>
+	cmake_minimum_required(VERSION 3.24)
+else()
+	cmake_minimum_required(VERSION 3.22.1)
+endif()
+
+find_program(CCACHE_PROGRAM ccache)
+if(CCACHE_PROGRAM)
+	set(CMAKE_C_COMPILER_LAUNCHER ${CCACHE_PROGRAM} CACHE STRING "Compiler launcher for C.")
+	set(CMAKE_CXX_COMPILER_LAUNCHER ${CCACHE_PROGRAM} CACHE STRING "Compiler launcher for CXX.")
+endif()
+
+set(SENTRY_UPLOAD_URL "" CACHE STRING "Sentry upload URL")
+
+set(CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/shell/cmake")
+
+# Set WINDOWS_STORE flag for UWP builds
+if(CMAKE_SYSTEM_NAME STREQUAL "WindowsStore")
+	set(WINDOWS_STORE TRUE)
+endif()
+
+# Set Windows 7 as minimum version for MinGW build
+if(MINGW)
+	add_compile_definitions(_WIN32_WINNT=0x0601 WINVER=0x0601)
+	add_link_options("-Wl,--subsystem,windows:6.1")
+endif()
+
+if(APPLE)
+	if(CMAKE_SYSTEM_NAME STREQUAL iOS)
+		set(CMAKE_OSX_DEPLOYMENT_TARGET "12.0" CACHE STRING "Minimum iOS deployment version")
+		set(CMAKE_OSX_ARCHITECTURES "arm64" CACHE STRING "")
+	elseif(CMAKE_SYSTEM_NAME STREQUAL tvOS)
+		set(CMAKE_OSX_DEPLOYMENT_TARGET "12.0" CACHE STRING "Minimum tvOS deployment version")
+		set(CMAKE_OSX_ARCHITECTURES "arm64" CACHE STRING "")
+	else()
+		set(CMAKE_OSX_DEPLOYMENT_TARGET "10.15" CACHE STRING "Minimum macOS deployment version")
+		set(CMAKE_OSX_ARCHITECTURES "x86_64;arm64" CACHE STRING "")
+	endif()
+	set(ZLIB_LIBRARY "-lz" CACHE STRING "Use generic linker flag for Xcode to support multiple SDKs")
+endif()
+
+if(LIBRETRO)
+	project(flycast_libretro)
+else()
+	project(flycast)
+endif()
+
+set(CMAKE_CXX_STANDARD 17)
+set(CMAKE_CXX_STANDARD_REQUIRED ON)
+if(CMAKE_SYSTEM_NAME MATCHES "NetBSD|Haiku" OR NINTENDO_SWITCH)
+	set(CMAKE_CXX_EXTENSIONS ON)
+else()
+	set(CMAKE_CXX_EXTENSIONS OFF)
+endif()
+
+include(DetectArchitecture)
+if(NOT DEFINED ARCHITECTURE)
+	message(FATAL_ERROR "Unsupported architecture encountered. Ending CMake generation.")
+endif()
+message(STATUS "Target architecture: ${ARCHITECTURE}")
+
+if(CMAKE_CXX_COMPILER MATCHES "webos" OR
+   CMAKE_CXX_COMPILER MATCHES "starfish")
+	set(WEBOS ON)
+endif()
+
+set(USE_HOST_SDL_DEFAULT OFF)
+if(NOT APPLE AND (NOT UNIX OR CMAKE_SYSTEM_NAME MATCHES "DragonFly|FreeBSD|OpenBSD|NetBSD|Haiku"))
+	set(USE_HOST_SDL_DEFAULT ON)
+endif()
+
+option(ENABLE_CTEST "Enables unit tests" OFF)
+option(ENABLE_OPROFILE "Enable OProfile" OFF)
+option(TEST_AUTOMATION "Enable test automation" OFF)
+option(ENABLE_LOG "Enable full logging" OFF)
+option(ASAN "Enable address sanitizer" OFF)
+option(USE_GLES "Use GLES[3] API" OFF)
+option(USE_GLES2 "Use GLES2 API" OFF)
+option(USE_HOST_GLSLANG "Use host glslang" OFF)
+option(USE_HOST_LIBZIP "Use host libzip" ON)
+option(USE_HOST_SDL "Use host SDL library" ${USE_HOST_SDL_DEFAULT})
+option(USE_HOST_LIBCHDR "Use host libchdr" OFF)
+option(USE_OPENMP "Use OpenMP if available" ON)
+option(USE_VULKAN "Build with Vulkan support" ON)
+option(USE_DX9 "Build with Direct3D 9 support" ON)
+option(USE_DX11 "Build with Direct3D 11 support" ON)
+option(LIBRETRO "Build libretro core" OFF)
+option(USE_OPENGL "Use OpenGL API" ON)
+option(USE_VIDEOCORE "RPI: use the legacy Broadcom GLES libraries" OFF)
+option(USE_ALSA "Build with ALSA support" ON)
+option(USE_LIBAO "Build with AO support" ON)
+option(USE_OSS "Build with OSS support" OFF)
+option(USE_PULSEAUDIO "Build with PulseAudio support" ON)
+option(USE_BREAKPAD "Build and link with breakpad library" ON)
+option(USE_LUA "Build with Lua support" ON)
+option(ENABLE_GDB_SERVER "Build with GDB debugging support" OFF)
+option(ENABLE_DC_PROFILER "Build with support for target machine (SH4) profiler" OFF)
+option(ENABLE_FC_PROFILER "Build with support for host app (Flycast) profiler" OFF)
+option(USE_DISCORD "Use Discord Presence API" OFF)
+option(USE_LIBCDIO "Use libcdio for CDROM access" OFF)
+
+if(IOS AND NOT LIBRETRO)
+	set(USE_VULKAN OFF CACHE BOOL "Force vulkan off" FORCE)
+endif()
+
+if(WEBOS)
+	set(USE_GLES2 ON CACHE BOOL "Use GLES2 API" FORCE)
+	set(USE_OPENMP OFF CACHE BOOL "Force openmp off" FORCE)
+	set(USE_VULKAN OFF CACHE BOOL "Force vulkan off" FORCE)
+endif()
+
+include(GNUInstallDirs)
+include(CMakeRC)
+
+if(ENABLE_CTEST)
+	include(CTest)
+	add_compile_definitions(FLYCAST_TEST_FILES="${CMAKE_CURRENT_SOURCE_DIR}/tests/files")
+endif()
+
+if(IOS AND NOT LIBRETRO)
+	set(CMAKE_Swift_LANGUAGE_VERSION 5.0)
+	enable_language(Swift)
+endif()
+
+find_package(Git)
+if(GIT_FOUND AND EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/.git")
+	execute_process(
+		COMMAND ${GIT_EXECUTABLE} describe --tags --always
+		WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
+		OUTPUT_VARIABLE GIT_VERSION
+		OUTPUT_STRIP_TRAILING_WHITESPACE
+	)
+	execute_process(
+		COMMAND ${GIT_EXECUTABLE} rev-parse --short HEAD
+		WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
+		OUTPUT_VARIABLE GIT_HASH
+		OUTPUT_STRIP_TRAILING_WHITESPACE
+	)
+else()
+	set(GIT_VERSION "v0.0.0-0-g000000000")
+	set(GIT_HASH "000000000")
+endif()
+
+if(WINDOWS_STORE)
+	string(REGEX REPLACE "[Vv]" "" MS_VERSION ${GIT_VERSION})
+	string(REPLACE "-" "." MS_VERSION ${MS_VERSION})
+	string(REGEX REPLACE "\.g[0-9a-f]+" "" MS_VERSION ${MS_VERSION})
+	string(REGEX MATCHALL "[0-9]+" VERSION_PARTS ${MS_VERSION})
+	list(LENGTH VERSION_PARTS VERSION_PARTS_LENGTH)
+	if(VERSION_PARTS_LENGTH EQUAL 2)
+		string(APPEND MS_VERSION ".0.0")
+	elseif(VERSION_PARTS_LENGTH EQUAL 3)
+		string(APPEND MS_VERSION ".0")
+	endif()
+endif()
+
+string(TIMESTAMP BUILD_TIMESTAMP UTC)
+configure_file("${CMAKE_CURRENT_SOURCE_DIR}/core/version.h.in" "${CMAKE_CURRENT_SOURCE_DIR}/core/version.h" @ONLY)
+
+if(NINTENDO_SWITCH)
+	set(USE_VULKAN OFF)
+	enable_language(ASM)
+
+	if(LIBRETRO)
+		add_library(${PROJECT_NAME} STATIC core/emulator.cpp)
+		target_compile_definitions(${PROJECT_NAME} PRIVATE LIBRETRO HAVE_LIBNX HAVE_OPENGL HAVE_OIT)
+		find_path(GLEXT_H_INCLUDE_DIR NAMES GL/glext.h REQUIRED)
+		target_include_directories(${PROJECT_NAME} PRIVATE ${GLEXT_H_INCLUDE_DIR})
+		set_target_properties(${PROJECT_NAME} PROPERTIES OUTPUT_NAME "flycast_libretro_libnx")
+		set(CMAKE_STATIC_LIBRARY_PREFIX "")
+	else()
+		add_executable(${PROJECT_NAME} core/emulator.cpp)
+	endif()
+	if(USE_GLES)
+		target_compile_definitions(${PROJECT_NAME} PRIVATE GLES)
+	endif()
+	# asio
+	target_compile_definitions(${PROJECT_NAME} PRIVATE
+		ASIO_DISABLE_LOCAL_SOCKETS
+		ASIO_DISABLE_SERIAL_PORT
+		ESHUTDOWN=110
+		SA_RESTART=0
+		SA_NOCLDWAIT=0
+		IMGUI_DISABLE_DEFAULT_SHELL_FUNCTIONS)
+
+elseif(LIBRETRO)
+	if(EMSCRIPTEN)
+		add_library(${PROJECT_NAME} STATIC core/emulator.cpp)
+		target_compile_options(${PROJECT_NAME} PRIVATE -fexceptions)
+		set_target_properties(${PROJECT_NAME} PROPERTIES OUTPUT_NAME "flycast_libretro_emscripten")
+		target_compile_definitions(${PROJECT_NAME} PRIVATE
+			ASIO_DISABLE_THREADS
+			ASIO_DISABLE_LOCAL_SOCKETS
+			ASIO_DISABLE_SERIAL_PORT)
+	else()
+		add_library(${PROJECT_NAME} SHARED core/emulator.cpp)
+		if(APPLE)
+			if(NOT IOS)
+				set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,-undefined,error")
+			endif()
+			set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,-exported_symbols_list,${CMAKE_CURRENT_SOURCE_DIR}/shell/libretro/libretro.osx.def")
+		else()
+			if(NOT CMAKE_SYSTEM_NAME STREQUAL "OpenBSD")
+				set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,--no-undefined")
+			endif()
+		endif()
+		set_target_properties(${PROJECT_NAME} PROPERTIES OUTPUT_NAME "flycast_libretro"
+		  XCODE_ATTRIBUTE_CODE_SIGNING_ALLOWED "NO"
+		  XCODE_ATTRIBUTE_CODE_SIGN_IDENTITY ""
+		)
+		set(CMAKE_SHARED_LIBRARY_PREFIX "")
+	endif()
+	set(CMAKE_POSITION_INDEPENDENT_CODE ON)
+	target_compile_definitions(${PROJECT_NAME} PRIVATE LIBRETRO)
+	if(APPLE)
+		find_library(FOUNDATION Foundation)
+		target_link_libraries(${PROJECT_NAME} PRIVATE ${FOUNDATION})
+	endif()
+	if(ANDROID OR USE_GLES)
+		target_compile_definitions(${PROJECT_NAME} PRIVATE GLES GLES3 HAVE_OPENGLES HAVE_OPENGLES3 HAVE_OIT)
+    elseif(IOS)
+		target_compile_definitions(${PROJECT_NAME} PRIVATE GLES GLES3 HAVE_OPENGLES HAVE_OPENGLES3)
+		find_library(OPENGLES OpenGLES)
+		find_library(GLKIT GLKit)
+		target_link_libraries(${PROJECT_NAME} PRIVATE ${OPENGLES} ${GLKIT})
+	elseif(USE_GLES2)
+		target_compile_definitions(${PROJECT_NAME} PRIVATE GLES GLES2 HAVE_OPENGLES HAVE_OPENGLES2)
+		if(USE_VIDEOCORE)
+			target_compile_definitions(${PROJECT_NAME} PRIVATE TARGET_NO_STENCIL)
+			target_link_libraries(${PROJECT_NAME} PRIVATE "-lbrcmGLESv2")
+			target_link_directories(${PROJECT_NAME} PRIVATE "/opt/vc/lib")
+		else()
+			target_link_libraries(${PROJECT_NAME} PRIVATE "-lGLESv2")
+		endif()
+	elseif(USE_OPENGL)
+		if (CMAKE_SYSTEM_NAME MATCHES "FreeBSD|OpenBSD|NetBSD")
+			find_package(OpenGL REQUIRED)
+			if(CMAKE_VERSION VERSION_LESS 3.29.0)
+				target_include_directories(${PROJECT_NAME} PRIVATE ${OPENGL_INCLUDE_DIR})
+			else()
+				target_include_directories(${PROJECT_NAME} PRIVATE ${OPENGL_INCLUDE_DIRS})
+			endif()
+		endif()
+		target_compile_definitions(${PROJECT_NAME} PRIVATE HAVE_OPENGL)
+		if(APPLE)
+			set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,-framework,OpenGL")
+		else()
+			target_compile_definitions(${PROJECT_NAME} PRIVATE HAVE_OIT)
+		endif()
+	endif()
+elseif(ANDROID)
+	add_library(${PROJECT_NAME} SHARED core/emulator.cpp)
+	set(CMAKE_C_FLAGS_DEBUG "${CMAKE_C_FLAGS_RELEASE} -O3")
+	set(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_RELEASE} -O3")
+	target_compile_options(${PROJECT_NAME} PRIVATE -fno-stack-protector)
+	set(CMAKE_ANDROID_STL_TYPE "c++_static")
+elseif(WIN32)
+	if(BUILD_TESTING)
+		add_executable(${PROJECT_NAME} core/emulator.cpp)
+	else()
+		add_executable(${PROJECT_NAME} WIN32 core/emulator.cpp)
+	endif()
+	if(CMAKE_GENERATOR MATCHES "Visual Studio")
+		if(NOT CMAKE_VS_GLOBALS MATCHES "(^|;)UseMultiToolTask=")
+			list(APPEND CMAKE_VS_GLOBALS UseMultiToolTask=true)
+		endif()
+		if(NOT CMAKE_VS_GLOBALS MATCHES "(^|;)EnforceProcessCountAcrossBuilds=")
+			list(APPEND CMAKE_VS_GLOBALS EnforceProcessCountAcrossBuilds=true)
+		endif()
+		set_property(DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR} PROPERTY VS_STARTUP_PROJECT ${PROJECT_NAME})
+	endif()
+elseif(APPLE)
+	add_executable(${PROJECT_NAME} MACOSX_BUNDLE core/emulator.cpp)
+else()
+	add_executable(${PROJECT_NAME} core/emulator.cpp)
+endif()
+
+set_target_properties(${PROJECT_NAME} PROPERTIES
+		CMAKE_CXX_STANDARD 20
+		CMAKE_CXX_STANDARD_REQUIRED ON)
+
+if(WINDOWS_STORE)
+	set(USE_OPENGL OFF)
+	set(USE_VULKAN OFF)
+endif()
+
+set_target_properties(${PROJECT_NAME} PROPERTIES LINK_FLAGS_RELEASE -s)
+if(MSVC)
+	target_compile_options(${PROJECT_NAME} PRIVATE /GR /GS-)
+	if(WINDOWS_STORE)
+		target_compile_options(${PROJECT_NAME} PRIVATE /ZW)
+	endif()
+else()
+	target_compile_options(${PROJECT_NAME} PRIVATE
+		$<$<COMPILE_LANGUAGE:CXX>:-fno-strict-aliasing>
+		$<$<COMPILE_LANGUAGE:CXX>:-Wall>)
+endif()
+
+if(APPLE AND NOT IOS)
+	set(TARGET_MAC ON)
+endif()
+
+target_compile_definitions(${PROJECT_NAME} PRIVATE
+		$<$<BOOL:${APPLE}>:GL_SILENCE_DEPRECATION>
+		$<$<BOOL:${ENABLE_LOG}>:DEBUGFAST>
+		$<$<BOOL:${IOS}>:TARGET_IPHONE>
+		$<$<BOOL:${TARGET_MAC}>:TARGET_MAC>
+		$<$<BOOL:${IOS}>:GLES>
+		$<$<BOOL:${IOS}>:GLES3>
+		$<$<BOOL:${IOS}>:GLES_SILENCE_DEPRECATION>
+		$<$<BOOL:${MSVC}>:_CRT_NONSTDC_NO_WARNINGS>
+		$<$<BOOL:${MSVC}>:_CRT_SECURE_NO_WARNINGS>
+		$<$<BOOL:${MSVC}>:_WINSOCK_DEPRECATED_NO_WARNING>
+		$<$<BOOL:${MSVC}>:NOMINMAX>
+		$<$<BOOL:${TEST_AUTOMATION}>:TEST_AUTOMATION>
+		$<$<BOOL:${WINDOWS_STORE}>:WINDOWS_STORE>
+		$<$<BOOL:${WINDOWS_STORE}>:TARGET_UWP>
+		$<$<BOOL:${WINDOWS_STORE}>:NOCRYPT>
+		$<$<BOOL:${WINDOWS_STORE}>:_WIN32_WINNT=0x0A00>
+		$<$<OR:$<BOOL:${MINGW}>,$<BOOL:${MSVC}>>:_USE_MATH_DEFINES>)
+
+if(UNIX AND NOT ANDROID AND NOT APPLE)
+	execute_process(COMMAND getconf PAGESIZE OUTPUT_VARIABLE PAGE_SIZE OUTPUT_STRIP_TRAILING_WHITESPACE)
+	target_compile_definitions(${PROJECT_NAME} PRIVATE PAGE_SIZE=${PAGE_SIZE})
+endif()
+
+if(NOT "${SENTRY_UPLOAD_URL}" STREQUAL "")
+	target_compile_definitions(${PROJECT_NAME} PRIVATE SENTRY_UPLOAD="${SENTRY_UPLOAD_URL}")
+endif()
+
+target_include_directories(${PROJECT_NAME} PRIVATE core core/deps core/deps/stb core/deps/json core/deps/asio/asio/include)
+if(LIBRETRO)
+	target_include_directories(${PROJECT_NAME} PRIVATE shell/libretro)
+endif()
+if(NINTENDO_SWITCH)
+	target_include_directories(${PROJECT_NAME} PRIVATE shell/switch)
+endif()
+
+if(CMAKE_SYSTEM_NAME STREQUAL "OpenBSD")
+	target_link_options(${PROJECT_NAME} PRIVATE "-Wl,--no-execute-only")
+endif()
+
+if(USE_BREAKPAD AND NOT LIBRETRO)
+	find_program(SH_EXECUTABLE sh)
+	if((ANDROID AND NOT CMAKE_HOST_SYSTEM_NAME STREQUAL "Windows") OR (MINGW AND SH_EXECUTABLE) OR (CMAKE_SYSTEM_NAME STREQUAL "Linux"))
+		add_subdirectory(core/deps/breakpad)
+		if(WIN32)
+			target_link_options(${PROJECT_NAME} PRIVATE "-Wl,--build-id")
+		endif()
+		target_link_libraries(${PROJECT_NAME} PUBLIC breakpad_client)
+		target_compile_definitions(${PROJECT_NAME} PRIVATE USE_BREAKPAD)
+	elseif(APPLE AND NOT IOS)
+		target_sources(${PROJECT_NAME} PRIVATE
+			core/deps/breakpad/src/client/minidump_file_writer-inl.h
+			core/deps/breakpad/src/client/minidump_file_writer.cc
+			core/deps/breakpad/src/client/minidump_file_writer.h
+			core/deps/breakpad/src/client/mac/handler/breakpad_nlist_64.cc
+			core/deps/breakpad/src/client/mac/handler/breakpad_nlist_64.h
+			core/deps/breakpad/src/client/mac/handler/dynamic_images.cc
+			core/deps/breakpad/src/client/mac/handler/dynamic_images.h
+			core/deps/breakpad/src/client/mac/handler/exception_handler.cc
+			core/deps/breakpad/src/client/mac/handler/exception_handler.h
+			core/deps/breakpad/src/client/mac/handler/minidump_generator.cc
+			core/deps/breakpad/src/client/mac/handler/minidump_generator.h
+			core/deps/breakpad/src/client/mac/handler/protected_memory_allocator.cc
+			core/deps/breakpad/src/client/mac/handler/protected_memory_allocator.h
+			core/deps/breakpad/src/client/mac/crash_generation/ConfigFile.h
+			core/deps/breakpad/src/client/mac/crash_generation/ConfigFile.mm
+			core/deps/breakpad/src/client/mac/crash_generation/client_info.h
+			core/deps/breakpad/src/client/mac/crash_generation/crash_generation_client.h
+			core/deps/breakpad/src/client/mac/crash_generation/crash_generation_client.cc
+			core/deps/breakpad/src/common/convert_UTF.cc
+			core/deps/breakpad/src/common/convert_UTF.h
+			core/deps/breakpad/src/common/md5.cc
+			core/deps/breakpad/src/common/string_conversion.cc
+			core/deps/breakpad/src/common/string_conversion.h
+			core/deps/breakpad/src/common/mac/file_id.cc
+			core/deps/breakpad/src/common/mac/file_id.h
+			core/deps/breakpad/src/common/mac/MachIPC.mm
+			core/deps/breakpad/src/common/mac/MachIPC.h
+			core/deps/breakpad/src/common/mac/bootstrap_compat.cc
+			core/deps/breakpad/src/common/mac/bootstrap_compat.h
+			core/deps/breakpad/src/common/mac/macho_id.cc
+			core/deps/breakpad/src/common/mac/macho_id.h
+			core/deps/breakpad/src/common/mac/macho_utilities.cc
+			core/deps/breakpad/src/common/mac/macho_utilities.h
+			core/deps/breakpad/src/common/mac/macho_walker.cc
+			core/deps/breakpad/src/common/mac/macho_walker.h
+			core/deps/breakpad/src/common/mac/string_utilities.cc
+			core/deps/breakpad/src/common/mac/string_utilities.h
+		)
+		target_include_directories(${PROJECT_NAME} PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/core/deps/breakpad/src)
+		target_compile_definitions(${PROJECT_NAME} PRIVATE USE_BREAKPAD)
+		add_custom_target(dump_syms COMMAND xcodebuild -project ${CMAKE_CURRENT_SOURCE_DIR}/core/deps/breakpad/src/tools/mac/dump_syms/dump_syms.xcodeproj -target dump_syms -configuration Release CONFIGURATION_BUILD_DIR=${CMAKE_CURRENT_SOURCE_DIR}/build/breakpad)
+		ADD_DEPENDENCIES(${PROJECT_NAME} dump_syms)
+
+		if(${CMAKE_GENERATOR} MATCHES "^Xcode.*")
+			add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
+				COMMAND sleep 20
+				COMMAND mkdir -p ../symbols
+				COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/build/breakpad/dump_syms
+					-a x86_64
+					-g ${CMAKE_CURRENT_BINARY_DIR}/$<CONFIG>/Flycast.app.dSYM
+					$<TARGET_FILE:flycast> > ../symbols/Flycast-x64.sym
+				COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/build/breakpad/dump_syms
+					-a arm64
+					-g ${CMAKE_CURRENT_BINARY_DIR}/$<CONFIG>/Flycast.app.dSYM
+					$<TARGET_FILE:flycast> > ../symbols/Flycast-arm64.sym
+			)
+		else()
+			add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
+				COMMAND sleep 20
+				COMMAND mkdir -p ../symbols
+				COMMAND dsymutil $<TARGET_FILE:flycast>
+					-o ${CMAKE_CURRENT_BINARY_DIR}/Flycast.app.dSYM
+				COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/build/breakpad/dump_syms
+					-a x86_64
+					-g ${CMAKE_CURRENT_BINARY_DIR}/Flycast.app.dSYM
+					$<TARGET_FILE:flycast> > ../symbols/Flycast-x64.sym
+				COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/build/breakpad/dump_syms
+					-a arm64
+					-g ${CMAKE_CURRENT_BINARY_DIR}/Flycast.app.dSYM
+					$<TARGET_FILE:flycast> > ../symbols/Flycast-arm64.sym
+			)
+		endif()
+	endif()
+endif()
+
+if(USE_OPENMP)
+	if(APPLE AND IS_DIRECTORY "/opt/homebrew/opt/libomp")
+		list(PREPEND CMAKE_PREFIX_PATH "/opt/homebrew/opt/libomp")
+		message(STATUS "Found and using Homebrew libomp hint.")
+	endif()
+	find_package(OpenMP)
+	if(OpenMP_CXX_FOUND)
+		if(MINGW)
+			target_link_libraries(${PROJECT_NAME} PRIVATE -lpthread)
+			target_link_options(${PROJECT_NAME} PRIVATE -fopenmp -static)
+			target_compile_options(${PROJECT_NAME} PRIVATE -fopenmp)
+		elseif(ANDROID)
+			# Reference: https://android.googlesource.com/platform/ndk/+/refs/heads/master/tests/device/openmp/CMakeLists.txt
+			set_target_properties(${PROJECT_NAME} PROPERTIES COMPILE_OPTIONS -fopenmp)
+			target_link_libraries(${PROJECT_NAME} PRIVATE -fopenmp -static-openmp)
+		else()
+			target_link_libraries(${PROJECT_NAME} PRIVATE OpenMP::OpenMP_CXX)
+		endif()
+	endif()
+endif()
+
+option(BUILD_SHARED_LIBS "Build shared library" OFF)
+set(XXHASH_BUILD_XXHSUM OFF CACHE BOOL "Build the xxhsum binary")
+add_subdirectory(core/deps/xxHash/cmake_unofficial)
+target_link_libraries(${PROJECT_NAME} PRIVATE xxHash::xxhash)
+
+option(BUILD_SHARED_LIBS "Build shared library" OFF)
+add_subdirectory(core/deps/glm)
+target_link_libraries(${PROJECT_NAME} PRIVATE glm::glm)
+
+if(USE_VULKAN)
+	if(USE_HOST_GLSLANG)
+		find_package(glslang REQUIRED)
+	else()
+		option(BUILD_EXTERNAL "Build external dependencies in /External" OFF)
+		option(ENABLE_SPVREMAPPER "Enables building of SPVRemapper" OFF)
+		option(ENABLE_GLSLANG_BINARIES "Builds glslang and spirv-remap" OFF)
+		option(ENABLE_HLSL "Enables HLSL input support" OFF)
+		option(ENABLE_OPT "Enables spirv-opt capability if present" OFF)
+		option(ENABLE_PCH "Enables Precompiled header" OFF)
+		add_subdirectory(core/deps/glslang EXCLUDE_FROM_ALL)
+	endif()
+	target_link_libraries(${PROJECT_NAME} PRIVATE glslang::glslang-default-resource-limits glslang::SPIRV)
+endif()
+
+if(NOT LIBRETRO)
+	if(USE_OSS)
+		target_compile_definitions(${PROJECT_NAME} PRIVATE USE_OSS)
+	endif()
+
+	if(USE_ALSA)
+		find_package(ALSA)
+		if(ALSA_FOUND AND NOT ANDROID)
+			target_compile_definitions(${PROJECT_NAME} PRIVATE USE_ALSA)
+			target_include_directories(${PROJECT_NAME} PRIVATE ${ALSA_INCLUDE_DIRS})
+			target_link_libraries(${PROJECT_NAME} PRIVATE ${ALSA_LIBRARIES})
+		endif()
+	endif()
+
+	if(MINGW)
+		target_link_libraries(${PROJECT_NAME} PRIVATE "-static-libgcc -static-libstdc++")
+	endif()
+
+	if(NOT ANDROID AND NOT IOS)
+		if (NOT NINTENDO_SWITCH)
+			# DreamLink enabled for non-mobile Linux, MacOS, and Windows
+			target_compile_definitions(${PROJECT_NAME} PRIVATE USE_DREAMLINK_DEVICES=1)
+			set(USE_DREAMLINK_DEVICES ON) # Must be set before adding core/sdl
+
+			if (WINDOWS_STORE)
+				# Use winrt implementation of the DreamPicoPort-API
+				option(DREAMPICOPORT_WITH_LIBUSB "Use libusb to access DreamPicoPort-API" OFF)
+			elseif (CMAKE_SYSTEM_NAME MATCHES "DragonFly|FreeBSD|NetBSD|OpenBSD|Haiku")
+				find_package(PkgConfig REQUIRED)
+   	 			pkg_check_modules(LIBUSB REQUIRED libusb-1.0)
+
+				set(DREAMPICOPORT_LIBUSB_LIBRARIES "${LIBUSB_LIBRARIES}" CACHE STRING "Name of the libusb library to link against")
+				set(DREAMPICOPORT_LIBUSB_INCLUDE_DIRS "${LIBUSB_INCLUDE_DIRS}" CACHE STRING "Path to libusb include directory, when applicable")
+			else()
+				if(MINGW)
+					# Shim 'windowsapp' to prevent libusb from linking against the UWP library
+					# and link against standard desktop libraries instead for Windows 7 support.
+					if(NOT TARGET windowsapp)
+						add_library(windowsapp INTERFACE)
+						target_link_libraries(windowsapp INTERFACE advapi32 ole32 shell32 user32)
+					endif()
+				endif()
+				# libusb
+				add_subdirectory(core/deps/DreamPicoPort-API/ext/libusb-cmake)
+			endif()
+
+			# DreamPicoPort-API
+			option(DREAMPICOPORT_ADD_LIBUSB "Add internal libusb library" OFF) # Already included above, when applicable
+			add_subdirectory(core/deps/DreamPicoPort-API EXCLUDE_FROM_ALL)
+			target_link_libraries(${PROJECT_NAME} PRIVATE dream_pico_port_api)
+		endif()
+
+		if(USE_HOST_SDL)
+			find_package(SDL2 2.0.9)
+		endif()
+		if(NOT SDL2_FOUND)
+			set(SDL_TEST_ENABLED_BY_DEFAULT OFF)
+			add_subdirectory(core/deps/SDL EXCLUDE_FROM_ALL)
+			set(SDL2_FOUND 1)
+		endif()
+
+		# SDL2::SDL2main may or may not be available. It is e.g. required by Windows GUI applications
+		if(TARGET SDL2::SDL2main AND NOT BUILD_TESTING)
+			# It has an implicit dependency on SDL2 functions, so it MUST be added before SDL2::SDL2 (or SDL2::SDL2-static)
+			target_link_libraries(${PROJECT_NAME} PRIVATE SDL2::SDL2main)
+		endif()
+
+		if((APPLE OR WIN32) AND TARGET SDL2::SDL2-static)
+			target_link_libraries(${PROJECT_NAME} PRIVATE SDL2::SDL2-static)
+		elseif(TARGET SDL2::SDL2)
+			target_link_libraries(${PROJECT_NAME} PRIVATE SDL2::SDL2)
+		else()
+			target_include_directories(${PROJECT_NAME} PRIVATE ${SDL2_INCLUDE_DIRS})
+			target_link_libraries(${PROJECT_NAME} PRIVATE ${SDL2_LIBRARIES})
+		endif()
+
+		target_compile_definitions(${PROJECT_NAME} PRIVATE USE_SDL USE_SDL_AUDIO)
+		add_subdirectory(core/sdl)
+
+		if((UNIX AND NOT APPLE) OR NINTENDO_SWITCH)
+			find_package(CURL REQUIRED)
+			target_link_libraries(${PROJECT_NAME} PRIVATE CURL::libcurl)
+		endif()
+	endif()
+
+	find_package(ZLIB)
+	if(TARGET ZLIB::ZLIB AND NOT ANDROID AND (NOT WIN32 OR WINDOWS_STORE))
+		set(WITH_SYSTEM_ZLIB ON CACHE BOOL "Use system provided zlib library")
+		target_link_libraries(${PROJECT_NAME} PRIVATE ZLIB::ZLIB)
+	endif()
+
+	if(USE_LUA)
+		find_package(Lua 5.2)
+		if(NOT APPLE AND LUA_FOUND)
+			target_compile_definitions(${PROJECT_NAME} PRIVATE USE_LUA)
+			target_include_directories(${PROJECT_NAME} PRIVATE ${LUA_INCLUDE_DIR} core/deps/luabridge/Source)
+			list(TRANSFORM LUA_LIBRARIES REPLACE "\.dll" "")
+			target_link_libraries(${PROJECT_NAME} PRIVATE ${LUA_LIBRARIES})
+		endif()
+	endif()
+endif()
+
+find_package(PkgConfig)
+
+if(NOT WITH_SYSTEM_ZLIB)
+    option(ZLIB_BUILD_EXAMPLES "Enable Zlib Examples" OFF)
+    add_subdirectory("core/deps/libchdr/deps/zlib-1.3.1" EXCLUDE_FROM_ALL)
+	set_target_properties(zlibstatic PROPERTIES POSITION_INDEPENDENT_CODE ON)
+	target_link_libraries(${PROJECT_NAME} PRIVATE zlibstatic)
+	# help libzip find the package
+	set(ZLIB_RELATIVE_PATH "core/deps/libchdr/deps/zlib-1.3.1")
+	set(ZLIB_INCLUDE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/${ZLIB_RELATIVE_PATH}" "${CMAKE_CURRENT_BINARY_DIR}/${ZLIB_RELATIVE_PATH}")
+endif()
+
+if(PKG_CONFIG_FOUND AND USE_HOST_LIBCHDR)
+	pkg_check_modules(LIBCHDR IMPORTED_TARGET libchdr)
+	target_link_libraries(${PROJECT_NAME} PRIVATE PkgConfig::LIBCHDR)
+else()
+	option(ZSTD_BUILD_SHARED "BUILD SHARED LIBRARIES" OFF)
+	option(ZSTD_BUILD_PROGRAMS "BUILD PROGRAMS" OFF)
+	option(ZSTD_LEGACY_SUPPORT "LEGACY SUPPORT" OFF)
+	add_subdirectory(core/deps/libchdr/deps/zstd-1.5.6/build/cmake EXCLUDE_FROM_ALL)
+	target_link_libraries(${PROJECT_NAME} PRIVATE libzstd_static)
+
+	option(WITH_SYSTEM_ZSTD "Use system provided zstd library" ON)
+	add_subdirectory(core/deps/libchdr EXCLUDE_FROM_ALL)
+	target_link_libraries(${PROJECT_NAME} PRIVATE chdr-static)
+	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/libchdr/include)
+endif()
+
+if(PKG_CONFIG_FOUND AND NOT ANDROID AND NOT APPLE AND NOT LIBRETRO)
+	if(USE_LIBAO)
+		pkg_check_modules(AO IMPORTED_TARGET ao)
+		if(AO_FOUND)
+			target_compile_definitions(${PROJECT_NAME} PRIVATE USE_LIBAO)
+			target_link_libraries(${PROJECT_NAME} PRIVATE PkgConfig::AO)
+		endif()
+	endif()
+
+	if(NOT SDL2_FOUND)
+		pkg_check_modules(LIBEVDEV IMPORTED_TARGET libevdev)
+		if(LIBEVDEV_FOUND)
+			target_compile_definitions(${PROJECT_NAME} PRIVATE USE_EVDEV)
+			target_link_libraries(${PROJECT_NAME} PRIVATE PkgConfig::LIBEVDEV)
+
+			pkg_check_modules(LIBUDEV IMPORTED_TARGET libudev)
+			if(LIBUDEV_FOUND)
+				target_compile_definitions(${PROJECT_NAME} PRIVATE USE_UDEV)
+				target_link_libraries(${PROJECT_NAME} PRIVATE PkgConfig::LIBUDEV)
+			endif()
+		endif()
+	endif()
+
+	if(USE_PULSEAUDIO)
+		pkg_check_modules(LIBPULSE IMPORTED_TARGET libpulse)
+		if(LIBPULSE_FOUND)
+			target_compile_definitions(${PROJECT_NAME} PRIVATE USE_PULSEAUDIO)
+			target_link_libraries(${PROJECT_NAME} PRIVATE PkgConfig::LIBPULSE)
+		endif()
+	endif()
+
+	if(USE_HOST_LIBZIP)
+		pkg_check_modules(LIBZIP IMPORTED_TARGET libzip)
+		if(LIBZIP_FOUND)
+			target_link_libraries(${PROJECT_NAME} PRIVATE PkgConfig::LIBZIP)
+		endif()
+	endif()
+
+	if(ENABLE_OPROFILE)
+		target_compile_definitions(${PROJECT_NAME} PRIVATE DYNA_OPROF)
+		target_link_libraries(${PROJECT_NAME} PRIVATE opagent)
+	endif()
+
+	find_package(MiniUPnPc)
+	if(MINIUPNP_FOUND)
+		target_include_directories(${PROJECT_NAME} PRIVATE ${MINIUPNP_INCLUDE_DIRS})
+		target_link_libraries(${PROJECT_NAME} PRIVATE ${MINIUPNP_LIBRARIES})
+	endif()
+endif()
+
+if(UNIX AND NOT APPLE AND NOT ANDROID)
+	add_definitions(
+		-DFLYCAST_DATADIR="${CMAKE_INSTALL_FULL_DATADIR}/${PROJECT_NAME}/"
+		-DFLYCAST_SYSCONFDIR="${CMAKE_INSTALL_FULL_SYSCONFDIR}/${PROJECT_NAME}/"
+	)
+
+	if(USE_GLES2)
+		target_compile_definitions(${PROJECT_NAME} PRIVATE GLES GLES2)
+		if(USE_VIDEOCORE)
+			target_compile_definitions(${PROJECT_NAME} PRIVATE TARGET_VIDEOCORE USE_OMX)
+			target_link_libraries(${PROJECT_NAME} PRIVATE "-lbrcmGLESv2")
+			target_link_directories(${PROJECT_NAME} PRIVATE "/opt/vc/lib")
+		endif()
+	elseif(USE_GLES)
+		target_compile_definitions(${PROJECT_NAME} PRIVATE GLES GLES3)
+	endif()
+
+	find_package(Threads REQUIRED)
+	target_link_libraries(${PROJECT_NAME} PRIVATE Threads::Threads)
+	if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU" AND "x86_64" IN_LIST ARCHITECTURE AND NOT LIBRETRO)
+		set_target_properties(${PROJECT_NAME} PROPERTIES POSITION_INDEPENDENT_CODE False)
+		if(${CMAKE_VERSION} VERSION_LESS "3.14.0")
+			set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -no-pie")
+		endif()
+	endif()
+
+	if(NOT SDL2_FOUND AND NOT LIBRETRO)
+		find_package(X11 REQUIRED)
+		if(X11_FOUND)
+			target_compile_definitions(${PROJECT_NAME} PRIVATE SUPPORT_X11)
+			target_include_directories(${PROJECT_NAME} PRIVATE ${X11_INCLUDE_DIR})
+			target_link_libraries(${PROJECT_NAME} PRIVATE ${X11_LIBRARIES})
+		endif()
+	endif()
+
+	find_library(LIBRT rt)
+	if(LIBRT)
+		target_link_libraries(${PROJECT_NAME} PRIVATE ${LIBRT})
+	endif()
+
+	target_link_libraries(${PROJECT_NAME} PRIVATE ${CMAKE_DL_LIBS})
+endif()
+
+if(ASAN)
+	if(ANDROID)
+		target_compile_options(${PROJECT_NAME} PRIVATE -fsanitize=address -fno-omit-frame-pointer)
+		set_target_properties(${PROJECT_NAME} PROPERTIES LINK_FLAGS -fsanitize=address)
+	else()
+		target_compile_options(${PROJECT_NAME} PRIVATE -fsanitize=address -static-libasan)
+		set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -fsanitize=address -static-libasan")
+	endif()
+endif()
+
+if(ANDROID AND "arm" IN_LIST ARCHITECTURE)
+	enable_language(ASM)
+	option(LIBUNWIND_ENABLE_SHARED "Build libunwind as a shared library." OFF)
+	add_subdirectory(core/deps/libunwind/libunwind)
+	target_link_libraries(${PROJECT_NAME} PRIVATE unwind_static)
+endif()
+
+if(ANDROID AND NOT LIBRETRO)
+	set(BUILD_SHARED_LIBS OFF)
+	add_subdirectory(core/deps/oboe)
+	target_compile_definitions(${PROJECT_NAME} PRIVATE USE_OBOE)
+	target_link_libraries(${PROJECT_NAME} PRIVATE oboe)
+endif()
+
+target_sources(${PROJECT_NAME} PRIVATE
+		core/deps/chdpsr/cdipsr.cpp
+		core/deps/chdpsr/cdipsr.h)
+
+add_subdirectory(core/deps/nowide EXCLUDE_FROM_ALL)
+target_link_libraries(${PROJECT_NAME} PRIVATE nowide::nowide)
+
+if(NOT MINIUPNP_FOUND)
+	if(NINTENDO_SWITCH)
+		target_compile_definitions(${PROJECT_NAME} PRIVATE FEAT_NO_MINIUPNPC)
+	else()
+		option(UPNPC_BUILD_SHARED "Build shared library" OFF)
+		option(UPNPC_BUILD_TESTS "Build test executables" OFF)
+		option(UPNPC_BUILD_SAMPLE "Build sample executables" OFF)
+		option(UPNPC_NO_INSTALL "Disable installation" ON)
+		add_subdirectory(core/deps/miniupnpc)
+		if(WINDOWS_STORE OR MINGW)
+			get_target_property(miniupnpc-private-defs miniupnpc-private INTERFACE_COMPILE_DEFINITIONS)
+			list(REMOVE_ITEM miniupnpc-private-defs "_WIN32_WINNT=0x0501")
+			set_property(TARGET miniupnpc-private PROPERTY INTERFACE_COMPILE_DEFINITIONS ${miniupnpc-private-defs})
+		endif()
+		target_link_libraries(${PROJECT_NAME} PRIVATE miniupnpc::miniupnpc)
+	endif()
+endif()
+
+if(NOT LIBZIP_FOUND OR NINTENDO_SWITCH)
+	option(ENABLE_COMMONCRYPTO "Enable use of CommonCrypto" OFF)
+	option(ENABLE_GNUTLS "Enable use of GnuTLS" OFF)
+	option(ENABLE_MBEDTLS "Enable use of mbed TLS" OFF)
+	option(ENABLE_OPENSSL "Enable use of OpenSSL" OFF)
+	option(ENABLE_WINDOWS_CRYPTO "Enable use of Windows cryptography libraries" OFF)
+	option(ENABLE_BZIP2 "Enable use of BZip2" OFF)
+	option(ENABLE_LZMA "Enable use of LZMA" OFF)
+	option(ENABLE_ZSTD "Enable use of Zstandard" ON)
+	option(BUILD_TOOLS "Build tools in the src directory (zipcmp, zipmerge, ziptool)" OFF)
+	option(BUILD_REGRESS "Build regression tests" OFF)
+	option(BUILD_EXAMPLES "Build examples" OFF)
+	option(BUILD_DOC "Build documentation" OFF)
+	option(BUILD_SHARED_LIBS "Build shared libraries" OFF)
+	option(LIBZIP_DO_INSTALL "Install libzip and the related files" OFF)
+	add_subdirectory(core/deps/libzip EXCLUDE_FROM_ALL)
+	target_link_libraries(${PROJECT_NAME} PRIVATE libzip::zip)
+endif()
+
+if(USE_LIBCDIO)
+	if(PKG_CONFIG_FOUND)
+		pkg_check_modules(CDIO IMPORTED_TARGET libcdio)
+		if(CDIO_FOUND)
+			target_compile_definitions(${PROJECT_NAME} PRIVATE USE_LIBCDIO)
+			if(MINGW)
+				# Force static link
+				target_link_libraries(${PROJECT_NAME} PRIVATE "-l:libcdio.a -l:libiconv.a -lwinmm")
+			else()
+				target_link_libraries(${PROJECT_NAME} PRIVATE PkgConfig::CDIO)
+			endif()
+		endif()
+	endif()
+	if(NOT CDIO_FOUND)
+		find_package(libcdio)
+		if(TARGET libcdio::libcdio)
+			target_compile_definitions(${PROJECT_NAME} PRIVATE USE_LIBCDIO)
+			target_link_libraries(${PROJECT_NAME} PRIVATE libcdio::libcdio)
+		endif()
+	endif()
+endif()
+
+if(WIN32)
+	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/dirent)
+endif()
+
+if(NOT LIBRETRO AND NOT NINTENDO_SWITCH)
+	target_compile_definitions(${PROJECT_NAME} PRIVATE USE_ICE)
+	# libjuice
+	option(BUILD_SHARED_LIBS "Build shared libraries" OFF)
+	option(NO_SERVER "Disable server support" ON)
+	option(NO_TESTS "Disable tests build" ON)
+	add_subdirectory(core/deps/libjuice EXCLUDE_FROM_ALL)
+	target_link_libraries(${PROJECT_NAME} PRIVATE LibJuice::LibJuiceStatic)
+
+	# websocket++
+	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/websocketpp)
+	target_compile_definitions(${PROJECT_NAME} PRIVATE ASIO_STANDALONE)
+	if (MSVC)
+		target_compile_definitions(${PROJECT_NAME} PRIVATE
+			_WEBSOCKETPP_CPP11_FUNCTIONAL_
+			_WEBSOCKETPP_CPP11_SYSTEM_ERROR_
+			_WEBSOCKETPP_CPP11_RANDOM_DEVICE_
+			_WEBSOCKETPP_CPP11_MEMORY_
+			_WEBSOCKETPP_CPP11_TYPE_TRAITS_)
+	elseif(MINGW)
+		target_compile_definitions(${PROJECT_NAME} PRIVATE _WEBSOCKETPP_CPP11_THREAD_)
+	else()
+		target_compile_definitions(${PROJECT_NAME} PRIVATE _WEBSOCKETPP_CPP11_STL_)
+	endif()
+endif()
+
+set(TINYGETTEXT_WO_ICONV ON)
+add_subdirectory(core/deps/tinygettext EXCLUDE_FROM_ALL)
+target_include_directories(${PROJECT_NAME} PRIVATE core/deps/tinygettext/include)
+target_link_libraries(${PROJECT_NAME} PRIVATE tinygettext::tinygettext)
+
+target_include_directories(${PROJECT_NAME} PRIVATE core/deps/picotcp/include core/deps/picotcp/modules)
+target_sources(${PROJECT_NAME} PRIVATE
+		core/deps/picotcp/include/arch/pico_arm9.h
+		core/deps/picotcp/include/arch/pico_atsamd21j18.h
+		core/deps/picotcp/include/arch/pico_avr.h
+		core/deps/picotcp/include/arch/pico_cortex_m.h
+		core/deps/picotcp/include/arch/pico_dos.h
+		core/deps/picotcp/include/arch/pico_esp8266.h
+		core/deps/picotcp/include/arch/pico_generic_gcc.h
+		core/deps/picotcp/include/arch/pico_linux.h
+		core/deps/picotcp/include/arch/pico_mbed.h
+		core/deps/picotcp/include/arch/pico_msp430.h
+		core/deps/picotcp/include/arch/pico_msvc.h
+		core/deps/picotcp/include/arch/pico_none.h
+		core/deps/picotcp/include/arch/pico_pic24.h
+		core/deps/picotcp/include/arch/pico_pic32.h
+		core/deps/picotcp/include/arch/pico_posix.h
+		core/deps/picotcp/include/heap.h
+		core/deps/picotcp/include/pico_addressing.h
+		core/deps/picotcp/include/pico_config.h
+		core/deps/picotcp/include/pico_constants.h
+		core/deps/picotcp/include/pico_defines.h
+		core/deps/picotcp/include/pico_defines_msvc.h
+		core/deps/picotcp/include/pico_device.h
+		core/deps/picotcp/include/pico_eth.h
+		core/deps/picotcp/include/pico_frame.h
+		core/deps/picotcp/include/pico_md5.h
+		core/deps/picotcp/include/pico_module_eth.h
+		core/deps/picotcp/include/pico_protocol.h
+		core/deps/picotcp/include/pico_queue.h
+		core/deps/picotcp/include/pico_socket.h
+		core/deps/picotcp/include/pico_socket_multicast.h
+		core/deps/picotcp/include/pico_stack.h
+		core/deps/picotcp/include/pico_tree.h
+		core/deps/picotcp/modules/pico_arp.c
+		core/deps/picotcp/modules/pico_dev_ppp.c
+		core/deps/picotcp/modules/pico_dhcp_common.c
+		core/deps/picotcp/modules/pico_dhcp_common.h
+		core/deps/picotcp/modules/pico_dhcp_server.c
+		core/deps/picotcp/modules/pico_dhcp_server.h
+		core/deps/picotcp/modules/pico_dns_client.c
+		core/deps/picotcp/modules/pico_dns_common.c
+		core/deps/picotcp/modules/pico_ethernet.c
+		core/deps/picotcp/modules/pico_fragments.c
+		core/deps/picotcp/modules/pico_icmp4.c
+		core/deps/picotcp/modules/pico_ipv4.c
+		core/deps/picotcp/modules/pico_socket_tcp.c
+		core/deps/picotcp/modules/pico_socket_udp.c
+		core/deps/picotcp/modules/pico_strings.c
+		core/deps/picotcp/modules/pico_tcp.c
+		core/deps/picotcp/modules/pico_udp.c
+		core/deps/picotcp/stack/pico_device.c
+		core/deps/picotcp/stack/pico_frame.c
+		core/deps/picotcp/stack/pico_md5.c
+		core/deps/picotcp/stack/pico_protocol.c
+		core/deps/picotcp/stack/pico_socket.c
+		core/deps/picotcp/stack/pico_socket_multicast.c
+		core/deps/picotcp/stack/pico_stack.c
+		core/deps/picotcp/stack/pico_tree.c)
+
+target_compile_definitions(${PROJECT_NAME} PRIVATE _7ZIP_ST)
+target_sources(${PROJECT_NAME} PRIVATE core/deps/lzma/7zArcIn.c core/deps/lzma/7zBuf.c core/deps/lzma/7zCrc.c core/deps/lzma/7zCrcOpt.c core/deps/lzma/7zDec.c core/deps/lzma/7zFile.c core/deps/lzma/7zStream.c core/deps/lzma/Alloc.c core/deps/lzma/Bcj2.c core/deps/lzma/Bra86.c core/deps/lzma/Bra.c core/deps/lzma/BraIA64.c core/deps/lzma/CpuArch.c core/deps/lzma/Delta.c core/deps/lzma/LzFind.c core/deps/lzma/Lzma2Dec.c core/deps/lzma/Lzma86Dec.c core/deps/lzma/Lzma86Enc.c core/deps/lzma/LzmaDec.c core/deps/lzma/LzmaEnc.c core/deps/lzma/LzmaLib.c core/deps/lzma/Sort.c)
+add_subdirectory(core/deps/libelf)
+target_link_libraries(${PROJECT_NAME} PRIVATE elf)
+if(NOT LIBRETRO)
+	target_compile_definitions(${PROJECT_NAME} PRIVATE
+		IMGUI_DISABLE_DEMO_WINDOWS
+		IMGUI_DISABLE_DEBUG_TOOLS
+		IMGUI_DEFINE_MATH_OPERATORS)
+	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/imgui core/deps/imgui/backends)
+	target_sources(${PROJECT_NAME} PRIVATE
+		core/deps/imgui/imgui.cpp
+		core/deps/imgui/imgui_demo.cpp
+		core/deps/imgui/imgui_draw.cpp
+		core/deps/imgui/imgui_cjk.cpp
+		core/deps/imgui/imgui_stdlib.cpp
+		core/deps/imgui/imgui_tables.cpp
+		core/deps/imgui/imgui_widgets.cpp)
+
+	if(ENABLE_FC_PROFILER)
+		target_include_directories(${PROJECT_NAME} PRIVATE core/deps/implot)
+		target_sources(${PROJECT_NAME} PRIVATE
+			core/deps/implot/implot.h
+			core/deps/implot/implot.cpp
+			core/deps/implot/implot_internal.h
+			core/deps/implot/implot_items.cpp)
+	endif()
+endif()
+target_sources(${PROJECT_NAME} PRIVATE core/deps/xbrz/xbrz.cpp)
+target_sources(${PROJECT_NAME} PRIVATE core/deps/md5/md5.cpp)
+
+if(USE_DISCORD AND NOT LIBRETRO)
+	option(BUILD_EXAMPLES "Build example apps" OFF)
+	add_subdirectory(core/deps/discord-rpc EXCLUDE_FROM_ALL)
+	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/discord-rpc/include)
+	target_link_libraries(${PROJECT_NAME} PRIVATE discord-rpc)
+	target_compile_definitions(${PROJECT_NAME} PRIVATE USE_DISCORD)
+endif()
+
+target_link_libraries(${PROJECT_NAME} PRIVATE flycast::res)
+
+if(LIBRETRO)
+	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/libretro-common/include)
+	target_sources(${PROJECT_NAME} PRIVATE
+		core/deps/libretro-common/memmap/memalign.c
+		core/deps/libretro-common/file/file_path.c
+		core/deps/libretro-common/vfs/vfs_implementation.c
+		core/deps/libretro-common/encodings/encoding_utf.c
+		core/deps/libretro-common/compat/compat_strl.c
+		core/deps/libretro-common/compat/fopen_utf8.c
+		core/deps/libretro-common/compat/compat_strcasestr.c
+		core/deps/libretro-common/file/retro_dirent.c
+		core/deps/libretro-common/string/stdstring.c)
+	if(USE_OPENGL)
+		target_sources(${PROJECT_NAME} PRIVATE
+			core/deps/libretro-common/glsm/glsm.c
+			core/deps/libretro-common/glsym/rglgen.c)
+		if(ANDROID OR IOS OR USE_GLES)
+			target_sources(${PROJECT_NAME} PRIVATE core/deps/libretro-common/glsym/glsym_es3.c)
+		elseif(USE_GLES2)
+			target_sources(${PROJECT_NAME} PRIVATE core/deps/libretro-common/glsym/glsym_es2.c)
+		else()
+			target_sources(${PROJECT_NAME} PRIVATE core/deps/libretro-common/glsym/glsym_gl.c)
+		endif()
+	endif()
+	target_sources(${PROJECT_NAME} PRIVATE
+		shell/libretro/audiostream.cpp
+		shell/libretro/keyboard_map.h
+		shell/libretro/libretro_core_option_defines.h
+		shell/libretro/libretro_core_options_intl.h
+		shell/libretro/libretro_core_options.h
+		shell/libretro/libretro.cpp
+		shell/libretro/LogManager.cpp
+		shell/libretro/LogManager.h
+		shell/libretro/option.cpp
+		shell/libretro/oslib.cpp
+		shell/libretro/vmu_xhair.cpp)
+	if(APPLE)
+		target_sources(${PROJECT_NAME} PRIVATE shell/libretro/oslib_apple.mm)
+	endif()
+	if(WIN32)
+		target_link_libraries(${PROJECT_NAME} PRIVATE mswsock)
+	endif()
+endif()
+
+add_subdirectory(core/archive)
+add_subdirectory(core/cfg)
+add_subdirectory(core/hw)
+add_subdirectory(core/imgread)
+add_subdirectory(core/input)
+add_subdirectory(core/log)
+add_subdirectory(core/network)
+add_subdirectory(core/oslib)
+add_subdirectory(core/audio)
+add_subdirectory(core/reios)
+add_subdirectory(core/achievements)
+add_subdirectory(core/ui)
+add_subdirectory(core/lua)
+add_subdirectory(core/profiler)
+add_subdirectory(core/wsi)
+
+include(resources/resources.cmake)
+
+if(WIN32)
+	target_sources(${PROJECT_NAME} PRIVATE
+			core/windows/comptr.h
+			core/windows/fault_handler.cpp
+			core/windows/unwind_info.cpp
+			core/windows/win_vmem.cpp)
+else()
+	target_sources(${PROJECT_NAME} PRIVATE
+			core/linux/common.cpp
+			core/linux/context.cpp
+			core/linux/posix_vmem.cpp
+			core/linux/unwind_info.cpp)
+	if(NINTENDO_SWITCH)
+		add_subdirectory(shell/switch)
+	endif()
+endif()
+
+if(NOT LIBRETRO)
+	target_sources(${PROJECT_NAME} PRIVATE
+			core/linux-dist/evdev.cpp
+			core/linux-dist/evdev.h
+			core/linux-dist/icon.h
+			core/linux-dist/x11.cpp
+			core/linux-dist/x11.h
+			core/linux-dist/x11_keyboard.h)
+endif()
+
+if(NOT LIBRETRO)
+	target_sources(${PROJECT_NAME} PRIVATE
+			core/deps/rcheevos/src/rc_client_raintegration.c
+			core/deps/rcheevos/src/rc_client.c
+			core/deps/rcheevos/src/rc_compat.c
+			core/deps/rcheevos/src/rc_util.c
+			core/deps/rcheevos/src/rc_version.c
+			core/deps/rcheevos/src/rapi/rc_api_common.c
+			core/deps/rcheevos/src/rapi/rc_api_editor.c
+			core/deps/rcheevos/src/rapi/rc_api_info.c
+			core/deps/rcheevos/src/rapi/rc_api_runtime.c
+			core/deps/rcheevos/src/rapi/rc_api_user.c
+			core/deps/rcheevos/src/rcheevos/alloc.c
+			core/deps/rcheevos/src/rcheevos/condition.c
+			core/deps/rcheevos/src/rcheevos/condset.c
+			core/deps/rcheevos/src/rcheevos/consoleinfo.c
+			core/deps/rcheevos/src/rcheevos/format.c
+			core/deps/rcheevos/src/rcheevos/lboard.c
+			core/deps/rcheevos/src/rcheevos/memref.c
+			core/deps/rcheevos/src/rcheevos/operand.c
+			core/deps/rcheevos/src/rcheevos/rc_validate.c
+			core/deps/rcheevos/src/rcheevos/richpresence.c
+			core/deps/rcheevos/src/rcheevos/runtime_progress.c
+			core/deps/rcheevos/src/rcheevos/runtime.c
+			core/deps/rcheevos/src/rcheevos/trigger.c
+			core/deps/rcheevos/src/rcheevos/value.c
+			core/deps/rcheevos/src/rhash/aes.c
+			core/deps/rcheevos/src/rhash/cdreader.c
+			core/deps/rcheevos/src/rhash/hash.c
+			core/deps/rcheevos/src/rhash/md5.c
+			core/deps/rcheevos/src/rurl/url.c)
+	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/rcheevos/include)
+	target_compile_definitions(${PROJECT_NAME} PRIVATE USE_RACHIEVEMENTS RC_DISABLE_LUA)
+endif()
+
+if(USE_OPENGL)
+	target_compile_definitions(${PROJECT_NAME} PRIVATE USE_OPENGL)
+
+	target_sources(${PROJECT_NAME} PRIVATE
+			core/rend/gles/glcache.h
+			core/rend/gles/gldraw.cpp
+			core/rend/gles/gles.cpp
+			core/rend/gles/gles.h
+			core/rend/gles/gltex.cpp
+			core/rend/gles/quad.cpp
+			core/rend/gles/postprocess.cpp
+			core/rend/gles/postprocess.h
+			core/rend/gles/naomi2.cpp
+			core/rend/gles/naomi2.h)
+
+	if(NOT LIBRETRO)
+		target_sources(${PROJECT_NAME} PRIVATE
+				core/deps/imgui/backends/imgui_impl_opengl3.cpp
+				core/deps/imgui/backends/imgui_impl_opengl3.h
+				core/rend/gles/opengl_driver.cpp
+				core/rend/gles/opengl_driver.h)
+	endif()
+
+	if(NOT (APPLE OR USE_GLES2))
+		target_sources(${PROJECT_NAME} PRIVATE
+				core/rend/gl4/abuffer.cpp
+				core/rend/gl4/gl4.h
+				core/rend/gl4/gldraw.cpp
+				core/rend/gl4/gles.cpp
+				core/rend/gl4/gl4naomi2.cpp
+				core/rend/gl4/gl4naomi2.h)
+	endif()
+endif()
+
+target_sources(${PROJECT_NAME} PRIVATE
+		core/build.h
+		core/cheats.cpp
+		core/cheats.h
+		core/emulator.h
+		core/nullDC.cpp
+		core/serialize.cpp
+		core/serialize.h
+		core/stdclass.cpp
+		core/stdclass.h
+		core/types.h
+		core/debug/gdb_server.h)
+
+target_sources(${PROJECT_NAME} PRIVATE
+		core/rend/CustomTexture.cpp
+		core/rend/CustomTexture.h
+		core/rend/osd.cpp
+		core/rend/osd.h
+		core/rend/sorter.cpp
+		core/rend/sorter.h
+		core/rend/tileclip.h
+		core/rend/TexCache.cpp
+		core/rend/TexCache.h
+		core/rend/texconv.cpp
+		core/rend/texconv.h
+		core/rend/norend/norend.cpp)
+
+if(USE_VULKAN)
+	target_compile_definitions(${PROJECT_NAME} PUBLIC VK_ENABLE_BETA_EXTENSIONS VK_NO_PROTOTYPES)
+	if(ANDROID)
+		target_compile_definitions(${PROJECT_NAME} PUBLIC VK_USE_PLATFORM_ANDROID_KHR)
+	elseif(X11_FOUND)
+		target_compile_definitions(${PROJECT_NAME} PUBLIC VK_USE_PLATFORM_XLIB_KHR)
+	elseif(WIN32)
+		target_compile_definitions(${PROJECT_NAME} PUBLIC VK_USE_PLATFORM_WIN32_KHR)
+	elseif(APPLE)
+		target_compile_definitions(${PROJECT_NAME} PUBLIC VK_USE_PLATFORM_METAL_EXT)
+	endif()
+
+	add_subdirectory(core/deps/Vulkan-Headers)
+	target_link_libraries(${PROJECT_NAME} PRIVATE Vulkan::Headers)
+
+	add_subdirectory(core/deps/VulkanMemoryAllocator)
+	target_compile_options(VulkanMemoryAllocator INTERFACE $<$<AND:$<COMPILE_LANGUAGE:CXX>,$<CXX_COMPILER_ID:AppleClang,Clang>>:-Wno-nullability-completeness>)
+	target_link_libraries(${PROJECT_NAME} PRIVATE GPUOpen::VulkanMemoryAllocator)
+
+	if(ANDROID AND NOT LIBRETRO AND "arm64" IN_LIST ARCHITECTURE)
+		add_subdirectory(core/deps/libadrenotools)
+		target_link_libraries(${PROJECT_NAME} PRIVATE adrenotools)
+	endif()
+
+	target_compile_definitions(${PROJECT_NAME} PRIVATE USE_VULKAN HAVE_VULKAN)
+	target_sources(${PROJECT_NAME} PRIVATE
+			core/rend/vulkan/oit/oit_buffer.h
+			core/rend/vulkan/oit/oit_drawer.cpp
+			core/rend/vulkan/oit/oit_drawer.h
+			core/rend/vulkan/oit/oit_pipeline.cpp
+			core/rend/vulkan/oit/oit_pipeline.h
+			core/rend/vulkan/oit/oit_renderer.cpp
+			core/rend/vulkan/oit/oit_renderpass.cpp
+			core/rend/vulkan/oit/oit_renderpass.h
+			core/rend/vulkan/oit/oit_shaders.cpp
+			core/rend/vulkan/oit/oit_shaders.h
+			core/rend/vulkan/adreno.cpp
+			core/rend/vulkan/buffer.cpp
+			core/rend/vulkan/buffer.h
+			core/rend/vulkan/commandpool.cpp
+			core/rend/vulkan/commandpool.h
+			core/rend/vulkan/compiler.cpp
+			core/rend/vulkan/compiler.h
+			core/rend/vulkan/drawer.cpp
+			core/rend/vulkan/drawer.h
+			core/rend/vulkan/pipeline.cpp
+			core/rend/vulkan/pipeline.h
+			core/rend/vulkan/quad.cpp
+			core/rend/vulkan/quad.h
+			core/rend/vulkan/shaders.cpp
+			core/rend/vulkan/shaders.h
+			core/rend/vulkan/texture.cpp
+			core/rend/vulkan/texture.h
+			core/rend/vulkan/utils.h
+			core/rend/vulkan/vmallocator.cpp
+			core/rend/vulkan/vmallocator.h
+			core/rend/vulkan/overlay.cpp
+			core/rend/vulkan/overlay.h
+			core/rend/vulkan/vulkan_context.h
+			core/rend/vulkan/vulkan.h
+			core/rend/vulkan/vulkan_renderer.cpp)
+	if(LIBRETRO)
+		target_sources(${PROJECT_NAME} PRIVATE
+				core/rend/vulkan/vk_context_lr.cpp
+				core/rend/vulkan/vk_context_lr.h)
+	else()
+		target_compile_definitions(${PROJECT_NAME} PUBLIC IMGUI_IMPL_VULKAN_NO_PROTOTYPES)
+		target_sources(${PROJECT_NAME} PRIVATE
+				core/rend/vulkan/vulkan_driver.h
+				core/rend/vulkan/vulkan_context.cpp
+				core/deps/imgui/backends/imgui_impl_vulkan.cpp
+				core/deps/imgui/backends/imgui_impl_vulkan.h)
+		if(CMAKE_SIZEOF_VOID_P EQUAL 4)
+			target_compile_definitions(${PROJECT_NAME} PRIVATE ImTextureID=ImU64)
+		endif()
+	endif()
+endif()
+
+if(WIN32 AND USE_DX9 AND NOT LIBRETRO AND NOT WINDOWS_STORE AND ("x86" IN_LIST ARCHITECTURE OR "x86_64" IN_LIST ARCHITECTURE))
+	set(REND_DX9_FILES
+		core/rend/dx9/d3d_overlay.h
+		core/rend/dx9/d3d_overlay.cpp
+		core/rend/dx9/d3d_renderer.h
+		core/rend/dx9/d3d_renderer.cpp
+		core/rend/dx9/d3d_shaders.h
+		core/rend/dx9/d3d_shaders.cpp
+		core/rend/dx9/d3d_texture.h
+		core/rend/dx9/d3d_texture.cpp
+		core/rend/dx9/dx9_driver.h
+		core/rend/dx9/dxcontext.cpp
+		core/rend/dx9/dxcontext.h
+		core/deps/imgui/backends/imgui_impl_dx9.h
+		core/deps/imgui/backends/imgui_impl_dx9.cpp)
+	target_sources(${PROJECT_NAME} PRIVATE ${REND_DX9_FILES})
+
+	if(NOT MINGW)
+		set_source_files_properties(${REND_DX9_FILES} PROPERTIES INCLUDE_DIRECTORIES "$ENV{DXSDK_DIR}/Include")
+	endif()
+	target_compile_definitions(${PROJECT_NAME} PRIVATE USE_DX9)
+endif()
+
+if(WIN32 AND USE_DX11)
+	if(NOT LIBRETRO)
+		target_sources(${PROJECT_NAME} PRIVATE
+			core/deps/imgui/backends/imgui_impl_dx11.cpp
+			core/deps/imgui/backends/imgui_impl_dx11.h)
+	endif()
+	target_sources(${PROJECT_NAME} PRIVATE
+		core/rend/dx11/dx11_driver.h
+		core/rend/dx11/dx11_overlay.cpp
+		core/rend/dx11/dx11_overlay.h
+		core/rend/dx11/dx11_renderer.cpp
+		core/rend/dx11/dx11_renderer.h
+		core/rend/dx11/dx11_renderstate.h
+		core/rend/dx11/dx11_renderstate.cpp
+		core/rend/dx11/dx11_shaders.cpp
+		core/rend/dx11/dx11_shaders.h
+		core/rend/dx11/dx11_texture.cpp
+		core/rend/dx11/dx11_texture.h
+		core/rend/dx11/dx11context.cpp
+		core/rend/dx11/dx11context.h
+		core/rend/dx11/dx11context_lr.cpp
+		core/rend/dx11/dx11context_lr.h
+		core/rend/dx11/dx11_driver.h
+		core/rend/dx11/dx11_naomi2.cpp
+		core/rend/dx11/dx11_naomi2.h
+		core/rend/dx11/oit/dx11_oitbuffers.h
+		core/rend/dx11/oit/dx11_oitrenderer.cpp
+		core/rend/dx11/oit/dx11_oitshaders.cpp
+		core/rend/dx11/oit/dx11_oitshaders.h)
+
+	target_compile_definitions(${PROJECT_NAME} PRIVATE HAVE_D3D11)
+	target_link_libraries(${PROJECT_NAME} PRIVATE d3d11 d3dcompiler dxgi)
+endif()
+
+if(ENABLE_GDB_SERVER)
+
+	target_sources(${PROJECT_NAME} PRIVATE
+		core/debug/gdb_server.cpp)
+
+	target_compile_definitions(${PROJECT_NAME} PRIVATE GDB_SERVER)
+endif()
+
+if("arm" IN_LIST ARCHITECTURE AND NOT APPLE)
+	if(MSVC)
+		target_compile_options(${PROJECT_NAME} PRIVATE "/Zc:__cplusplus")
+	endif()
+	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/vixl)
+	target_sources(${PROJECT_NAME} PRIVATE
+		core/rec-ARM/rec_arm.cpp
+		core/deps/vixl/aarch32/location-aarch32.cc
+		core/deps/vixl/aarch32/location-aarch32.h
+		core/deps/vixl/aarch32/assembler-aarch32.cc
+		core/deps/vixl/aarch32/assembler-aarch32.h
+		core/deps/vixl/aarch32/instructions-aarch32.cc
+		core/deps/vixl/aarch32/instructions-aarch32.h
+		core/deps/vixl/aarch32/constants-aarch32.cc
+		core/deps/vixl/aarch32/constants-aarch32.h
+		core/deps/vixl/aarch32/macro-assembler-aarch32.cc
+		core/deps/vixl/aarch32/macro-assembler-aarch32.h
+		core/deps/vixl/aarch32/operands-aarch32.cc
+		core/deps/vixl/aarch32/operands-aarch32.h
+		core/deps/vixl/assembler-base-vixl.h
+		core/deps/vixl/code-buffer-vixl.cc
+		core/deps/vixl/code-buffer-vixl.h
+		core/deps/vixl/code-generation-scopes-vixl.h
+		core/deps/vixl/compiler-intrinsics-vixl.cc
+		core/deps/vixl/compiler-intrinsics-vixl.h
+		core/deps/vixl/cpu-features.cc
+		core/deps/vixl/cpu-features.h
+		core/deps/vixl/globals-vixl.h
+		core/deps/vixl/invalset-vixl.h
+		core/deps/vixl/macro-assembler-interface.h
+		core/deps/vixl/platform-vixl.h
+		core/deps/vixl/pool-manager.h
+		core/deps/vixl/pool-manager-impl.h
+		core/deps/vixl/utils-vixl.cc
+		core/deps/vixl/utils-vixl.h)
+endif()
+if("arm64" IN_LIST ARCHITECTURE)
+	if(MSVC)
+		target_compile_options(${PROJECT_NAME} PRIVATE "/Zc:__cplusplus")
+	endif()
+	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/vixl)
+	target_sources(${PROJECT_NAME} PRIVATE
+		core/deps/vixl/aarch64/abi-aarch64.h
+		core/deps/vixl/aarch64/assembler-aarch64.cc
+		core/deps/vixl/aarch64/assembler-aarch64.h
+		core/deps/vixl/aarch64/assembler-sve-aarch64.cc
+		core/deps/vixl/aarch64/constants-aarch64.h
+		core/deps/vixl/aarch64/instructions-aarch64.cc
+		core/deps/vixl/aarch64/instructions-aarch64.h
+		core/deps/vixl/aarch64/macro-assembler-aarch64.cc
+		core/deps/vixl/aarch64/macro-assembler-aarch64.h
+		core/deps/vixl/aarch64/macro-assembler-sve-aarch64.cc
+		core/deps/vixl/aarch64/operands-aarch64.cc
+		core/deps/vixl/aarch64/operands-aarch64.h
+		core/deps/vixl/aarch64/registers-aarch64.cc
+		core/deps/vixl/aarch64/registers-aarch64.h
+		core/deps/vixl/aarch64/pointer-auth-aarch64.cc
+		core/deps/vixl/aarch64/simulator-constants-aarch64.h
+		core/deps/vixl/assembler-base-vixl.h
+		core/deps/vixl/code-buffer-vixl.cc
+		core/deps/vixl/code-buffer-vixl.h
+		core/deps/vixl/code-generation-scopes-vixl.h
+		core/deps/vixl/compiler-intrinsics-vixl.cc
+		core/deps/vixl/compiler-intrinsics-vixl.h
+		core/deps/vixl/cpu-features.cc
+		core/deps/vixl/cpu-features.h
+		core/deps/vixl/globals-vixl.h
+		core/deps/vixl/invalset-vixl.h
+		core/deps/vixl/macro-assembler-interface.h
+		core/deps/vixl/platform-vixl.h
+		core/deps/vixl/pool-manager.h
+		core/deps/vixl/pool-manager-impl.h
+		core/deps/vixl/utils-vixl.cc
+		core/deps/vixl/utils-vixl.h)
+	target_sources(${PROJECT_NAME} PRIVATE core/rec-ARM64/rec_arm64.cpp core/rec-ARM64/arm64_regalloc.h)
+endif()
+if("x86" IN_LIST ARCHITECTURE OR "x86_64" IN_LIST ARCHITECTURE)
+	add_subdirectory(core/deps/xbyak EXCLUDE_FROM_ALL)
+	target_link_libraries(${PROJECT_NAME} PRIVATE xbyak::xbyak)
+	if(CMAKE_SIZEOF_VOID_P EQUAL 4)
+		target_sources(${PROJECT_NAME} PRIVATE
+			core/rec-x64/xbyak_base.h
+			core/rec-x86/rec_x86.h
+			core/rec-x86/x86_regalloc.h
+			core/rec-x86/rec_x86.cpp
+			core/rec-x86/x86_ops.cpp)
+	elseif(CMAKE_SIZEOF_VOID_P EQUAL 8)
+		target_sources(${PROJECT_NAME} PRIVATE
+			core/rec-x64/xbyak_base.h
+			core/rec-x64/rec_x64.cpp
+			core/rec-x64/x64_regalloc.h)
+	endif()
+endif()
+if(EMSCRIPTEN)
+	target_sources(${PROJECT_NAME} PRIVATE core/rec-wasm/rec_wasm.cpp)
+endif()
+
+if((USE_OPENGL OR USE_GLES2 OR USE_GLES) AND NOT LIBRETRO)
+	add_library(glad STATIC core/deps/glad/src/gl.c)
+	if(NOT APPLE AND NOT WIN32 AND NOT SDL2_FOUND)
+		# When SDL2 is not found, we can use EGL with ANativeWindow (Android) or X11
+		target_sources(glad PRIVATE core/deps/glad/src/egl.c)
+	endif()
+	target_include_directories(glad PUBLIC core/deps/glad/include)
+	target_link_libraries(${PROJECT_NAME} PRIVATE glad)
+endif()
+
+if(NOT LIBRETRO)
+	target_include_directories(${PROJECT_NAME} PRIVATE core/deps/ggpo/include core/deps/ggpo/lib/ggpo)
+	target_sources(${PROJECT_NAME} PRIVATE
+		core/deps/ggpo/lib/ggpo/bitvector.cpp
+		core/deps/ggpo/lib/ggpo/bitvector.h
+		core/deps/ggpo/lib/ggpo/game_input.cpp
+		core/deps/ggpo/lib/ggpo/game_input.h
+		core/deps/ggpo/lib/ggpo/input_queue.cpp
+		core/deps/ggpo/lib/ggpo/input_queue.h
+		core/deps/ggpo/lib/ggpo/main.cpp
+		core/deps/ggpo/lib/ggpo/platform_linux.cpp
+		core/deps/ggpo/lib/ggpo/platform_linux.h
+		core/deps/ggpo/lib/ggpo/platform_windows.cpp
+		core/deps/ggpo/lib/ggpo/platform_windows.h
+		core/deps/ggpo/lib/ggpo/poll.cpp
+		core/deps/ggpo/lib/ggpo/ggpo_poll.h
+		core/deps/ggpo/lib/ggpo/ring_buffer.h
+		core/deps/ggpo/lib/ggpo/static_buffer.h
+		core/deps/ggpo/lib/ggpo/sync.cpp
+		core/deps/ggpo/lib/ggpo/sync.h
+		core/deps/ggpo/lib/ggpo/timesync.cpp
+		core/deps/ggpo/lib/ggpo/timesync.h
+		core/deps/ggpo/lib/ggpo/ggpo_types.h
+
+		core/deps/ggpo/lib/ggpo/backends/backend.h
+		core/deps/ggpo/lib/ggpo/backends/p2p.cpp
+		core/deps/ggpo/lib/ggpo/backends/p2p.h
+		core/deps/ggpo/lib/ggpo/backends/spectator.cpp
+		core/deps/ggpo/lib/ggpo/backends/spectator.h
+		core/deps/ggpo/lib/ggpo/backends/synctest.cpp
+		core/deps/ggpo/lib/ggpo/backends/synctest.h
+
+		core/deps/ggpo/lib/ggpo/network/udp_msg.h
+		core/deps/ggpo/lib/ggpo/network/udp_proto.cpp
+		core/deps/ggpo/lib/ggpo/network/udp_proto.h
+		core/deps/ggpo/lib/ggpo/network/udp.cpp
+		core/deps/ggpo/lib/ggpo/network/udp.h)
+
+	if(ANDROID)
+		target_compile_definitions(${PROJECT_NAME} PRIVATE GLES GLES3)
+		add_subdirectory(shell/android-studio/flycast/src/main/jni/src)
+		target_link_libraries(${PROJECT_NAME} PRIVATE android log)
+
+	elseif(APPLE)
+		string(TIMESTAMP YEAR "%Y")
+		string(REGEX MATCH "^[^-]+" TAG_VERSION ${GIT_VERSION})
+		if(IOS)
+			set_property(TARGET ${PROJECT_NAME} PROPERTY XCODE_ATTRIBUTE_SWIFT_VERSION "5.0")
+			add_subdirectory(shell/apple/emulator-ios/AltKit)
+			target_link_libraries(${PROJECT_NAME} PRIVATE AltKit)
+
+			target_sources(${PROJECT_NAME} PRIVATE
+					shell/apple/common/http_client.mm
+					shell/apple/common/util.mm
+					shell/apple/emulator-ios/emulator/AppDelegate.h
+					shell/apple/emulator-ios/emulator/AppDelegate.mm
+					shell/apple/emulator-ios/emulator/ios_main.mm
+					shell/apple/emulator-ios/emulator/ios_gamepad.h
+					shell/apple/emulator-ios/emulator/ios_keyboard.h
+					shell/apple/emulator-ios/emulator/ios_mouse.h
+					shell/apple/emulator-ios/emulator/FlycastViewController.h
+					shell/apple/emulator-ios/emulator/FlycastViewController.mm
+					shell/apple/emulator-ios/emulator/PadViewController.h
+					shell/apple/emulator-ios/emulator/PadViewController.mm
+					shell/apple/emulator-ios/emulator/EditPadViewController.h
+					shell/apple/emulator-ios/emulator/EditPadViewController.mm
+					shell/apple/emulator-ios/emulator/EmulatorView.h
+					shell/apple/emulator-ios/emulator/EmulatorView.mm
+					shell/apple/emulator-ios/emulator/main.m
+					shell/apple/emulator-ios/emulator/iCade-iOS/iCadeReaderView.h
+					shell/apple/emulator-ios/emulator/iCade-iOS/iCadeReaderView.m
+					shell/apple/emulator-ios/emulator/iCade-iOS/iCadeState.h)
+			target_compile_options(${PROJECT_NAME} PRIVATE $<$<COMPILE_LANGUAGE:CXX>:-fobjc-arc -fmodules>)
+			set_source_files_properties(shell/apple/emulator-ios/emulator/FlycastViewController.mm PROPERTIES COMPILE_OPTIONS -fcxx-modules)
+			set_source_files_properties(shell/apple/emulator-ios/emulator/iCade-iOS/iCadeReaderView.m PROPERTIES COMPILE_OPTIONS -fno-objc-arc)
+
+			set(IOS_RESOURCES
+				shell/apple/emulator-ios/emulator/Images.xcassets
+				shell/apple/emulator-ios/emulator/FlycastStoryboard.storyboard
+				shell/apple/emulator-ios/emulator/LaunchScreen.storyboard
+				shell/apple/emulator-ios/emulator/PadViewController.xib
+				shell/apple/emulator-ios/emulator/EditPadViewController.xib)
+			target_sources(${PROJECT_NAME} PRIVATE ${IOS_RESOURCES})
+			source_group("Resources" FILES ${IOS_RESOURCES})
+			set_source_files_properties(${IOS_RESOURCES} PROPERTIES MACOSX_PACKAGE_LOCATION "Resources")
+
+			set_target_properties(${PROJECT_NAME} PROPERTIES
+				OUTPUT_NAME "Flycast"
+				MACOSX_BUNDLE YES
+				MACOSX_BUNDLE_EXECUTABLE_NAME "Flycast"
+				MACOSX_BUNDLE_INFO_STRING ""
+				MACOSX_BUNDLE_GUI_IDENTIFIER "com.flyinghead.Flycast"
+				MACOSX_BUNDLE_BUNDLE_NAME "com.flyinghead.Flycast"
+				MACOSX_BUNDLE_LONG_VERSION_STRING "${GIT_VERSION}"
+				MACOSX_BUNDLE_SHORT_VERSION_STRING "${TAG_VERSION}"
+				MACOSX_BUNDLE_BUNDLE_VERSION "${GIT_HASH}"
+				MACOSX_BUNDLE_COPYRIGHT "Copyright  ${YEAR} Flycast contributors. All rights reserved."
+				MACOSX_BUNDLE_INFO_PLIST ${CMAKE_CURRENT_SOURCE_DIR}/shell/apple/emulator-ios/plist.in
+
+				XCODE_ATTRIBUTE_DEBUG_INFORMATION_FORMAT "dwarf-with-dsym"
+				XCODE_ATTRIBUTE_GCC_PREFIX_HEADER "${CMAKE_CURRENT_SOURCE_DIR}/shell/apple/emulator-ios/emulator/flycast-ios-Prefix.pch"
+				XCODE_ATTRIBUTE_GCC_PRECOMPILE_PREFIX_HEADER "YES"
+				XCODE_ATTRIBUTE_CODE_SIGNING_ALLOWED "NO"
+				XCODE_ATTRIBUTE_CODE_SIGN_IDENTITY ""
+				XCODE_ATTRIBUTE_TARGETED_DEVICE_FAMILY "1,2"
+				XCODE_ATTRIBUTE_CLANG_ENABLE_OBJC_ARC YES
+				XCODE_ATTRIBUTE_COMBINE_HIDPI_IMAGES NO
+				XCODE_ATTRIBUTE_ASSETCATALOG_COMPILER_APPICON_NAME "AppIcon"
+				XCODE_ATTRIBUTE_PRODUCT_BUNDLE_IDENTIFIER "com.flyinghead.Flycast")
+
+			find_library(UIKIT UIKit)
+			find_library(FOUNDATION Foundation)
+			find_library(GLKIT GLKit)
+			find_library(GAMECONTROLLER GameController)
+			find_library(AUDIOTOOLBOX AudioToolbox)
+			find_library(AVFOUNDATION AVFoundation)
+			target_link_libraries(${PROJECT_NAME} PRIVATE
+				${UIKIT}
+				${FOUNDATION}
+				${GLKIT}
+				${GAMECONTROLLER}
+				${AUDIOTOOLBOX}
+				${AVFOUNDATION})
+
+			add_custom_target(Flycast.IPA ALL
+				DEPENDS ${PROJECT_NAME}
+				COMMENT "Building IPA"
+				COMMAND mkdir -p ${CMAKE_CURRENT_BINARY_DIR}/Payload
+				COMMAND rm -rf ${CMAKE_CURRENT_BINARY_DIR}/Payload/*
+				COMMAND cp -r ${CMAKE_CURRENT_BINARY_DIR}/$<CONFIG>-${CMAKE_OSX_SYSROOT}/Flycast.app ${CMAKE_CURRENT_BINARY_DIR}/Payload
+				COMMAND for lib in ${CMAKE_CURRENT_BINARY_DIR}/Payload/Flycast.app/Frameworks/*.dylib
+				COMMAND do xcrun bitcode_strip -r $lib -o $lib
+				COMMAND done
+				COMMAND ldid -S${CMAKE_CURRENT_SOURCE_DIR}/shell/apple/emulator-ios/emulator/flycast.entitlements ${CMAKE_CURRENT_BINARY_DIR}/Payload/Flycast.app/Flycast
+				COMMAND ${CMAKE_COMMAND} -E tar "cfv" "${CMAKE_CURRENT_BINARY_DIR}/$<CONFIG>-${CMAKE_OSX_SYSROOT}/Flycast.ipa" --format=zip ${CMAKE_CURRENT_BINARY_DIR}/Payload)
+		else()
+
+			add_subdirectory(core/deps/Syphon)
+			target_link_libraries(${PROJECT_NAME} PRIVATE Syphon)
+			add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
+				COMMAND ${CMAKE_COMMAND} -E copy ${SYPHON_METALLIB}
+				$<TARGET_FILE_DIR:flycast>/../Resources/)
+			target_compile_definitions(${PROJECT_NAME} PRIVATE VIDEO_ROUTING)
+
+			target_sources(${PROJECT_NAME} PRIVATE
+					shell/apple/common/http_client.mm
+					shell/apple/common/util.mm
+					shell/apple/emulator-osx/emulator-osx/SDLApplicationDelegate.h
+					shell/apple/emulator-osx/emulator-osx/SDLApplicationDelegate.mm
+					shell/apple/emulator-osx/emulator-osx/osx-main.mm)
+			set(ASSETS shell/apple/emulator-osx/emulator-osx/Images.xcassets)
+			target_sources(${PROJECT_NAME} PRIVATE ${ASSETS})
+			source_group("Resources" FILES ${ASSETS})
+			set_source_files_properties(${ASSETS} PROPERTIES MACOSX_PACKAGE_LOCATION "Resources")
+
+			set_target_properties(${PROJECT_NAME} PROPERTIES
+				OUTPUT_NAME "Flycast"
+				MACOSX_BUNDLE_INFO_PLIST ${CMAKE_CURRENT_SOURCE_DIR}/shell/apple/emulator-osx/MacOSXBundleInfo.plist.in
+				MACOSX_BUNDLE_EXECUTABLE_NAME "Flycast"
+				MACOSX_BUNDLE_INFO_STRING ""
+				MACOSX_BUNDLE_ICON_FILE "AppIcon"
+				MACOSX_BUNDLE_GUI_IDENTIFIER "com.flyinghead.Flycast"
+				MACOSX_BUNDLE_LONG_VERSION_STRING "${GIT_VERSION}"
+				MACOSX_BUNDLE_SHORT_VERSION_STRING "${TAG_VERSION}"
+				MACOSX_BUNDLE_BUNDLE_VERSION "${GIT_HASH}"
+				MACOSX_BUNDLE_BUNDLE_NAME "Flycast"
+				MACOSX_BUNDLE_COPYRIGHT "Copyright  ${YEAR} Flycast contributors. All rights reserved."
+				XCODE_ATTRIBUTE_DEBUG_INFORMATION_FORMAT "dwarf"
+				XCODE_ATTRIBUTE_DEBUG_INFORMATION_FORMAT[variant=RelWithDebInfo] "dwarf-with-dsym"
+				XCODE_ATTRIBUTE_CLANG_DEBUG_INFORMATION_LEVEL[variant=RelWithDebInfo] "line-tables-only"
+				XCODE_ATTRIBUTE_DEPLOYMENT_POSTPROCESSING[variant=RelWithDebInfo] YES
+				XCODE_ATTRIBUTE_ASSETCATALOG_COMPILER_APPICON_NAME "AppIcon"
+				XCODE_ATTRIBUTE_PRODUCT_BUNDLE_IDENTIFIER "com.flyinghead.Flycast"
+				BUILD_WITH_INSTALL_RPATH TRUE
+				INSTALL_RPATH "@loader_path/../Frameworks"
+			)
+
+			find_library(AUDIO_UNIT_LIBRARY AudioUnit)
+			find_library(FOUNDATION_LIBRARY Foundation)
+			find_library(AUDIO_TOOLBOX_LIBRARY AudioToolbox)
+			find_library(METAL_LIBRARY Metal)
+			find_library(IOSURFACE_LIBRARY IOSurface)
+			find_library(MULTITOUCH_SUPPORT_LIBRARY MultitouchSupport /System/Library/PrivateFrameworks)
+
+			target_link_libraries(${PROJECT_NAME} PRIVATE
+				${AUDIO_UNIT_LIBRARY}
+				${FOUNDATION_LIBRARY}
+				${AUDIO_TOOLBOX_LIBRARY}
+				${METAL_LIBRARY}
+				${IOSURFACE_LIBRARY}
+				${MULTITOUCH_SUPPORT_LIBRARY})
+
+			add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
+				COMMAND ${CMAKE_COMMAND} -E copy "$ENV{VULKAN_SDK}/lib/libMoltenVK.dylib"
+				$<TARGET_FILE_DIR:flycast>/../Frameworks/libvulkan.dylib)
+		endif()
+	elseif(UNIX)
+		if(NOT BUILD_TESTING)
+			target_sources(${PROJECT_NAME} PRIVATE
+					core/linux-dist/main.cpp)
+		endif()
+	elseif(WIN32)
+		target_sources(${PROJECT_NAME} PRIVATE
+			core/windows/rawinput.cpp
+			core/windows/rawinput.h)
+		if(NOT BUILD_TESTING)
+			target_sources(${PROJECT_NAME} PRIVATE core/windows/winmain.cpp)
+		endif()
+		if(WINDOWS_STORE)
+			file(READ shell/uwp/Package.appxmanifest MANIFEST)
+			string(REPLACE "9.9.9.9" ${MS_VERSION} MANIFEST ${MANIFEST})
+			file(WRITE ${CMAKE_BINARY_DIR}/Package.appxmanifest ${MANIFEST})
+			set(ResourceFiles ${CMAKE_BINARY_DIR}/Package.appxmanifest
+					shell/uwp/flycast150.png
+					shell/uwp/flycast50.png
+					shell/uwp/flycast44.png
+					shell/uwp/splash.png
+					shell/uwp/flycast44.targetsize-48_altform-unplated.png
+					shell/uwp/flycast44.targetsize-48_altform-lightunplated.png
+					core/deps/SDL/src/main/winrt/SDL2-WinRTResource_BlankCursor.cur
+					core/deps/SDL/src/main/winrt/SDL2-WinRTResources.rc)
+			target_sources(${PROJECT_NAME} PRIVATE
+				${ResourceFiles}
+				shell/uwp/http_client.cpp)
+			if(NOT BUILD_TESTING)
+				target_sources(${PROJECT_NAME} PRIVATE core/deps/SDL/src/main/winrt/SDL_winrt_main_NonXAML.cpp)
+			endif()
+			set_target_properties(${PROJECT_NAME} PROPERTIES RESOURCE "${ResourceFiles}")
+		else()
+			if(NOT BUILD_TESTING AND ("x86" IN_LIST ARCHITECTURE OR "x86_64" IN_LIST ARCHITECTURE))
+				target_include_directories(${PROJECT_NAME} PRIVATE core/deps/Spout/SPOUTSDK/SpoutGL)
+				target_include_directories(${PROJECT_NAME} PRIVATE core/deps/Spout/SPOUTSDK/SpoutDirectX/SpoutDX)
+				SET(SPOUT_BUILD_CMT OFF CACHE BOOL "For Visual Studio - build /MT to link runtime libraries" FORCE)
+				SET(SPOUT_BUILD_SPOUTDX ON CACHE BOOL "Build SpoutDX DirectX11 support library" FORCE)
+				SET(SPOUT_BUILD_LIBRARY OFF CACHE BOOL "Build C-compatible cross compiler library" FORCE)
+				SET(SKIP_INSTALL_ALL ON CACHE BOOL "Install headers and libraries" FORCE)
+				add_subdirectory(core/deps/Spout)
+				target_link_libraries(${PROJECT_NAME} PRIVATE Spout_static SpoutDX_static)
+				target_compile_definitions(${PROJECT_NAME} PRIVATE VIDEO_ROUTING)
+			endif()
+
+			target_sources(${PROJECT_NAME} PRIVATE shell/windows/flycast.rc)
+			target_link_libraries(${PROJECT_NAME} PRIVATE dsound winmm ws2_32 wsock32 xinput9_1_0 cfgmgr32 wininet psapi setupapi)
+		endif()
+	endif()
+endif()
+
+if(BUILD_TESTING)
+	add_subdirectory(core/deps/googletest EXCLUDE_FROM_ALL)
+	add_subdirectory(tests)
+endif()
+
+if(NINTENDO_SWITCH)
+	if(LIBRETRO)
+		add_custom_target(combined ALL
+			COMMAND ${CMAKE_AR} -x $<TARGET_FILE:xxHash::xxhash>
+			COMMAND ${CMAKE_AR} -x $<TARGET_FILE:chdr-static>
+			COMMAND ${CMAKE_AR} -x $<TARGET_FILE:zip>
+			COMMAND ${CMAKE_AR} -x $<TARGET_FILE:elf>
+			COMMAND ${CMAKE_AR} -x $<TARGET_FILE:flycast::res>
+			COMMAND ${CMAKE_AR} -rs flycast_libretro_libnx.a *.o
+			COMMAND rm *.o
+			WORKING_DIRECTORY ${CMAKE_BINARY_DIR}/${CMAKE_ARCHIVE_OUTPUT_DIRECTORY}
+			DEPENDS xxHash::xxhash chdr-static zip ${PROJECT_NAME})
+	else()
+		nx_generate_nacp(flycast.nacp NAME "Flycast" AUTHOR "flyinghead, M4xw" VERSION "${GIT_VERSION}")
+		nx_create_nro(flycast NACP flycast.nacp ICON "${CMAKE_SOURCE_DIR}/shell/switch/flycast.jpeg")
+	endif()
+endif()
+
+if(IOS)
+	install(FILES "${CMAKE_CURRENT_BINARY_DIR}/$<CONFIG>-${CMAKE_OSX_SYSROOT}/Flycast.ipa" TYPE BIN)
+elseif(NINTENDO_SWITCH AND NOT LIBRETRO)
+	install(FILES ${CMAKE_BINARY_DIR}/flycast.nro DESTINATION "${CMAKE_INSTALL_BINDIR}")
+elseif(LIBRETRO)
+	install(TARGETS ${PROJECT_NAME} DESTINATION "${CMAKE_INSTALL_LIBDIR}/libretro")
+else()
+	install(TARGETS ${PROJECT_NAME} DESTINATION "${CMAKE_INSTALL_BINDIR}")
+endif()
+
+if(UNIX AND NOT APPLE AND NOT ANDROID AND NOT LIBRETRO)
+	install(FILES shell/linux/man/${PROJECT_NAME}.1
+		DESTINATION "${CMAKE_INSTALL_MANDIR}/man1"
+	)
+	install(FILES shell/linux/${PROJECT_NAME}.desktop
+		DESTINATION "${CMAKE_INSTALL_DATAROOTDIR}/applications"
+	)
+	install(FILES shell/linux/${PROJECT_NAME}.png
+		DESTINATION "${CMAKE_INSTALL_DATAROOTDIR}/pixmaps"
+	)
+	install(FILES shell/linux/org.${PROJECT_NAME}.Flycast.metainfo.xml
+		DESTINATION "${CMAKE_INSTALL_DATAROOTDIR}/metainfo"
+	)
+	foreach(size 16 32 64 128 256 512)
+		install(FILES
+			shell/apple/emulator-osx/emulator-osx/Images.xcassets/AppIcon.appiconset/Icon-${size}.png
+			DESTINATION
+			"${CMAKE_INSTALL_DATAROOTDIR}/icons/hicolor/${size}x${size}/apps"
+			RENAME ${PROJECT_NAME}.png
+		)
+	endforeach()
+endif()
+
+if(${CMAKE_GENERATOR} MATCHES "^Xcode.*|^Visual Studio.*")
+	file(GLOB_RECURSE SRC_FILES *.h *.cpp *.c *.cc *.mm)
+	source_group(TREE ${CMAKE_CURRENT_SOURCE_DIR} FILES ${SRC_FILES})
+endif()
diff --git a/core/build.h b/core/build.h
index 6ea5355..30ac654 100755
--- a/core/build.h
+++ b/core/build.h
@@ -1,127 +1,134 @@
-#pragma once
-//#define STRICT_MODE
-#ifndef STRICT_MODE
-#define FAST_MMU
-#define USE_WINCE_HACK
-#endif
-
-#define DC_PLATFORM_DREAMCAST   0
-#define DC_PLATFORM_DEV_UNIT    1
-#define DC_PLATFORM_NAOMI       2
-#define DC_PLATFORM_NAOMI2      3
-#define DC_PLATFORM_ATOMISWAVE  4
-#define DC_PLATFORM_SYSTEMSP    5
-
-//HOST_CPU
-#define CPU_X86      0x20000001
-#define CPU_ARM      0x20000002
-#define CPU_ARM64    0x20000003
-#define CPU_X64      0x20000004
-
-//FEAT_SHREC, FEAT_AREC, FEAT_DSPREC
-#define DYNAREC_NONE	0x40000001
-#define DYNAREC_JIT		0x40000002
-
-//automatic
-
-#if defined(__x86_64__) || defined(_M_X64)
-	#define HOST_CPU CPU_X64
-#elif defined(__i386__) || defined(_M_IX86)
-	#define HOST_CPU CPU_X86
-#elif defined(__arm__) || defined (_M_ARM)
-	#define HOST_CPU CPU_ARM
-#elif defined(__aarch64__) || defined(_M_ARM64)
-	#define HOST_CPU CPU_ARM64
-#else
-	#error Unsupported architecture
-#endif
-
-#if defined(__APPLE__)
-#include "TargetConditionals.h"
-#if TARGET_OS_SIMULATOR
-// iOS simulator
-#define TARGET_NO_REC
-#endif
-#if defined(TARGET_MAC) && HOST_CPU == CPU_ARM64
-#define TARGET_ARM_MAC
-#endif
-#endif
-
-#if defined(TARGET_NO_REC)
-#define FEAT_SHREC DYNAREC_NONE
-#define FEAT_AREC DYNAREC_NONE
-#define FEAT_DSPREC DYNAREC_NONE
-#endif
-
-#if defined(TARGET_NO_AREC)
-#define FEAT_SHREC DYNAREC_JIT
-#define FEAT_AREC DYNAREC_NONE
-#define FEAT_DSPREC DYNAREC_NONE
-#endif
-
-#ifdef __SWITCH__
-#define FEAT_NO_RWX_PAGES
-#endif
-
-//defaults
-
-#ifndef FEAT_SHREC
-	#if HOST_CPU == CPU_ARM || HOST_CPU == CPU_ARM64 || HOST_CPU == CPU_X86 || HOST_CPU == CPU_X64
-		#define FEAT_SHREC DYNAREC_JIT
-	#else
-		#define FEAT_SHREC DYNAREC_NONE
-	#endif
-#endif
-
-#ifndef FEAT_AREC
-	#if HOST_CPU == CPU_ARM || HOST_CPU == CPU_ARM64 || HOST_CPU == CPU_X64
-		#define FEAT_AREC DYNAREC_JIT
-	#else
-		#define FEAT_AREC DYNAREC_NONE
-	#endif
-#endif
-
-#ifndef FEAT_DSPREC
-	#if HOST_CPU == CPU_ARM || HOST_CPU == CPU_ARM64 || HOST_CPU == CPU_X86 || HOST_CPU == CPU_X64
-		#define FEAT_DSPREC DYNAREC_JIT
-	#else
-		#define FEAT_DSPREC DYNAREC_NONE
-	#endif
-#endif
-
-// Some restrictions on FEAT_NO_RWX_PAGES
-#if defined(FEAT_NO_RWX_PAGES) && FEAT_SHREC == DYNAREC_JIT
-#if HOST_CPU != CPU_X64 && HOST_CPU != CPU_ARM64
-#error "FEAT_NO_RWX_PAGES Only implemented for X64 and ARMv8"
-#endif
-#endif
-
-#ifdef _WIN32
-#if defined(WINAPI_FAMILY) && (WINAPI_FAMILY == WINAPI_FAMILY_APP)
-#define TARGET_UWP 1
-#endif
-#ifdef HAVE_D3D11
-#define USE_DX11
-#endif
-#endif
-
-#if !defined(LIBRETRO)
-#define USE_GGPO
-#endif
-
-#if !defined(__ANDROID__) && !defined(TARGET_IPHONE) && !defined(TARGET_UWP) \
-	&& !defined(__SWITCH__) && !defined(LIBRETRO) && !defined(__NetBSD__) && !defined(__OpenBSD__)
-#define NAOMI_MULTIBOARD
-#endif
-
-// TARGET PLATFORM
-#define GD_CLOCK 33868800						//GDROM XTAL -- 768fs
-#define AICA_CORE_CLOCK (GD_CLOCK * 4 / 3)		//[45158400]  GD->PLL 3:4 -> AICA CORE	 -- 1024fs
-#define AICA_ARM_CLOCK (AICA_CORE_CLOCK / 2)	//[22579200]  AICA CORE -> PLL 2:1 -> ARM
-#define SH4_MAIN_CLOCK (200 * 1000 * 1000)		//[200000000] XTal(13.5) -> PLL (33.3) -> PLL 1:6 (200)
-#define G2_BUS_CLOCK (25 * 1000 * 1000)			//[25000000]  from Holly, from SH4_RAM_CLOCK w/ 2 2:1 plls
-
-#if defined(GLES) && !defined(GLES3) && !defined(GLES2)
-// Only use GL ES 2.0 API functions
-#define GLES2
-#endif
+#pragma once
+//#define STRICT_MODE
+#ifndef STRICT_MODE
+#define FAST_MMU
+#define USE_WINCE_HACK
+#endif
+
+#define DC_PLATFORM_DREAMCAST   0
+#define DC_PLATFORM_DEV_UNIT    1
+#define DC_PLATFORM_NAOMI       2
+#define DC_PLATFORM_NAOMI2      3
+#define DC_PLATFORM_ATOMISWAVE  4
+#define DC_PLATFORM_SYSTEMSP    5
+
+//HOST_CPU
+#define CPU_X86      0x20000001
+#define CPU_ARM      0x20000002
+#define CPU_ARM64    0x20000003
+#define CPU_X64      0x20000004
+
+//FEAT_SHREC, FEAT_AREC, FEAT_DSPREC
+#define DYNAREC_NONE	0x40000001
+#define DYNAREC_JIT		0x40000002
+
+//automatic
+
+#if defined(__EMSCRIPTEN__) || defined(__wasm__)
+	#define CPU_GENERIC  0x20000005
+	#define HOST_CPU CPU_GENERIC
+	// WASM JIT backend
+	#define FEAT_SHREC DYNAREC_JIT
+	#define FEAT_AREC DYNAREC_NONE
+	#define FEAT_DSPREC DYNAREC_NONE
+#elif defined(__x86_64__) || defined(_M_X64)
+	#define HOST_CPU CPU_X64
+#elif defined(__i386__) || defined(_M_IX86)
+	#define HOST_CPU CPU_X86
+#elif defined(__arm__) || defined (_M_ARM)
+	#define HOST_CPU CPU_ARM
+#elif defined(__aarch64__) || defined(_M_ARM64)
+	#define HOST_CPU CPU_ARM64
+#else
+	#error Unsupported architecture
+#endif
+
+#if defined(__APPLE__)
+#include "TargetConditionals.h"
+#if TARGET_OS_SIMULATOR
+// iOS simulator
+#define TARGET_NO_REC
+#endif
+#if defined(TARGET_MAC) && HOST_CPU == CPU_ARM64
+#define TARGET_ARM_MAC
+#endif
+#endif
+
+#if defined(TARGET_NO_REC)
+#define FEAT_SHREC DYNAREC_NONE
+#define FEAT_AREC DYNAREC_NONE
+#define FEAT_DSPREC DYNAREC_NONE
+#endif
+
+#if defined(TARGET_NO_AREC)
+#define FEAT_SHREC DYNAREC_JIT
+#define FEAT_AREC DYNAREC_NONE
+#define FEAT_DSPREC DYNAREC_NONE
+#endif
+
+#ifdef __SWITCH__
+#define FEAT_NO_RWX_PAGES
+#endif
+
+//defaults
+
+#ifndef FEAT_SHREC
+	#if HOST_CPU == CPU_ARM || HOST_CPU == CPU_ARM64 || HOST_CPU == CPU_X86 || HOST_CPU == CPU_X64
+		#define FEAT_SHREC DYNAREC_JIT
+	#else
+		#define FEAT_SHREC DYNAREC_NONE
+	#endif
+#endif
+
+#ifndef FEAT_AREC
+	#if HOST_CPU == CPU_ARM || HOST_CPU == CPU_ARM64 || HOST_CPU == CPU_X64
+		#define FEAT_AREC DYNAREC_JIT
+	#else
+		#define FEAT_AREC DYNAREC_NONE
+	#endif
+#endif
+
+#ifndef FEAT_DSPREC
+	#if HOST_CPU == CPU_ARM || HOST_CPU == CPU_ARM64 || HOST_CPU == CPU_X86 || HOST_CPU == CPU_X64
+		#define FEAT_DSPREC DYNAREC_JIT
+	#else
+		#define FEAT_DSPREC DYNAREC_NONE
+	#endif
+#endif
+
+// Some restrictions on FEAT_NO_RWX_PAGES
+#if defined(FEAT_NO_RWX_PAGES) && FEAT_SHREC == DYNAREC_JIT
+#if HOST_CPU != CPU_X64 && HOST_CPU != CPU_ARM64
+#error "FEAT_NO_RWX_PAGES Only implemented for X64 and ARMv8"
+#endif
+#endif
+
+#ifdef _WIN32
+#if defined(WINAPI_FAMILY) && (WINAPI_FAMILY == WINAPI_FAMILY_APP)
+#define TARGET_UWP 1
+#endif
+#ifdef HAVE_D3D11
+#define USE_DX11
+#endif
+#endif
+
+#if !defined(LIBRETRO)
+#define USE_GGPO
+#endif
+
+#if !defined(__ANDROID__) && !defined(TARGET_IPHONE) && !defined(TARGET_UWP) \
+	&& !defined(__SWITCH__) && !defined(LIBRETRO) && !defined(__NetBSD__) && !defined(__OpenBSD__)
+#define NAOMI_MULTIBOARD
+#endif
+
+// TARGET PLATFORM
+#define GD_CLOCK 33868800						//GDROM XTAL -- 768fs
+#define AICA_CORE_CLOCK (GD_CLOCK * 4 / 3)		//[45158400]  GD->PLL 3:4 -> AICA CORE	 -- 1024fs
+#define AICA_ARM_CLOCK (AICA_CORE_CLOCK / 2)	//[22579200]  AICA CORE -> PLL 2:1 -> ARM
+#define SH4_MAIN_CLOCK (200 * 1000 * 1000)		//[200000000] XTal(13.5) -> PLL (33.3) -> PLL 1:6 (200)
+#define G2_BUS_CLOCK (25 * 1000 * 1000)			//[25000000]  from Holly, from SH4_RAM_CLOCK w/ 2 2:1 plls
+
+#if defined(GLES) && !defined(GLES3) && !defined(GLES2)
+// Only use GL ES 2.0 API functions
+#define GLES2
+#endif
diff --git a/core/cfg/option.cpp b/core/cfg/option.cpp
index 1713a7b..9f63121 100644
--- a/core/cfg/option.cpp
+++ b/core/cfg/option.cpp
@@ -1,247 +1,247 @@
-/*
-	Copyright 2021 flyinghead
-
-	This file is part of Flycast.
-
-    Flycast is free software: you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation, either version 2 of the License, or
-    (at your option) any later version.
-
-    Flycast is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License
-    along with Flycast.  If not, see <https://www.gnu.org/licenses/>.
-*/
-#include "option.h"
-#include "network/naomi_network.h"
-#include "debug/gdb_server.h"
-
-namespace config {
-
-// Dynarec
-
-Option<bool> DynarecEnabled("Dynarec.Enabled", true);
-Option<int> Sh4Clock("Sh4Clock", 200);
-
-// General
-
-Option<int> Cable("Dreamcast.Cable", 3);			// TV Composite
-Option<int> Region("Dreamcast.Region", 1);			// USA
-Option<int> Broadcast("Dreamcast.Broadcast", 0);	// NTSC
-Option<int> Language("Dreamcast.Language", 1);		// English
-Option<bool> AutoLoadState("Dreamcast.AutoLoadState");
-Option<bool> AutoSaveState("Dreamcast.AutoSaveState");
-Option<int, false> SavestateSlot("Dreamcast.SavestateSlot");
-Option<bool> ForceFreePlay("ForceFreePlay", true);
-Option<bool, false> FetchBoxart("FetchBoxart", true);
-Option<bool, false> BoxartDisplayMode("BoxartDisplayMode", true);
-Option<int, false> UIScaling("UIScaling", 100);
-Option<int, false> UITheme("UITheme", 0);
-
-// Sound
-
-Option<bool> DSPEnabled("aica.DSPEnabled", false);
-#if HOST_CPU == CPU_ARM
-Option<int> AudioBufferSize("aica.BufferSize", 5644);	// 128 ms
-#else
-Option<int> AudioBufferSize("aica.BufferSize", 2822);	// 64 ms
-#endif
-Option<bool> AutoLatency("aica.AutoLatency",
-#ifdef __ANDROID__
-		true
-#else
-		false
-#endif
-		);
-
-OptionString AudioBackend("backend", "auto", "audio");
-AudioVolumeOption AudioVolume;
-Option<bool> VmuSound("VmuSound", false, "audio");
-
-// Rendering
-
-RendererOption RendererType;
-Option<bool> UseMipmaps("rend.UseMipmaps", true);
-Option<bool> Widescreen("rend.WideScreen");
-Option<bool> SuperWidescreen("rend.SuperWideScreen");
-Option<bool> ShowFPS("rend.ShowFPS");
-Option<bool> RenderToTextureBuffer("rend.RenderToTextureBuffer");
-Option<bool> TranslucentPolygonDepthMask("rend.TranslucentPolygonDepthMask");
-Option<bool> ModifierVolumes("rend.ModifierVolumes", true);
-Option<int> TextureUpscale("rend.TextureUpscale2", 1);
-Option<int> MaxFilteredTextureSize("rend.MaxFilteredTextureSize", 256);
-Option<float> ExtraDepthScale("rend.ExtraDepthScale", 1.f);
-Option<bool> CustomTextures("rend.CustomTextures");
-Option<bool> PreloadCustomTextures("rend.PreloadCustomTextures");
-Option<bool> DumpTextures("rend.DumpTextures");
-Option<bool> DumpReplacedTextures("rend.DumpReplacedTextures");
-Option<int> ScreenStretching("rend.ScreenStretching", 100);
-Option<bool> Fog("rend.Fog", true);
-Option<bool> FloatVMUs("rend.FloatVMUs");
-Option<bool> Rotate90("rend.Rotate90");
-Option<bool> PerStripSorting("rend.PerStripSorting");
-#ifdef __APPLE__
-Option<bool> DelayFrameSwapping("rend.DelayFrameSwapping", false);
-#else
-Option<bool> DelayFrameSwapping("rend.DelayFrameSwapping", true);
-#endif
-Option<bool> WidescreenGameHacks("rend.WidescreenGameHacks");
-std::array<Option<int>, 4> CrosshairColor {
-	Option<int>("rend.CrossHairColor1"),
-	Option<int>("rend.CrossHairColor2"),
-	Option<int>("rend.CrossHairColor3"),
-	Option<int>("rend.CrossHairColor4"),
-};
-Option<int> CrosshairSize("rend.CrosshairSize", 40);
-Option<int> SkipFrame("ta.skip");
-Option<int> MaxThreads("pvr.MaxThreads", 3);
-Option<int> AutoSkipFrame("pvr.AutoSkipFrame", 0);
-Option<int> RenderResolution("rend.Resolution", 480);
-Option<bool> IntegerScale("rend.IntegerScale", false);
-Option<bool> LinearInterpolation("rend.LinearInterpolation", true);
-Option<bool> VSync("rend.vsync", true);
-Option<int64_t> PixelBufferSize("rend.PixelBufferSize", 512_MB);
-Option<int> AnisotropicFiltering("rend.AnisotropicFiltering", 1);
-Option<int> TextureFiltering("rend.TextureFiltering", 0); // Default
-Option<bool> ThreadedRendering("rend.ThreadedRendering", true);
-Option<bool> DupeFrames("rend.DupeFrames", false);
-Option<int> PerPixelLayers("rend.PerPixelLayers", 32);
-#ifdef TARGET_UWP
-Option<bool> NativeDepthInterpolation("rend.NativeDepthInterpolation", true);
-#else
-Option<bool> NativeDepthInterpolation("rend.NativeDepthInterpolation", false);
-#endif
-Option<bool> EmulateFramebuffer("rend.EmulateFramebuffer", false);
-Option<bool> FixUpscaleBleedingEdge("rend.FixUpscaleBleedingEdge", true);
-Option<bool> CustomGpuDriver("rend.CustomGpuDriver", false);
-#ifdef VIDEO_ROUTING
-Option<bool, false> VideoRouting("rend.VideoRouting", false);
-Option<bool, false> VideoRoutingScale("rend.VideoRoutingScale", false);
-Option<int, false> VideoRoutingVRes("rend.VideoRoutingVRes", 720);
-#endif
-
-// Misc
-
-Option<bool> SerialConsole("Debug.SerialConsoleEnabled");
-Option<bool> SerialPTY("Debug.SerialPTY");
-Option<bool> GDB("Debug.GDBEnabled");
-Option<int> GDBPort("Debug.GDBPort", debugger::DEFAULT_PORT);
-Option<bool> GDBWaitForConnection("Debug.GDBWaitForConnection");
-Option<bool> UseReios("UseReios");
-Option<bool> FastGDRomLoad("FastGDRomLoad", false);
-Option<bool> RamMod32MB("Dreamcast.RamMod32MB", false);
-
-Option<bool> OpenGlChecks("OpenGlChecks", false, "validate");
-
-Option<std::vector<std::string>, false> ContentPath("Dreamcast.ContentPath");
-Option<std::vector<std::string>, false> BiosPath("Dreamcast.BiosPath");
-Option<std::string, false> VMUPath("Dreamcast.VMUPath");
-Option<std::vector<std::string>, false> SavestatePath("Dreamcast.SavestatePath");
-Option<std::string, false> SavePath("Dreamcast.SavePath");
-Option<std::vector<std::string>, false> TexturePath("Dreamcast.TexturePath");
-Option<std::string, false> TextureDumpPath("Dreamcast.TextureDumpPath");
-Option<std::string, false> BoxartPath("Dreamcast.BoxartPath");
-Option<std::vector<std::string>, false> MappingsPath("Dreamcast.MappingsPath");
-Option<std::vector<std::string>, false> CheatPath("Dreamcast.CheatPath");
-Option<bool, false> HideLegacyNaomiRoms("Dreamcast.HideLegacyNaomiRoms", true);
-Option<bool, false> UploadCrashLogs("UploadCrashLogs", true);
-Option<bool, false> DiscordPresence("DiscordPresence", true);
-#if defined(__ANDROID__) && !defined(LIBRETRO)
-Option<bool, false> UseSafFilePicker("UseSafFilePicker", true);
-#endif
-OptionString LogServer("LogServer", "", "log");
-
-// Profiler
-Option<bool> ProfilerEnabled("Profiler.Enabled");
-Option<bool> ProfilerDrawToGUI("Profiler.DrawGUI");
-Option<bool> ProfilerOutputTTY("Profiler.OutputTTY");
-Option<float> ProfilerFrameWarningTime("Profiler.FrameWarningTime", 1.0f / 55.0f);
-
-// Network
-
-Option<bool> NetworkEnable("Enable", false, "network");
-Option<bool> ActAsServer("ActAsServer", false, "network");
-OptionString DNS("DNS", "dns.flyca.st", "network");
-OptionString NetworkServer("server", "", "network");
-Option<int> LocalPort("LocalPort", NaomiNetwork::SERVER_PORT, "network");
-Option<bool> EmulateBBA("EmulateBBA", false, "network");
-Option<bool> EnableUPnP("EnableUPnP", true, "network");
-Option<bool> GGPOEnable("GGPO", false, "network");
-Option<int> GGPODelay("GGPODelay", 0, "network");
-Option<bool> NetworkStats("Stats", true, "network");
-Option<int> GGPOAnalogAxes("GGPOAnalogAxes", 0, "network");
-Option<bool> GGPOChat("GGPOChat", true, "network");
-Option<bool> GGPOChatTimeoutToggle("GGPOChatTimeoutToggle", true, "network");
-Option<int> GGPOChatTimeout("GGPOChatTimeout", 10, "network");
-Option<bool> NetworkOutput("NetworkOutput", false, "network");
-Option<int> MultiboardSlaves("MultiboardSlaves", 1, "network");
-Option<bool> BattleCableEnable("BattleCable", false, "network");
-Option<bool> UseDCNet("DCNet", true, "network");
-OptionString ISPUsername("ISPUsername", "flycast1", "network");
-
-#ifdef USE_OMX
-Option<int> OmxAudioLatency("audio_latency", 100, "omx");
-Option<bool> OmxAudioHdmi("audio_hdmi", true, "omx");
-#endif
-
-// Maple
-
-Option<int> MouseSensitivity("MouseSensitivity", 100, "input");
-Option<int> VirtualGamepadVibration("VirtualGamepadVibration", 20, "input");
-Option<int> VirtualGamepadTransparency("VirtualGamepadTransparency", 37, "input");
-
-std::array<Option<MapleDeviceType>, 4> MapleMainDevices {
-	Option<MapleDeviceType>("device1", MDT_SegaController, "input"),
-	Option<MapleDeviceType>("device2", MDT_None, "input"),
-	Option<MapleDeviceType>("device3", MDT_None, "input"),
-	Option<MapleDeviceType>("device4", MDT_None, "input"),
-};
-std::array<std::array<Option<MapleDeviceType>, 2>, 4> MapleExpansionDevices {{
-	{{Option<MapleDeviceType>("device1.1", MDT_SegaVMU, "input"),
-	Option<MapleDeviceType>("device1.2", MDT_SegaVMU, "input")}},
-
-	{{Option<MapleDeviceType>("device2.1", MDT_None, "input"),
-	Option<MapleDeviceType>("device2.2", MDT_None, "input")}},
-
-	{{Option<MapleDeviceType>("device3.1", MDT_None, "input"),
-	Option<MapleDeviceType>("device3.2", MDT_None, "input")}},
-
-	{{Option<MapleDeviceType>("device4.1", MDT_None, "input"),
-	Option<MapleDeviceType>("device4.2", MDT_None, "input")}},
-}};
-
-std::array<std::array<Option<int>, 2>, 4> NetworkExpansionDevices{{
-	{{Option<int>("device1.1.net", 0, "input"),
-	Option<int>("device1.2.net", 0, "input")}},
-
-	{{Option<int>("device2.1.net", 0, "input"),
-	Option<int>("device2.2.net", 0, "input")}},
-
-	{{Option<int>("device3.1.net", 0, "input"),
-	Option<int>("device3.2.net", 0, "input")}},
-
-	{{Option<int>("device4.1.net", 0, "input"),
-	Option<int>("device4.2.net", 0, "input")}},
-}};
-Option<bool> PerGameVmu("PerGameVmu", true, "config");
-#ifdef _WIN32
-Option<bool, false> UseRawInput("RawInput", false, "input");
-#endif
-Option<bool> UsePhysicalVmuMemory("UsePhysicalVmuMemory", false);
-
-#ifdef USE_LUA
-Option<std::string, false> LuaFileName("LuaFileName", "flycast.lua");
-#endif
-
-// RetroAchievements
-
-Option<bool> EnableAchievements("Enabled", false, "achievements");
-Option<bool> AchievementsHardcoreMode("HardcoreMode", false, "achievements");
-OptionString AchievementsUserName("UserName", "", "achievements");
-OptionString AchievementsToken("Token", "", "achievements");
-
-} // namespace config
+/*
+	Copyright 2021 flyinghead
+
+	This file is part of Flycast.
+
+    Flycast is free software: you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation, either version 2 of the License, or
+    (at your option) any later version.
+
+    Flycast is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with Flycast.  If not, see <https://www.gnu.org/licenses/>.
+*/
+#include "option.h"
+#include "network/naomi_network.h"
+#include "debug/gdb_server.h"
+
+namespace config {
+
+// Dynarec
+
+Option<bool> DynarecEnabled("Dynarec.Enabled", false);  // DIAGNOSTIC: test if recompiler Init() causes rendering garbage
+Option<int> Sh4Clock("Sh4Clock", 200);
+
+// General
+
+Option<int> Cable("Dreamcast.Cable", 3);			// TV Composite
+Option<int> Region("Dreamcast.Region", 1);			// USA
+Option<int> Broadcast("Dreamcast.Broadcast", 0);	// NTSC
+Option<int> Language("Dreamcast.Language", 1);		// English
+Option<bool> AutoLoadState("Dreamcast.AutoLoadState");
+Option<bool> AutoSaveState("Dreamcast.AutoSaveState");
+Option<int, false> SavestateSlot("Dreamcast.SavestateSlot");
+Option<bool> ForceFreePlay("ForceFreePlay", true);
+Option<bool, false> FetchBoxart("FetchBoxart", true);
+Option<bool, false> BoxartDisplayMode("BoxartDisplayMode", true);
+Option<int, false> UIScaling("UIScaling", 100);
+Option<int, false> UITheme("UITheme", 0);
+
+// Sound
+
+Option<bool> DSPEnabled("aica.DSPEnabled", false);
+#if HOST_CPU == CPU_ARM
+Option<int> AudioBufferSize("aica.BufferSize", 5644);	// 128 ms
+#else
+Option<int> AudioBufferSize("aica.BufferSize", 2822);	// 64 ms
+#endif
+Option<bool> AutoLatency("aica.AutoLatency",
+#ifdef __ANDROID__
+		true
+#else
+		false
+#endif
+		);
+
+OptionString AudioBackend("backend", "auto", "audio");
+AudioVolumeOption AudioVolume;
+Option<bool> VmuSound("VmuSound", false, "audio");
+
+// Rendering
+
+RendererOption RendererType;
+Option<bool> UseMipmaps("rend.UseMipmaps", true);
+Option<bool> Widescreen("rend.WideScreen");
+Option<bool> SuperWidescreen("rend.SuperWideScreen");
+Option<bool> ShowFPS("rend.ShowFPS");
+Option<bool> RenderToTextureBuffer("rend.RenderToTextureBuffer");
+Option<bool> TranslucentPolygonDepthMask("rend.TranslucentPolygonDepthMask");
+Option<bool> ModifierVolumes("rend.ModifierVolumes", true);
+Option<int> TextureUpscale("rend.TextureUpscale2", 1);
+Option<int> MaxFilteredTextureSize("rend.MaxFilteredTextureSize", 256);
+Option<float> ExtraDepthScale("rend.ExtraDepthScale", 1.f);
+Option<bool> CustomTextures("rend.CustomTextures");
+Option<bool> PreloadCustomTextures("rend.PreloadCustomTextures");
+Option<bool> DumpTextures("rend.DumpTextures");
+Option<bool> DumpReplacedTextures("rend.DumpReplacedTextures");
+Option<int> ScreenStretching("rend.ScreenStretching", 100);
+Option<bool> Fog("rend.Fog", true);
+Option<bool> FloatVMUs("rend.FloatVMUs");
+Option<bool> Rotate90("rend.Rotate90");
+Option<bool> PerStripSorting("rend.PerStripSorting");
+#ifdef __APPLE__
+Option<bool> DelayFrameSwapping("rend.DelayFrameSwapping", false);
+#else
+Option<bool> DelayFrameSwapping("rend.DelayFrameSwapping", true);
+#endif
+Option<bool> WidescreenGameHacks("rend.WidescreenGameHacks");
+std::array<Option<int>, 4> CrosshairColor {
+	Option<int>("rend.CrossHairColor1"),
+	Option<int>("rend.CrossHairColor2"),
+	Option<int>("rend.CrossHairColor3"),
+	Option<int>("rend.CrossHairColor4"),
+};
+Option<int> CrosshairSize("rend.CrosshairSize", 40);
+Option<int> SkipFrame("ta.skip");
+Option<int> MaxThreads("pvr.MaxThreads", 3);
+Option<int> AutoSkipFrame("pvr.AutoSkipFrame", 0);
+Option<int> RenderResolution("rend.Resolution", 480);
+Option<bool> IntegerScale("rend.IntegerScale", false);
+Option<bool> LinearInterpolation("rend.LinearInterpolation", true);
+Option<bool> VSync("rend.vsync", true);
+Option<int64_t> PixelBufferSize("rend.PixelBufferSize", 512_MB);
+Option<int> AnisotropicFiltering("rend.AnisotropicFiltering", 1);
+Option<int> TextureFiltering("rend.TextureFiltering", 0); // Default
+Option<bool> ThreadedRendering("rend.ThreadedRendering", true);
+Option<bool> DupeFrames("rend.DupeFrames", false);
+Option<int> PerPixelLayers("rend.PerPixelLayers", 32);
+#ifdef TARGET_UWP
+Option<bool> NativeDepthInterpolation("rend.NativeDepthInterpolation", true);
+#else
+Option<bool> NativeDepthInterpolation("rend.NativeDepthInterpolation", false);
+#endif
+Option<bool> EmulateFramebuffer("rend.EmulateFramebuffer", false);
+Option<bool> FixUpscaleBleedingEdge("rend.FixUpscaleBleedingEdge", true);
+Option<bool> CustomGpuDriver("rend.CustomGpuDriver", false);
+#ifdef VIDEO_ROUTING
+Option<bool, false> VideoRouting("rend.VideoRouting", false);
+Option<bool, false> VideoRoutingScale("rend.VideoRoutingScale", false);
+Option<int, false> VideoRoutingVRes("rend.VideoRoutingVRes", 720);
+#endif
+
+// Misc
+
+Option<bool> SerialConsole("Debug.SerialConsoleEnabled");
+Option<bool> SerialPTY("Debug.SerialPTY");
+Option<bool> GDB("Debug.GDBEnabled");
+Option<int> GDBPort("Debug.GDBPort", debugger::DEFAULT_PORT);
+Option<bool> GDBWaitForConnection("Debug.GDBWaitForConnection");
+Option<bool> UseReios("UseReios");
+Option<bool> FastGDRomLoad("FastGDRomLoad", false);
+Option<bool> RamMod32MB("Dreamcast.RamMod32MB", false);
+
+Option<bool> OpenGlChecks("OpenGlChecks", false, "validate");
+
+Option<std::vector<std::string>, false> ContentPath("Dreamcast.ContentPath");
+Option<std::vector<std::string>, false> BiosPath("Dreamcast.BiosPath");
+Option<std::string, false> VMUPath("Dreamcast.VMUPath");
+Option<std::vector<std::string>, false> SavestatePath("Dreamcast.SavestatePath");
+Option<std::string, false> SavePath("Dreamcast.SavePath");
+Option<std::vector<std::string>, false> TexturePath("Dreamcast.TexturePath");
+Option<std::string, false> TextureDumpPath("Dreamcast.TextureDumpPath");
+Option<std::string, false> BoxartPath("Dreamcast.BoxartPath");
+Option<std::vector<std::string>, false> MappingsPath("Dreamcast.MappingsPath");
+Option<std::vector<std::string>, false> CheatPath("Dreamcast.CheatPath");
+Option<bool, false> HideLegacyNaomiRoms("Dreamcast.HideLegacyNaomiRoms", true);
+Option<bool, false> UploadCrashLogs("UploadCrashLogs", true);
+Option<bool, false> DiscordPresence("DiscordPresence", true);
+#if defined(__ANDROID__) && !defined(LIBRETRO)
+Option<bool, false> UseSafFilePicker("UseSafFilePicker", true);
+#endif
+OptionString LogServer("LogServer", "", "log");
+
+// Profiler
+Option<bool> ProfilerEnabled("Profiler.Enabled");
+Option<bool> ProfilerDrawToGUI("Profiler.DrawGUI");
+Option<bool> ProfilerOutputTTY("Profiler.OutputTTY");
+Option<float> ProfilerFrameWarningTime("Profiler.FrameWarningTime", 1.0f / 55.0f);
+
+// Network
+
+Option<bool> NetworkEnable("Enable", false, "network");
+Option<bool> ActAsServer("ActAsServer", false, "network");
+OptionString DNS("DNS", "dns.flyca.st", "network");
+OptionString NetworkServer("server", "", "network");
+Option<int> LocalPort("LocalPort", NaomiNetwork::SERVER_PORT, "network");
+Option<bool> EmulateBBA("EmulateBBA", false, "network");
+Option<bool> EnableUPnP("EnableUPnP", true, "network");
+Option<bool> GGPOEnable("GGPO", false, "network");
+Option<int> GGPODelay("GGPODelay", 0, "network");
+Option<bool> NetworkStats("Stats", true, "network");
+Option<int> GGPOAnalogAxes("GGPOAnalogAxes", 0, "network");
+Option<bool> GGPOChat("GGPOChat", true, "network");
+Option<bool> GGPOChatTimeoutToggle("GGPOChatTimeoutToggle", true, "network");
+Option<int> GGPOChatTimeout("GGPOChatTimeout", 10, "network");
+Option<bool> NetworkOutput("NetworkOutput", false, "network");
+Option<int> MultiboardSlaves("MultiboardSlaves", 1, "network");
+Option<bool> BattleCableEnable("BattleCable", false, "network");
+Option<bool> UseDCNet("DCNet", true, "network");
+OptionString ISPUsername("ISPUsername", "flycast1", "network");
+
+#ifdef USE_OMX
+Option<int> OmxAudioLatency("audio_latency", 100, "omx");
+Option<bool> OmxAudioHdmi("audio_hdmi", true, "omx");
+#endif
+
+// Maple
+
+Option<int> MouseSensitivity("MouseSensitivity", 100, "input");
+Option<int> VirtualGamepadVibration("VirtualGamepadVibration", 20, "input");
+Option<int> VirtualGamepadTransparency("VirtualGamepadTransparency", 37, "input");
+
+std::array<Option<MapleDeviceType>, 4> MapleMainDevices {
+	Option<MapleDeviceType>("device1", MDT_SegaController, "input"),
+	Option<MapleDeviceType>("device2", MDT_None, "input"),
+	Option<MapleDeviceType>("device3", MDT_None, "input"),
+	Option<MapleDeviceType>("device4", MDT_None, "input"),
+};
+std::array<std::array<Option<MapleDeviceType>, 2>, 4> MapleExpansionDevices {{
+	{{Option<MapleDeviceType>("device1.1", MDT_SegaVMU, "input"),
+	Option<MapleDeviceType>("device1.2", MDT_SegaVMU, "input")}},
+
+	{{Option<MapleDeviceType>("device2.1", MDT_None, "input"),
+	Option<MapleDeviceType>("device2.2", MDT_None, "input")}},
+
+	{{Option<MapleDeviceType>("device3.1", MDT_None, "input"),
+	Option<MapleDeviceType>("device3.2", MDT_None, "input")}},
+
+	{{Option<MapleDeviceType>("device4.1", MDT_None, "input"),
+	Option<MapleDeviceType>("device4.2", MDT_None, "input")}},
+}};
+
+std::array<std::array<Option<int>, 2>, 4> NetworkExpansionDevices{{
+	{{Option<int>("device1.1.net", 0, "input"),
+	Option<int>("device1.2.net", 0, "input")}},
+
+	{{Option<int>("device2.1.net", 0, "input"),
+	Option<int>("device2.2.net", 0, "input")}},
+
+	{{Option<int>("device3.1.net", 0, "input"),
+	Option<int>("device3.2.net", 0, "input")}},
+
+	{{Option<int>("device4.1.net", 0, "input"),
+	Option<int>("device4.2.net", 0, "input")}},
+}};
+Option<bool> PerGameVmu("PerGameVmu", true, "config");
+#ifdef _WIN32
+Option<bool, false> UseRawInput("RawInput", false, "input");
+#endif
+Option<bool> UsePhysicalVmuMemory("UsePhysicalVmuMemory", false);
+
+#ifdef USE_LUA
+Option<std::string, false> LuaFileName("LuaFileName", "flycast.lua");
+#endif
+
+// RetroAchievements
+
+Option<bool> EnableAchievements("Enabled", false, "achievements");
+Option<bool> AchievementsHardcoreMode("HardcoreMode", false, "achievements");
+OptionString AchievementsUserName("UserName", "", "achievements");
+OptionString AchievementsToken("Token", "", "achievements");
+
+} // namespace config
diff --git a/core/hw/mem/addrspace.cpp b/core/hw/mem/addrspace.cpp
index c08cb8e..fd1756b 100644
--- a/core/hw/mem/addrspace.cpp
+++ b/core/hw/mem/addrspace.cpp
@@ -7,6 +7,9 @@
 #include "oslib/oslib.h"
 #include "oslib/virtmem.h"
 #include <cassert>
+#ifdef __EMSCRIPTEN__
+#include <emscripten.h>
+#endif
 
 namespace addrspace
 {
@@ -410,9 +413,21 @@ void initMappings()
 		WARN_LOG(VMEM, "Warning! nvmem is DISABLED (due to failure or not being built-in");
 
 		// Allocate it all and initialize it.
+#ifdef __EMSCRIPTEN__
+		EM_ASM({ console.log('[rec_wasm] initMappings: allocating Sh4RCB, size=' + $0); }, (int)sizeof(Sh4RCB));
+#endif
 		p_sh4rcb = (Sh4RCB*)malloc_pages(sizeof(Sh4RCB));
+#ifdef __EMSCRIPTEN__
+		EM_ASM({ console.log('[rec_wasm] initMappings: p_sh4rcb=' + $0); }, (int)(uintptr_t)p_sh4rcb);
+#endif
 #if FEAT_SHREC != DYNAREC_NONE
+#ifdef __EMSCRIPTEN__
+		EM_ASM({ console.log('[rec_wasm] initMappings: bm_vmem_pagefill FPCB, size=' + $0); }, (int)sizeof(p_sh4rcb->fpcb));
+#endif
 		bm_vmem_pagefill((void**)p_sh4rcb->fpcb, sizeof(p_sh4rcb->fpcb));
+#ifdef __EMSCRIPTEN__
+		EM_ASM({ console.log('[rec_wasm] initMappings: bm_vmem_pagefill done'); });
+#endif
 #endif
 		memset(&p_sh4rcb->cntx, 0, sizeof(p_sh4rcb->cntx));
 
diff --git a/core/hw/naomi/naomi.cpp b/core/hw/naomi/naomi.cpp
index abebd4e..9e7998e 100644
--- a/core/hw/naomi/naomi.cpp
+++ b/core/hw/naomi/naomi.cpp
@@ -1,419 +1,419 @@
-/*
-	This file is part of Flycast.
-
-    Flycast is free software: you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation, either version 2 of the License, or
-    (at your option) any later version.
-
-    Flycast is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License
-    along with Flycast.  If not, see <https://www.gnu.org/licenses/>.
- */
-#include "types.h"
-#include "hw/holly/sb.h"
-#include "hw/sh4/sh4_mem.h"
-#include "hw/holly/holly_intc.h"
-#include "hw/sh4/sh4_sched.h"
-#include "hw/hwreg.h"
-
-#include "naomi.h"
-#include "naomi_cart.h"
-#include "naomi_regs.h"
-#include "naomi_m3comm.h"
-#include "serialize.h"
-#include "network/output.h"
-#include "hw/sh4/modules/modules.h"
-#include "oslib/oslib.h"
-#include "printer.h"
-#include "hw/flashrom/x76f100.h"
-#include "midiffb.h"
-#include "atomiswave.h"
-#include "oslib/i18n.h"
-
-#include <algorithm>
-
-static NaomiM3Comm m3comm;
-Multiboard *multiboard;
-
-static X76F100SerialFlash mainSerialId;
-static X76F100SerialFlash romSerialId;
-
-static int dmaSchedId = -1;
-static int dmaXferDelay = 10;	// cart dma xfer speed, in cycles/byte (default 20 MB/s)
-
-void NaomiBoardIDWrite(const u16 data)
-{
-	// bit 2: clock
-	// bit 3: data
-	// bit 4: reset (x76f100 only)
-	// bit 5: chip select
-	mainSerialId.writeCS(data & 0x20);
-	mainSerialId.writeRST(data & 0x10);
-	mainSerialId.writeSCL(data & 4);
-	mainSerialId.writeSDA(data & 8);
-}
-
-u16 NaomiBoardIDRead()
-{
-	// bit 0 indicates the eeprom is a X76F100, otherwise the BIOS expects an AT93C46
-	// bit 3 is xf76f100 SDA
-	// bit 4 is at93c46 DO
-	return (mainSerialId.readSDA() << 3) | 1;
-}
-
-void NaomiGameIDWrite(const u16 data)
-{
-	romSerialId.writeCS(data & 4);
-	romSerialId.writeRST(data & 8);
-	romSerialId.writeSCL(data & 2);
-	romSerialId.writeSDA(data & 1);
-}
-
-u16 NaomiGameIDRead()
-{
-	return romSerialId.readSDA() << 15;
-}
-
-u32 ReadMem_naomi(u32 address, u32 size)
-{
-//	verify(size != 1);
-	if (unlikely(CurrentCartridge == NULL))
-	{
-		INFO_LOG(NAOMI, "called without cartridge");
-		return 0xFFFF;
-	}
-	if (address >= NAOMI_COMM2_CTRL_addr && address <= NAOMI_COMM2_STATUS1_addr)
-		return m3comm.ReadMem(address, size);
-	else
-		return CurrentCartridge->ReadMem(address, size);
-}
-
-void WriteMem_naomi(u32 address, u32 data, u32 size)
-{
-	if (unlikely(CurrentCartridge == NULL))
-	{
-		INFO_LOG(NAOMI, "called without cartridge");
-		return;
-	}
-	if (address >= NAOMI_COMM2_CTRL_addr && address <= NAOMI_COMM2_STATUS1_addr
-			&& settings.platform.isNaomi())
-		m3comm.WriteMem(address, data, size);
-	else
-		CurrentCartridge->WriteMem(address, data, size);
-}
-
-static int naomiDmaSched(int tag, int sch_cycl, int jitter, void *arg)
-{
-	u32 start = SB_GDSTARD;
-	u32 len = std::min<int>(((SB_GDLEN + 31) & ~31) - SB_GDLEND, 1024);
-	SB_GDLEND += len;
-	while (len > 0)
-	{
-		u32 block_len = len;
-		void* ptr = CurrentCartridge->GetDmaPtr(block_len);
-		if (block_len == 0)
-		{
-			INFO_LOG(NAOMI, "Aborted DMA transfer. Read past end of cart?");
-			for (u32 i = 0; i < len; i += 8, start += 8)
-				addrspace::write64(start, 0);
-			break;
-		}
-		WriteMemBlock_nommu_ptr(start, (u32*)ptr, block_len);
-		CurrentCartridge->AdvancePtr(block_len);
-		len -= block_len;
-		start += block_len;
-	}
-	SB_GDSTARD = start;
-	if (SB_GDLEN <= SB_GDLEND)
-	{
-		SB_GDST = 0;
-		asic_RaiseInterrupt(holly_GDROM_DMA);
-		return 0;
-	}
-	else {
-		return std::min<int>(SB_GDLEN - SB_GDLEND, 1024) * dmaXferDelay;
-	}
-}
-
-//Dma Start
-static void Naomi_DmaStart(u32 addr, u32 data)
-{
-	if ((data & 1) == 0 || SB_GDST == 1)
-		return;
-	if (SB_GDEN == 0)
-	{
-		INFO_LOG(NAOMI, "Invalid NAOMI-DMA start, SB_GDEN=0. Ignoring it.");
-		return;
-	}
-	
-	if (multiboard != nullptr && multiboard->dmaStart())
-	{
-	}
-	else if (!m3comm.DmaStart(addr, data) && CurrentCartridge != nullptr)
-	{
-		DEBUG_LOG(NAOMI, "NAOMI-DMA start addr %08X len %x", SB_GDSTAR, SB_GDLEN);
-		verify(1 == SB_GDDIR);
-		SB_GDST = 1;
-		SB_GDSTARD = SB_GDSTAR & 0x1FFFFFE0;
-		SB_GDLEND = 0;
-		// Max G1 bus rate: 50 MHz x 16 bits
-		// SH4_access990312_e.xls: 14.4 MB/s from GD-ROM to system RAM
-		// Here: 20 MB/s
-		sh4_sched_request(dmaSchedId, std::min<int>(SB_GDLEN, 1024) * dmaXferDelay);
-		return;
-	}
-	else
-	{
-		SB_GDSTARD = SB_GDSTAR + SB_GDLEN;
-		SB_GDLEND = SB_GDLEN;
-	}
-	asic_RaiseInterrupt(holly_GDROM_DMA);
-}
-
-void Naomi_setDmaDelay()
-{
-	if (settings.platform.isAtomiswave() || settings.content.gameId == "FORCE FIVE"
-			|| settings.content.gameId == "KENJU")
-		// 7 MB/s for Atomiwave games and conversions
-		dmaXferDelay = 27;
-	else
-		dmaXferDelay = 10;
-}
-
-static void Naomi_DmaEnable(u32 addr, u32 data)
-{
-	SB_GDEN = data & 1;
-	if (SB_GDEN == 0 && SB_GDST == 1)
-	{
-		INFO_LOG(NAOMI, "NAOMI-DMA aborted");
-		SB_GDST = 0;
-		sh4_sched_request(dmaSchedId, -1);
-	}
-}
-
-void naomi_reg_Init()
-{
-	static const u8 romSerialData[0x84] = {
-		0x19, 0x00, 0xaa, 0x55,
-		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
-		0x69, 0x79, 0x68, 0x6b, 0x74, 0x6d, 0x68, 0x6d,
-		0xa1, 0x09, ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
-		' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',  ' ', ' ', ' ', ' ',
-		'0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'
-	};
-	romSerialId.setData(romSerialData);
-	mainSerialId.setData(romSerialData);
-	if (dmaSchedId == -1)
-		dmaSchedId = sh4_sched_register(0, naomiDmaSched);
-}
-
-// Sets the full content of the rom board serial eeprom (132 bytes)
-// including response to reset and read/write passwords.
-void setGameSerialId(const u8 *data)
-{
-	romSerialId.setData(data);
-}
-
-// Return the protected data from the rom board serial eeprom (112 bytes)
-// excluding response to reset and passwords.
-const u8 *getGameSerialId()
-{
-	return romSerialId.getProtectedData();
-}
-
-void naomi_reg_Term()
-{
-	if (multiboard != nullptr)
-		delete multiboard;
-	multiboard = nullptr;
-	m3comm.closeNetwork();
-	networkOutput.term();
-	if (dmaSchedId != -1)
-		sh4_sched_unregister(dmaSchedId);
-	dmaSchedId = -1;
-	midiffb::term();
-}
-
-void naomi_reg_Reset(bool hard)
-{
-	hollyRegs.setWriteHandler<SB_GDST_addr>(Naomi_DmaStart);
-	hollyRegs.setWriteHandler<SB_GDEN_addr>(Naomi_DmaEnable);
-	SB_GDST = 0;
-	SB_GDEN = 0;
-	sh4_sched_request(dmaSchedId, -1);
-
-	atomiswave::reset();
-
-	m3comm.closeNetwork();
-	if (hard)
-	{
-		naomi_cart_Close();
-		if (multiboard != nullptr)
-		{
-			delete multiboard;
-			multiboard = nullptr;
-		}
-		if (settings.naomi.multiboard)
-			multiboard = new Multiboard();
-		networkOutput.reset();
-		mainSerialId.reset();
-		romSerialId.reset();
-	}
-	else if (multiboard != nullptr)
-		multiboard->reset();
-	midiffb::reset();
-}
-
-void naomi_Serialize(Serializer& ser)
-{
-	mainSerialId.serialize(ser);
-	romSerialId.serialize(ser);
-	atomiswave::serialize(ser);
-	// TODO serialize m3comm?
-	midiffb::serialize(ser);
-	sh4_sched_serialize(ser, dmaSchedId);
-}
-void naomi_Deserialize(Deserializer& deser)
-{
-	if (deser.version() < Deserializer::V40)
-	{
-		deser.skip<u32>();	// GSerialBuffer
-		deser.skip<u32>();	// BSerialBuffer
-		deser.skip<int>();	// GBufPos
-		deser.skip<int>();	// BBufPos
-		deser.skip<int>();	// GState
-		deser.skip<int>();	// BState
-		deser.skip<int>();	// GOldClk
-		deser.skip<int>();	// BOldClk
-		deser.skip<int>();	// BControl
-		deser.skip<int>();	// BCmd
-		deser.skip<int>();	// BLastCmd
-		deser.skip<int>();	// GControl
-		deser.skip<int>();	// GCmd
-		deser.skip<int>();	// GLastCmd
-		deser.skip<int>();	// SerStep
-		deser.skip<int>();	// SerStep2
-		deser.skip(69);		// BSerial
-		deser.skip(69);		// GSerial
-	}
-	else
-	{
-		mainSerialId.deserialize(deser);
-		romSerialId.deserialize(deser);
-	}
-	if (deser.version() < Deserializer::V36)
-	{
-		deser.skip<u32>(); // reg_dimm_command;
-		deser.skip<u32>(); // reg_dimm_offsetl;
-		deser.skip<u32>(); // reg_dimm_parameterl;
-		deser.skip<u32>(); // reg_dimm_parameterh;
-		deser.skip<u32>(); // reg_dimm_status;
-	}
-	atomiswave::deserialize(deser);
-	midiffb::deserialize(deser);
-	if (deser.version() >= Deserializer::V45)
-		sh4_sched_deserialize(deser, dmaSchedId);
-}
-
-struct DriveSimPipe : public SerialPort::Pipe
-{
-	void write(u8 data) override
-	{
-		if (buffer.empty() && data != 2)
-			return;
-		if (buffer.size() == 7)
-		{
-			u8 checksum = 0;
-			for (u8 b : buffer)
-				checksum += b;
-			if (checksum == data)
-			{
-				int newTacho = (buffer[2] - 1) * 100;
-				if (newTacho != tacho)
-				{
-					tacho = newTacho;
-					networkOutput.output("tachometer", tacho);
-				}
-				int newSpeed = buffer[3] - 1;
-				if (newSpeed != speed)
-				{
-					speed = newSpeed;
-					networkOutput.output("speedometer", speed);
-				}
-				if (!config::NetworkOutput)
-				{
-					std::string message = strprintf(i18n::T("Speed: %3d"), speed);
-					os_notify(message.c_str(), 1000);
-				}
-			}
-			buffer.clear();
-		}
-		else
-		{
-			buffer.push_back(data);
-		}
-	}
-
-	void reset()
-	{
-		buffer.clear();
-		tacho = -1;
-		speed = -1;
-	}
-private:
-	std::vector<u8> buffer;
-	int tacho = -1;
-	int speed = -1;
-};
-
-void initDriveSimSerialPipe()
-{
-	static DriveSimPipe pipe;
-
-	pipe.reset();
-	SCIFSerialPort::Instance().setPipe(&pipe);
-}
-
-G2PrinterConnection g2PrinterConnection;
-
-u32 G2PrinterConnection::read(u32 addr, u32 size)
-{
-	if (addr == STATUS_REG_ADDR)
-	{
-		u32 ret = printerStat;
-		printerStat |= 1;
-		DEBUG_LOG(NAOMI, "Printer status == %x", ret);
-		return ret;
-	}
-	else
-	{
-		INFO_LOG(NAOMI, "Unhandled G2 Ext read<%d> at %x", size, addr);
-		return 0;
-	}
-}
-
-void G2PrinterConnection::write(u32 addr, u32 size, u32 data)
-{
-	switch (addr)
-	{
-	case DATA_REG_ADDR:
-		for (u32 i = 0; i < size; i++)
-			printer::print((char)(data >> (i * 8)));
-		break;
-
-	case STATUS_REG_ADDR:
-		DEBUG_LOG(NAOMI, "Printer status = %x", data);
-		printerStat &= ~1;
-		break;
-
-	default:
-		INFO_LOG(NAOMI, "Unhandled G2 Ext write<%d> at %x: %x", size, addr, data);
-		break;
-	}
-}
-
+/*
+	This file is part of Flycast.
+
+    Flycast is free software: you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation, either version 2 of the License, or
+    (at your option) any later version.
+
+    Flycast is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with Flycast.  If not, see <https://www.gnu.org/licenses/>.
+ */
+#include "types.h"
+#include "hw/holly/sb.h"
+#include "hw/sh4/sh4_mem.h"
+#include "hw/holly/holly_intc.h"
+#include "hw/sh4/sh4_sched.h"
+#include "hw/hwreg.h"
+
+#include "naomi.h"
+#include "naomi_cart.h"
+#include "naomi_regs.h"
+#include "naomi_m3comm.h"
+#include "serialize.h"
+#include "network/output.h"
+#include "hw/sh4/modules/modules.h"
+#include "oslib/oslib.h"
+#include "printer.h"
+#include "hw/flashrom/x76f100.h"
+#include "midiffb.h"
+#include "atomiswave.h"
+#include "oslib/i18n.h"
+
+#include <algorithm>
+
+static NaomiM3Comm m3comm;
+Multiboard *multiboard;
+
+static X76F100SerialFlash mainSerialId;
+static X76F100SerialFlash romSerialId;
+
+static int dmaSchedId = -1;
+static int dmaXferDelay = 10;	// cart dma xfer speed, in cycles/byte (default 20 MB/s)
+
+void NaomiBoardIDWrite(const u16 data)
+{
+	// bit 2: clock
+	// bit 3: data
+	// bit 4: reset (x76f100 only)
+	// bit 5: chip select
+	mainSerialId.writeCS(data & 0x20);
+	mainSerialId.writeRST(data & 0x10);
+	mainSerialId.writeSCL(data & 4);
+	mainSerialId.writeSDA(data & 8);
+}
+
+u16 NaomiBoardIDRead()
+{
+	// bit 0 indicates the eeprom is a X76F100, otherwise the BIOS expects an AT93C46
+	// bit 3 is xf76f100 SDA
+	// bit 4 is at93c46 DO
+	return (mainSerialId.readSDA() << 3) | 1;
+}
+
+void NaomiGameIDWrite(const u16 data)
+{
+	romSerialId.writeCS(data & 4);
+	romSerialId.writeRST(data & 8);
+	romSerialId.writeSCL(data & 2);
+	romSerialId.writeSDA(data & 1);
+}
+
+u16 NaomiGameIDRead()
+{
+	return romSerialId.readSDA() << 15;
+}
+
+u32 ReadMem_naomi(u32 address, u32 size)
+{
+//	verify(size != 1);
+	if (unlikely(CurrentCartridge == NULL))
+	{
+		INFO_LOG(NAOMI, "called without cartridge");
+		return 0xFFFF;
+	}
+	if (address >= NAOMI_COMM2_CTRL_addr && address <= NAOMI_COMM2_STATUS1_addr)
+		return m3comm.ReadMem(address, size);
+	else
+		return CurrentCartridge->ReadMem(address, size);
+}
+
+void WriteMem_naomi(u32 address, u32 data, u32 size)
+{
+	if (unlikely(CurrentCartridge == NULL))
+	{
+		INFO_LOG(NAOMI, "called without cartridge");
+		return;
+	}
+	if (address >= NAOMI_COMM2_CTRL_addr && address <= NAOMI_COMM2_STATUS1_addr
+			&& settings.platform.isNaomi())
+		m3comm.WriteMem(address, data, size);
+	else
+		CurrentCartridge->WriteMem(address, data, size);
+}
+
+static int naomiDmaSched(int tag, int sch_cycl, int jitter, void *arg)
+{
+	u32 start = SB_GDSTARD;
+	u32 len = std::min<int>(((SB_GDLEN + 31) & ~31) - SB_GDLEND, 1024);
+	SB_GDLEND += len;
+	while (len > 0)
+	{
+		u32 block_len = len;
+		void* ptr = CurrentCartridge->GetDmaPtr(block_len);
+		if (block_len == 0)
+		{
+			INFO_LOG(NAOMI, "Aborted DMA transfer. Read past end of cart?");
+			for (u32 i = 0; i < len; i += 8, start += 8)
+				addrspace::write64(start, 0);
+			break;
+		}
+		WriteMemBlock_nommu_ptr(start, (u32*)ptr, block_len);
+		CurrentCartridge->AdvancePtr(block_len);
+		len -= block_len;
+		start += block_len;
+	}
+	SB_GDSTARD = start;
+	if (SB_GDLEN <= SB_GDLEND)
+	{
+		SB_GDST = 0;
+		asic_RaiseInterrupt(holly_GDROM_DMA);
+		return 0;
+	}
+	else {
+		return std::min<int>(SB_GDLEN - SB_GDLEND, 1024) * dmaXferDelay;
+	}
+}
+
+//Dma Start
+static void Naomi_DmaStart(u32 addr, u32 data)
+{
+	if ((data & 1) == 0 || SB_GDST == 1)
+		return;
+	if (SB_GDEN == 0)
+	{
+		INFO_LOG(NAOMI, "Invalid NAOMI-DMA start, SB_GDEN=0. Ignoring it.");
+		return;
+	}
+	
+	if (multiboard != nullptr && multiboard->dmaStart())
+	{
+	}
+	else if (!m3comm.DmaStart(addr, data) && CurrentCartridge != nullptr)
+	{
+		DEBUG_LOG(NAOMI, "NAOMI-DMA start addr %08X len %x", SB_GDSTAR, SB_GDLEN);
+		verify(1 == SB_GDDIR);
+		SB_GDST = 1;
+		SB_GDSTARD = SB_GDSTAR & 0x1FFFFFE0;
+		SB_GDLEND = 0;
+		// Max G1 bus rate: 50 MHz x 16 bits
+		// SH4_access990312_e.xls: 14.4 MB/s from GD-ROM to system RAM
+		// Here: 20 MB/s
+		sh4_sched_request(dmaSchedId, std::min<int>(SB_GDLEN, 1024) * dmaXferDelay);
+		return;
+	}
+	else
+	{
+		SB_GDSTARD = SB_GDSTAR + SB_GDLEN;
+		SB_GDLEND = SB_GDLEN;
+	}
+	asic_RaiseInterrupt(holly_GDROM_DMA);
+}
+
+void Naomi_setDmaDelay()
+{
+	if (settings.platform.isAtomiswave() || settings.content.gameId == "FORCE FIVE"
+			|| settings.content.gameId == "KENJU")
+		// 7 MB/s for Atomiwave games and conversions
+		dmaXferDelay = 27;
+	else
+		dmaXferDelay = 10;
+}
+
+static void Naomi_DmaEnable(u32 addr, u32 data)
+{
+	SB_GDEN = data & 1;
+	if (SB_GDEN == 0 && SB_GDST == 1)
+	{
+		INFO_LOG(NAOMI, "NAOMI-DMA aborted");
+		SB_GDST = 0;
+		sh4_sched_request(dmaSchedId, -1);
+	}
+}
+
+void naomi_reg_Init()
+{
+	static const u8 romSerialData[0x84] = {
+		0x19, 0x00, 0xaa, 0x55,
+		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+		0x69, 0x79, 0x68, 0x6b, 0x74, 0x6d, 0x68, 0x6d,
+		0xa1, 0x09, ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',
+		' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',  ' ', ' ', ' ', ' ',
+		'0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'
+	};
+	romSerialId.setData(romSerialData);
+	mainSerialId.setData(romSerialData);
+	if (dmaSchedId == -1)
+		dmaSchedId = sh4_sched_register(0, naomiDmaSched);
+}
+
+// Sets the full content of the rom board serial eeprom (132 bytes)
+// including response to reset and read/write passwords.
+void setGameSerialId(const u8 *data)
+{
+	romSerialId.setData(data);
+}
+
+// Return the protected data from the rom board serial eeprom (112 bytes)
+// excluding response to reset and passwords.
+const u8 *getGameSerialId()
+{
+	return romSerialId.getProtectedData();
+}
+
+void naomi_reg_Term()
+{
+	if (multiboard != nullptr)
+		delete multiboard;
+	multiboard = nullptr;
+	m3comm.closeNetwork();
+	networkOutput.term();
+	if (dmaSchedId != -1)
+		sh4_sched_unregister(dmaSchedId);
+	dmaSchedId = -1;
+	midiffb::term();
+}
+
+void naomi_reg_Reset(bool hard)
+{
+	hollyRegs.setWriteHandler<SB_GDST_addr>(Naomi_DmaStart);
+	hollyRegs.setWriteHandler<SB_GDEN_addr>(Naomi_DmaEnable);
+	SB_GDST = 0;
+	SB_GDEN = 0;
+	sh4_sched_request(dmaSchedId, -1);
+
+	atomiswave::reset();
+
+	m3comm.closeNetwork();
+	if (hard)
+	{
+		naomi_cart_Close();
+		if (multiboard != nullptr)
+		{
+			delete multiboard;
+			multiboard = nullptr;
+		}
+		if (settings.naomi.multiboard)
+			multiboard = new Multiboard();
+		networkOutput.reset();
+		mainSerialId.reset();
+		romSerialId.reset();
+	}
+	else if (multiboard != nullptr)
+		multiboard->reset();
+	midiffb::reset();
+}
+
+void naomi_Serialize(Serializer& ser)
+{
+	mainSerialId.serialize(ser);
+	romSerialId.serialize(ser);
+	atomiswave::serialize(ser);
+	// TODO serialize m3comm?
+	midiffb::serialize(ser);
+	sh4_sched_serialize(ser, dmaSchedId);
+}
+void naomi_Deserialize(Deserializer& deser)
+{
+	if (deser.version() < Deserializer::V40)
+	{
+		deser.skip<u32>();	// GSerialBuffer
+		deser.skip<u32>();	// BSerialBuffer
+		deser.skip<int>();	// GBufPos
+		deser.skip<int>();	// BBufPos
+		deser.skip<int>();	// GState
+		deser.skip<int>();	// BState
+		deser.skip<int>();	// GOldClk
+		deser.skip<int>();	// BOldClk
+		deser.skip<int>();	// BControl
+		deser.skip<int>();	// BCmd
+		deser.skip<int>();	// BLastCmd
+		deser.skip<int>();	// GControl
+		deser.skip<int>();	// GCmd
+		deser.skip<int>();	// GLastCmd
+		deser.skip<int>();	// SerStep
+		deser.skip<int>();	// SerStep2
+		deser.skip(69);		// BSerial
+		deser.skip(69);		// GSerial
+	}
+	else
+	{
+		mainSerialId.deserialize(deser);
+		romSerialId.deserialize(deser);
+	}
+	if (deser.version() < Deserializer::V36)
+	{
+		deser.skip<u32>(); // reg_dimm_command;
+		deser.skip<u32>(); // reg_dimm_offsetl;
+		deser.skip<u32>(); // reg_dimm_parameterl;
+		deser.skip<u32>(); // reg_dimm_parameterh;
+		deser.skip<u32>(); // reg_dimm_status;
+	}
+	atomiswave::deserialize(deser);
+	midiffb::deserialize(deser);
+	if (deser.version() >= Deserializer::V45)
+		sh4_sched_deserialize(deser, dmaSchedId);
+}
+
+struct DriveSimPipe : public SerialPort::Pipe
+{
+	void write(u8 data) override
+	{
+		if (buffer.empty() && data != 2)
+			return;
+		if (buffer.size() == 7)
+		{
+			u8 checksum = 0;
+			for (u8 b : buffer)
+				checksum += b;
+			if (checksum == data)
+			{
+				int newTacho = (buffer[2] - 1) * 100;
+				if (newTacho != tacho)
+				{
+					tacho = newTacho;
+					networkOutput.output("tachometer", tacho);
+				}
+				int newSpeed = buffer[3] - 1;
+				if (newSpeed != speed)
+				{
+					speed = newSpeed;
+					networkOutput.output("speedometer", speed);
+				}
+				if (!config::NetworkOutput)
+				{
+					std::string message = strprintf(i18n::T("Speed: %3d"), speed);
+					os_notify(message.c_str(), 1000);
+				}
+			}
+			buffer.clear();
+		}
+		else
+		{
+			buffer.push_back(data);
+		}
+	}
+
+	void reset()
+	{
+		buffer.clear();
+		tacho = -1;
+		speed = -1;
+	}
+private:
+	std::vector<u8> buffer;
+	int tacho = -1;
+	int speed = -1;
+};
+
+void initDriveSimSerialPipe()
+{
+	static DriveSimPipe pipe;
+
+	pipe.reset();
+	SCIFSerialPort::Instance().setPipe(&pipe);
+}
+
+G2PrinterConnection g2PrinterConnection;
+
+u32 G2PrinterConnection::read(u32 addr, u32 size)
+{
+	if (addr == STATUS_REG_ADDR)
+	{
+		u32 ret = printerStat;
+		printerStat |= 1;
+		DEBUG_LOG(NAOMI, "Printer status == %x", ret);
+		return ret;
+	}
+	else
+	{
+		INFO_LOG(NAOMI, "Unhandled G2 Ext read<%d> at %x", size, addr);
+		return 0;
+	}
+}
+
+void G2PrinterConnection::write(u32 addr, u32 size, u32 data)
+{
+	switch (addr)
+	{
+	case DATA_REG_ADDR:
+		for (u32 i = 0; i < size; i++)
+			printer::print((char)(data >> (i * 8)));
+		break;
+
+	case STATUS_REG_ADDR:
+		DEBUG_LOG(NAOMI, "Printer status = %x", data);
+		printerStat &= ~1;
+		break;
+
+	default:
+		INFO_LOG(NAOMI, "Unhandled G2 Ext write<%d> at %x: %x", size, addr, data);
+		break;
+	}
+}
+
diff --git a/core/hw/pvr/Renderer_if.cpp b/core/hw/pvr/Renderer_if.cpp
index 4fbb9a5..b793b4d 100644
--- a/core/hw/pvr/Renderer_if.cpp
+++ b/core/hw/pvr/Renderer_if.cpp
@@ -1,559 +1,559 @@
-#include "Renderer_if.h"
-#include "spg.h"
-#include "rend/texconv.h"
-#include "rend/transform_matrix.h"
-#include "cfg/option.h"
-#include "emulator.h"
-#include "serialize.h"
-#include "hw/holly/holly_intc.h"
-#include "hw/sh4/sh4_if.h"
-#include "hw/sh4/sh4_core.h"
-#include "profiler/fc_profiler.h"
-#include "network/ggpo.h"
-
-#include <mutex>
-#include <deque>
-
-#ifdef LIBRETRO
-void retro_rend_present();
-void retro_resize_renderer(int w, int h, float aspectRatio);
-#endif
-
-u32 FrameCount=1;
-
-Renderer* renderer;
-
-static cResetEvent renderEnd;
-u32 fb_w_cur = 1;
-static cResetEvent vramRollback;
-
-// direct framebuffer write detection
-static bool render_called = false;
-u32 fb_watch_addr_start;
-u32 fb_watch_addr_end;
-bool fb_dirty;
-
-static bool pend_rend;
-static bool rendererEnabled = true;
-
-static bool presented;
-static u32 fbAddrHistory[2] { 1, 1 };
-
-class PvrMessageQueue
-{
-	using lock_guard = std::lock_guard<std::mutex>;
-
-public:
-	enum MessageType { NoMessage = -1, Render, RenderFramebuffer, Present, Stop };
-	struct Message
-	{
-		Message() = default;
-		Message(MessageType type, FramebufferInfo config)
-			: type(type), config(config) {}
-
-		MessageType type = NoMessage;
-		FramebufferInfo config;
-	};
-
-	void enqueue(MessageType type, FramebufferInfo config = FramebufferInfo())
-	{
-		Message msg { type, config };
-		if (config::ThreadedRendering)
-		{
-			// FIXME need some synchronization to avoid blinking in densha de go
-			// or use !threaded rendering for emufb?
-			// or read framebuffer vram on emu thread
-			bool dupe;
-			do {
-				dupe = false;
-				{
-					const lock_guard lock(mutex);
-					for (const auto& m : queue)
-						if (m.type == type) {
-							dupe = true;
-							break;
-						}
-					if (!dupe || type == Present) {
-						queue.push_back(msg);
-						dupe = false;
-					}
-				}
-				if (dupe)
-				{
-					if (type == Stop)
-						return;
-					dequeueEvent.Wait();
-				}
-			} while (dupe);
-			enqueueEvent.Set();
-		}
-		else
-		{
-			setDefaultRoundingMode();
-			// drain the queue after switching to !threaded rendering
-			while (!queue.empty())
-				waitAndExecute();
-			execute(msg);
-			Sh4cntx.restoreHostRoundingMode();
-		}
-	}
-
-	bool waitAndExecute(int timeoutMs = -1)
-	{
-		return execute(dequeue(timeoutMs));
-	}
-
-	void reset() {
-		const lock_guard lock(mutex);
-		queue.clear();
-	}
-
-	void cancelEnqueue()
-	{
-		const lock_guard lock(mutex);
-		for (auto it = queue.begin(); it != queue.end(); )
-		{
-			if (it->type != Render)
-				it = queue.erase(it);
-			else
-				++it;
-		}
-		dequeueEvent.Set();
-	}
-private:
-	Message dequeue(int timeoutMs = -1)
-	{
-		FC_PROFILE_SCOPE;
-
-		Message msg;
-		while (true)
-		{
-			{
-				const lock_guard lock(mutex);
-				if (!queue.empty())
-				{
-					msg = queue.front();
-					queue.pop_front();
-				}
-			}
-			if (msg.type != NoMessage) {
-				dequeueEvent.Set();
-				break;
-			}
-			if (timeoutMs == -1)
-				enqueueEvent.Wait();
-			else if (!enqueueEvent.Wait(timeoutMs))
-				break;
-		}
-		return msg;
-	}
-
-	bool execute(Message msg)
-	{
-		switch (msg.type)
-		{
-		case Render:
-			render();
-			return true;
-		case RenderFramebuffer:
-			renderFramebuffer(msg.config);
-			return true;
-		case Present:
-			present();
-			return true;
-		case Stop:
-		case NoMessage:
-		default:
-			return false;
-		}
-	}
-
-	void render()
-	{
-		FC_PROFILE_SCOPE;
-
-		TA_context *taContext = DequeueRender();
-		if (taContext == nullptr)
-			return;
-
-		if (!taContext->rend.isRTT)
-		{
-			int width, height;
-			getScaledFramebufferSize(taContext->rend, width, height);
-			taContext->rend.framebufferWidth = width;
-			taContext->rend.framebufferHeight = height;
-		}
-		bool renderToScreen = !taContext->rend.isRTT && !config::EmulateFramebuffer;
-#ifdef LIBRETRO
-		if (renderToScreen)
-			retro_resize_renderer(taContext->rend.framebufferWidth, taContext->rend.framebufferHeight,
-					getOutputFramebufferAspectRatio());
-#endif
-		{
-			FC_PROFILE_SCOPE_NAMED("Renderer::Process");
-			try {
-				renderer->Process(taContext);
-			} catch (...) {
-				renderEnd.Set();
-				rend_allow_rollback();
-				FinishRender(taContext);
-				throw;
-			}
-		}
-
-		if (renderToScreen)
-			// If rendering to texture or in full framebuffer emulation, continue locking until the frame is rendered
-			renderEnd.Set();
-		rend_allow_rollback();
-		{
-			FC_PROFILE_SCOPE_NAMED("Renderer::Render");
-			try {
-				renderer->Render();
-			} catch (...) {
-				if (!renderToScreen)
-					renderEnd.Set();
-				FinishRender(taContext);
-				throw;
-			}
-		}
-
-		if (!renderToScreen)
-			renderEnd.Set();
-		else if (config::DelayFrameSwapping && fb_w_cur == FB_R_SOF1)
-			present();
-
-		//clear up & free data ..
-		FinishRender(taContext);
-	}
-
-	void renderFramebuffer(const FramebufferInfo& config)
-	{
-		FC_PROFILE_SCOPE;
-
-#ifdef LIBRETRO
-		int w, h;
-		getDCFramebufferReadSize(config, w, h);
-		retro_resize_renderer(w, h, getDCFramebufferAspectRatio());
-#endif
-		renderer->RenderFramebuffer(config);
-	}
-
-	void present()
-	{
-		FC_PROFILE_SCOPE;
-
-		if (renderer->Present())
-		{
-			presented = true;
-			if (!config::ThreadedRendering && !ggpo::active())
-				emu.getSh4Executor()->Stop();
-#ifdef LIBRETRO
-			retro_rend_present();
-#endif
-		}
-	}
-
-	std::mutex mutex;
-	cResetEvent enqueueEvent;
-	cResetEvent dequeueEvent;
-	std::deque<Message> queue;
-};
-
-static PvrMessageQueue pvrQueue;
-
-bool rend_single_frame(const bool& enabled)
-{
-	FC_PROFILE_SCOPE;
-
-	const int timeout = SPG_CONTROL.isPAL() ? 23 : 20;
-	presented = false;
-	while (enabled && !presented)
-		if (!pvrQueue.waitAndExecute(timeout))
-			return false;
-	return true;
-}
-
-Renderer* rend_GLES2();
-Renderer* rend_GL4();
-Renderer* rend_norend();
-Renderer* rend_Vulkan();
-Renderer* rend_OITVulkan();
-Renderer* rend_DirectX9();
-Renderer* rend_DirectX11();
-Renderer* rend_OITDirectX11();
-
-static void rend_create_renderer()
-{
-#ifdef NO_REND
-	renderer	 = rend_norend();
-#else
-	switch (config::RendererType)
-	{
-	default:
-#ifdef USE_OPENGL
-	case RenderType::OpenGL:
-		renderer = rend_GLES2();
-		break;
-#if !defined(GLES2) && !defined(__APPLE__)
-	case RenderType::OpenGL_OIT:
-		renderer = rend_GL4();
-		break;
-#endif
-#endif
-#ifdef USE_VULKAN
-	case RenderType::Vulkan:
-		renderer = rend_Vulkan();
-		break;
-	case RenderType::Vulkan_OIT:
-		renderer = rend_OITVulkan();
-		break;
-#endif
-#ifdef USE_DX9
-	case RenderType::DirectX9:
-		renderer = rend_DirectX9();
-		break;
-#endif
-#ifdef USE_DX11
-	case RenderType::DirectX11:
-		renderer = rend_DirectX11();
-		break;
-	case RenderType::DirectX11_OIT:
-		renderer = rend_OITDirectX11();
-		break;
-#endif
-	}
-#endif
-}
-
-bool rend_init_renderer()
-{
-	rendererEnabled = true;
-	if (renderer == nullptr)
-		rend_create_renderer();
-	bool success = renderer != nullptr && renderer->Init();
-	if (!success) {
-		delete renderer;
-		renderer = rend_norend();
-		renderer->Init();
-	}
-	return success;
-}
-
-void rend_term_renderer()
-{
-	if (renderer != nullptr)
-	{
-		renderer->Term();
-		delete renderer;
-		renderer = nullptr;
-	}
-}
-
-void rend_reset()
-{
-	FinishRender(DequeueRender());
-	render_called = false;
-	pend_rend = false;
-	FrameCount = 1;
-	fb_w_cur = 1;
-	pvrQueue.reset();
-	rendererEnabled = true;
-	fbAddrHistory[0] = 1;
-	fbAddrHistory[1] = 1;
-}
-
-void rend_start_render()
-{
-	render_called = true;
-	pend_rend = false;
-
-	TA_context *ctx = nullptr;
-	u32 addresses[MAX_PASSES];
-	int count = getTAContextAddresses(addresses);
-	if (count > 0)
-	{
-		ctx = tactx_Pop(addresses[0]);
-		if (ctx != nullptr)
-		{
-			TA_context *linkedCtx = ctx;
-			for (int i = 1; i < count; i++)
-			{
-				linkedCtx->nextContext = tactx_Pop(addresses[i]);
-				if (linkedCtx->nextContext != nullptr)
-					linkedCtx = linkedCtx->nextContext;
-				else
-					INFO_LOG(PVR, "rend_start_render: Context%d @ %x not found", i, addresses[i]);
-			}
-		}
-		else
-			INFO_LOG(PVR, "rend_start_render: Context0 @ %x not found", addresses[0]);
-	}
-	else
-		INFO_LOG(PVR, "rend_start_render: No context not found");
-
-	scheduleRenderDone(ctx);
-
-	if (ctx == nullptr)
-		return;
-
-	FillBGP(ctx);
-
-	ctx->rend.isRTT = (FB_W_SOF1 & 0x1000000) != 0;
-	ctx->rend.fb_W_SOF1 = FB_W_SOF1;
-	ctx->rend.fb_W_CTRL.full = FB_W_CTRL.full;
-
-	ctx->rend.ta_GLOB_TILE_CLIP = TA_GLOB_TILE_CLIP;
-	ctx->rend.scaler_ctl = SCALER_CTL;
-	ctx->rend.fb_X_CLIP = FB_X_CLIP;
-	ctx->rend.fb_Y_CLIP = FB_Y_CLIP;
-	ctx->rend.fb_W_LINESTRIDE = FB_W_LINESTRIDE.stride;
-
-	ctx->rend.fog_clamp_min = FOG_CLAMP_MIN;
-	ctx->rend.fog_clamp_max = FOG_CLAMP_MAX;
-
-	if (!ctx->rend.isRTT)
-	{
-		if (FB_W_SOF1 != fbAddrHistory[0] && FB_W_SOF1 != fbAddrHistory[1])
-		{
-			ctx->rend.clearFramebuffer = true;
-			fbAddrHistory[0] = fbAddrHistory[1];
-			fbAddrHistory[1] = FB_W_SOF1;
-		}
-		else {
-			ctx->rend.clearFramebuffer = false;
-		}
-		ggpo::endOfFrame();
-	}
-
-	if (QueueRender(ctx))
-	{
-		palette_update();
-		pend_rend = true;
-		pvrQueue.enqueue(PvrMessageQueue::Render);
-		if (!config::DelayFrameSwapping && !ctx->rend.isRTT && !config::EmulateFramebuffer)
-			pvrQueue.enqueue(PvrMessageQueue::Present);
-	}
-}
-
-int rend_end_render(int tag, int cycles, int jitter, void *arg)
-{
-	if (settings.platform.isNaomi2())
-	{
-		asic_RaiseInterruptBothCLX(holly_RENDER_DONE);
-		asic_RaiseInterruptBothCLX(holly_RENDER_DONE_isp);
-		asic_RaiseInterruptBothCLX(holly_RENDER_DONE_vd);
-	}
-	else
-	{
-		asic_RaiseInterrupt(holly_RENDER_DONE);
-		asic_RaiseInterrupt(holly_RENDER_DONE_isp);
-		asic_RaiseInterrupt(holly_RENDER_DONE_vd);
-	}
-	if (pend_rend && config::ThreadedRendering)
-		renderEnd.Wait();
-
-	return 0;
-}
-
-void rend_vblank()
-{
-	if (config::EmulateFramebuffer
-			|| (!render_called && fb_dirty && FB_R_CTRL.fb_enable))
-	{
-		if (rend_is_enabled())
-		{
-			FramebufferInfo fbInfo;
-			fbInfo.update();
-			pvrQueue.enqueue(PvrMessageQueue::RenderFramebuffer, fbInfo);
-			pvrQueue.enqueue(PvrMessageQueue::Present);
-			if (!config::EmulateFramebuffer)
-				DEBUG_LOG(PVR, "Direct framebuffer write detected");
-		}
-		fb_dirty = false;
-	}
-	render_called = false;
-	check_framebuffer_write();
-	emu.vblank();
-}
-
-void check_framebuffer_write()
-{
-	u32 fb_size = (FB_R_SIZE.fb_y_size + 1) * (FB_R_SIZE.fb_x_size + FB_R_SIZE.fb_modulus) * 4;
-	fb_watch_addr_start = (SPG_CONTROL.interlace ? FB_R_SOF2 : FB_R_SOF1) & VRAM_MASK;
-	fb_watch_addr_end = fb_watch_addr_start + fb_size;
-}
-
-void rend_cancel_emu_wait()
-{
-	if (config::ThreadedRendering)
-	{
-		FinishRender(NULL);
-		renderEnd.Set();
-		rend_allow_rollback();
-		pvrQueue.cancelEnqueue();
-		// Needed for android where this function may be called
-		// from a thread different from the UI one
-		pvrQueue.enqueue(PvrMessageQueue::Stop);
-	}
-}
-
-void rend_set_fb_write_addr(u32 fb_w_sof1)
-{
-	if (fb_w_sof1 & 0x1000000)
-		// render to texture
-		return;
-	fb_w_cur = fb_w_sof1;
-}
-
-void rend_swap_frame(u32 fb_r_sof)
-{
-	if (!config::EmulateFramebuffer && fb_r_sof == fb_w_cur && rend_is_enabled())
-		pvrQueue.enqueue(PvrMessageQueue::Present);
-}
-
-void rend_disable_rollback()
-{
-	vramRollback.Reset();
-}
-
-void rend_allow_rollback()
-{
-	vramRollback.Set();
-}
-
-void rend_start_rollback()
-{
-	if (config::ThreadedRendering)
-		vramRollback.Wait();
-}
-
-void rend_enable_renderer(bool enabled) {
-	rendererEnabled = enabled;
-}
-
-bool rend_is_enabled() {
-	return rendererEnabled;
-}
-
-void rend_serialize(Serializer& ser)
-{
-	ser << fb_w_cur;
-	ser << render_called;
-	ser << fb_dirty;
-	ser << fb_watch_addr_start;
-	ser << fb_watch_addr_end;
-}
-void rend_deserialize(Deserializer& deser)
-{
-	deser >> fb_w_cur;
-	if (deser.version() >= Deserializer::V20)
-	{
-		deser >> render_called;
-		deser >> fb_dirty;
-		deser >> fb_watch_addr_start;
-		deser >> fb_watch_addr_end;
-	}
-	pend_rend = false;
-	fbAddrHistory[0] = 1;
-	fbAddrHistory[1] = 1;
-}
+#include "Renderer_if.h"
+#include "spg.h"
+#include "rend/texconv.h"
+#include "rend/transform_matrix.h"
+#include "cfg/option.h"
+#include "emulator.h"
+#include "serialize.h"
+#include "hw/holly/holly_intc.h"
+#include "hw/sh4/sh4_if.h"
+#include "hw/sh4/sh4_core.h"
+#include "profiler/fc_profiler.h"
+#include "network/ggpo.h"
+
+#include <mutex>
+#include <deque>
+
+#ifdef LIBRETRO
+void retro_rend_present();
+void retro_resize_renderer(int w, int h, float aspectRatio);
+#endif
+
+u32 FrameCount=1;
+
+Renderer* renderer;
+
+static cResetEvent renderEnd;
+u32 fb_w_cur = 1;
+static cResetEvent vramRollback;
+
+// direct framebuffer write detection
+static bool render_called = false;
+u32 fb_watch_addr_start;
+u32 fb_watch_addr_end;
+bool fb_dirty;
+
+static bool pend_rend;
+static bool rendererEnabled = true;
+
+static bool presented;
+static u32 fbAddrHistory[2] { 1, 1 };
+
+class PvrMessageQueue
+{
+	using lock_guard = std::lock_guard<std::mutex>;
+
+public:
+	enum MessageType { NoMessage = -1, Render, RenderFramebuffer, Present, Stop };
+	struct Message
+	{
+		Message() = default;
+		Message(MessageType type, FramebufferInfo config)
+			: type(type), config(config) {}
+
+		MessageType type = NoMessage;
+		FramebufferInfo config;
+	};
+
+	void enqueue(MessageType type, FramebufferInfo config = FramebufferInfo())
+	{
+		Message msg { type, config };
+		if (config::ThreadedRendering)
+		{
+			// FIXME need some synchronization to avoid blinking in densha de go
+			// or use !threaded rendering for emufb?
+			// or read framebuffer vram on emu thread
+			bool dupe;
+			do {
+				dupe = false;
+				{
+					const lock_guard lock(mutex);
+					for (const auto& m : queue)
+						if (m.type == type) {
+							dupe = true;
+							break;
+						}
+					if (!dupe || type == Present) {
+						queue.push_back(msg);
+						dupe = false;
+					}
+				}
+				if (dupe)
+				{
+					if (type == Stop)
+						return;
+					dequeueEvent.Wait();
+				}
+			} while (dupe);
+			enqueueEvent.Set();
+		}
+		else
+		{
+			setDefaultRoundingMode();
+			// drain the queue after switching to !threaded rendering
+			while (!queue.empty())
+				waitAndExecute();
+			execute(msg);
+			Sh4cntx.restoreHostRoundingMode();
+		}
+	}
+
+	bool waitAndExecute(int timeoutMs = -1)
+	{
+		return execute(dequeue(timeoutMs));
+	}
+
+	void reset() {
+		const lock_guard lock(mutex);
+		queue.clear();
+	}
+
+	void cancelEnqueue()
+	{
+		const lock_guard lock(mutex);
+		for (auto it = queue.begin(); it != queue.end(); )
+		{
+			if (it->type != Render)
+				it = queue.erase(it);
+			else
+				++it;
+		}
+		dequeueEvent.Set();
+	}
+private:
+	Message dequeue(int timeoutMs = -1)
+	{
+		FC_PROFILE_SCOPE;
+
+		Message msg;
+		while (true)
+		{
+			{
+				const lock_guard lock(mutex);
+				if (!queue.empty())
+				{
+					msg = queue.front();
+					queue.pop_front();
+				}
+			}
+			if (msg.type != NoMessage) {
+				dequeueEvent.Set();
+				break;
+			}
+			if (timeoutMs == -1)
+				enqueueEvent.Wait();
+			else if (!enqueueEvent.Wait(timeoutMs))
+				break;
+		}
+		return msg;
+	}
+
+	bool execute(Message msg)
+	{
+		switch (msg.type)
+		{
+		case Render:
+			render();
+			return true;
+		case RenderFramebuffer:
+			renderFramebuffer(msg.config);
+			return true;
+		case Present:
+			present();
+			return true;
+		case Stop:
+		case NoMessage:
+		default:
+			return false;
+		}
+	}
+
+	void render()
+	{
+		FC_PROFILE_SCOPE;
+
+		TA_context *taContext = DequeueRender();
+		if (taContext == nullptr)
+			return;
+
+		if (!taContext->rend.isRTT)
+		{
+			int width, height;
+			getScaledFramebufferSize(taContext->rend, width, height);
+			taContext->rend.framebufferWidth = width;
+			taContext->rend.framebufferHeight = height;
+		}
+		bool renderToScreen = !taContext->rend.isRTT && !config::EmulateFramebuffer;
+#ifdef LIBRETRO
+		if (renderToScreen)
+			retro_resize_renderer(taContext->rend.framebufferWidth, taContext->rend.framebufferHeight,
+					getOutputFramebufferAspectRatio());
+#endif
+		{
+			FC_PROFILE_SCOPE_NAMED("Renderer::Process");
+			try {
+				renderer->Process(taContext);
+			} catch (...) {
+				renderEnd.Set();
+				rend_allow_rollback();
+				FinishRender(taContext);
+				throw;
+			}
+		}
+
+		if (renderToScreen)
+			// If rendering to texture or in full framebuffer emulation, continue locking until the frame is rendered
+			renderEnd.Set();
+		rend_allow_rollback();
+		{
+			FC_PROFILE_SCOPE_NAMED("Renderer::Render");
+			try {
+				renderer->Render();
+			} catch (...) {
+				if (!renderToScreen)
+					renderEnd.Set();
+				FinishRender(taContext);
+				throw;
+			}
+		}
+
+		if (!renderToScreen)
+			renderEnd.Set();
+		else if (config::DelayFrameSwapping && fb_w_cur == FB_R_SOF1)
+			present();
+
+		//clear up & free data ..
+		FinishRender(taContext);
+	}
+
+	void renderFramebuffer(const FramebufferInfo& config)
+	{
+		FC_PROFILE_SCOPE;
+
+#ifdef LIBRETRO
+		int w, h;
+		getDCFramebufferReadSize(config, w, h);
+		retro_resize_renderer(w, h, getDCFramebufferAspectRatio());
+#endif
+		renderer->RenderFramebuffer(config);
+	}
+
+	void present()
+	{
+		FC_PROFILE_SCOPE;
+
+		if (renderer->Present())
+		{
+			presented = true;
+			if (!config::ThreadedRendering && !ggpo::active())
+				emu.getSh4Executor()->Stop();
+#ifdef LIBRETRO
+			retro_rend_present();
+#endif
+		}
+	}
+
+	std::mutex mutex;
+	cResetEvent enqueueEvent;
+	cResetEvent dequeueEvent;
+	std::deque<Message> queue;
+};
+
+static PvrMessageQueue pvrQueue;
+
+bool rend_single_frame(const bool& enabled)
+{
+	FC_PROFILE_SCOPE;
+
+	const int timeout = SPG_CONTROL.isPAL() ? 23 : 20;
+	presented = false;
+	while (enabled && !presented)
+		if (!pvrQueue.waitAndExecute(timeout))
+			return false;
+	return true;
+}
+
+Renderer* rend_GLES2();
+Renderer* rend_GL4();
+Renderer* rend_norend();
+Renderer* rend_Vulkan();
+Renderer* rend_OITVulkan();
+Renderer* rend_DirectX9();
+Renderer* rend_DirectX11();
+Renderer* rend_OITDirectX11();
+
+static void rend_create_renderer()
+{
+#ifdef NO_REND
+	renderer	 = rend_norend();
+#else
+	switch (config::RendererType)
+	{
+	default:
+#ifdef USE_OPENGL
+	case RenderType::OpenGL:
+		renderer = rend_GLES2();
+		break;
+#if !defined(GLES2) && !defined(__APPLE__)
+	case RenderType::OpenGL_OIT:
+		renderer = rend_GL4();
+		break;
+#endif
+#endif
+#ifdef USE_VULKAN
+	case RenderType::Vulkan:
+		renderer = rend_Vulkan();
+		break;
+	case RenderType::Vulkan_OIT:
+		renderer = rend_OITVulkan();
+		break;
+#endif
+#ifdef USE_DX9
+	case RenderType::DirectX9:
+		renderer = rend_DirectX9();
+		break;
+#endif
+#ifdef USE_DX11
+	case RenderType::DirectX11:
+		renderer = rend_DirectX11();
+		break;
+	case RenderType::DirectX11_OIT:
+		renderer = rend_OITDirectX11();
+		break;
+#endif
+	}
+#endif
+}
+
+bool rend_init_renderer()
+{
+	rendererEnabled = true;
+	if (renderer == nullptr)
+		rend_create_renderer();
+	bool success = renderer != nullptr && renderer->Init();
+	if (!success) {
+		delete renderer;
+		renderer = rend_norend();
+		renderer->Init();
+	}
+	return success;
+}
+
+void rend_term_renderer()
+{
+	if (renderer != nullptr)
+	{
+		renderer->Term();
+		delete renderer;
+		renderer = nullptr;
+	}
+}
+
+void rend_reset()
+{
+	FinishRender(DequeueRender());
+	render_called = false;
+	pend_rend = false;
+	FrameCount = 1;
+	fb_w_cur = 1;
+	pvrQueue.reset();
+	rendererEnabled = true;
+	fbAddrHistory[0] = 1;
+	fbAddrHistory[1] = 1;
+}
+
+void rend_start_render()
+{
+	render_called = true;
+	pend_rend = false;
+
+	TA_context *ctx = nullptr;
+	u32 addresses[MAX_PASSES];
+	int count = getTAContextAddresses(addresses);
+	if (count > 0)
+	{
+		ctx = tactx_Pop(addresses[0]);
+		if (ctx != nullptr)
+		{
+			TA_context *linkedCtx = ctx;
+			for (int i = 1; i < count; i++)
+			{
+				linkedCtx->nextContext = tactx_Pop(addresses[i]);
+				if (linkedCtx->nextContext != nullptr)
+					linkedCtx = linkedCtx->nextContext;
+				else
+					INFO_LOG(PVR, "rend_start_render: Context%d @ %x not found", i, addresses[i]);
+			}
+		}
+		else
+			INFO_LOG(PVR, "rend_start_render: Context0 @ %x not found", addresses[0]);
+	}
+	else
+		INFO_LOG(PVR, "rend_start_render: No context not found");
+
+	scheduleRenderDone(ctx);
+
+	if (ctx == nullptr)
+		return;
+
+	FillBGP(ctx);
+
+	ctx->rend.isRTT = (FB_W_SOF1 & 0x1000000) != 0;
+	ctx->rend.fb_W_SOF1 = FB_W_SOF1;
+	ctx->rend.fb_W_CTRL.full = FB_W_CTRL.full;
+
+	ctx->rend.ta_GLOB_TILE_CLIP = TA_GLOB_TILE_CLIP;
+	ctx->rend.scaler_ctl = SCALER_CTL;
+	ctx->rend.fb_X_CLIP = FB_X_CLIP;
+	ctx->rend.fb_Y_CLIP = FB_Y_CLIP;
+	ctx->rend.fb_W_LINESTRIDE = FB_W_LINESTRIDE.stride;
+
+	ctx->rend.fog_clamp_min = FOG_CLAMP_MIN;
+	ctx->rend.fog_clamp_max = FOG_CLAMP_MAX;
+
+	if (!ctx->rend.isRTT)
+	{
+		if (FB_W_SOF1 != fbAddrHistory[0] && FB_W_SOF1 != fbAddrHistory[1])
+		{
+			ctx->rend.clearFramebuffer = true;
+			fbAddrHistory[0] = fbAddrHistory[1];
+			fbAddrHistory[1] = FB_W_SOF1;
+		}
+		else {
+			ctx->rend.clearFramebuffer = false;
+		}
+		ggpo::endOfFrame();
+	}
+
+	if (QueueRender(ctx))
+	{
+		palette_update();
+		pend_rend = true;
+		pvrQueue.enqueue(PvrMessageQueue::Render);
+		if (!config::DelayFrameSwapping && !ctx->rend.isRTT && !config::EmulateFramebuffer)
+			pvrQueue.enqueue(PvrMessageQueue::Present);
+	}
+}
+
+int rend_end_render(int tag, int cycles, int jitter, void *arg)
+{
+	if (settings.platform.isNaomi2())
+	{
+		asic_RaiseInterruptBothCLX(holly_RENDER_DONE);
+		asic_RaiseInterruptBothCLX(holly_RENDER_DONE_isp);
+		asic_RaiseInterruptBothCLX(holly_RENDER_DONE_vd);
+	}
+	else
+	{
+		asic_RaiseInterrupt(holly_RENDER_DONE);
+		asic_RaiseInterrupt(holly_RENDER_DONE_isp);
+		asic_RaiseInterrupt(holly_RENDER_DONE_vd);
+	}
+	if (pend_rend && config::ThreadedRendering)
+		renderEnd.Wait();
+
+	return 0;
+}
+
+void rend_vblank()
+{
+	if (config::EmulateFramebuffer
+			|| (!render_called && fb_dirty && FB_R_CTRL.fb_enable))
+	{
+		if (rend_is_enabled())
+		{
+			FramebufferInfo fbInfo;
+			fbInfo.update();
+			pvrQueue.enqueue(PvrMessageQueue::RenderFramebuffer, fbInfo);
+			pvrQueue.enqueue(PvrMessageQueue::Present);
+			if (!config::EmulateFramebuffer)
+				DEBUG_LOG(PVR, "Direct framebuffer write detected");
+		}
+		fb_dirty = false;
+	}
+	render_called = false;
+	check_framebuffer_write();
+	emu.vblank();
+}
+
+void check_framebuffer_write()
+{
+	u32 fb_size = (FB_R_SIZE.fb_y_size + 1) * (FB_R_SIZE.fb_x_size + FB_R_SIZE.fb_modulus) * 4;
+	fb_watch_addr_start = (SPG_CONTROL.interlace ? FB_R_SOF2 : FB_R_SOF1) & VRAM_MASK;
+	fb_watch_addr_end = fb_watch_addr_start + fb_size;
+}
+
+void rend_cancel_emu_wait()
+{
+	if (config::ThreadedRendering)
+	{
+		FinishRender(NULL);
+		renderEnd.Set();
+		rend_allow_rollback();
+		pvrQueue.cancelEnqueue();
+		// Needed for android where this function may be called
+		// from a thread different from the UI one
+		pvrQueue.enqueue(PvrMessageQueue::Stop);
+	}
+}
+
+void rend_set_fb_write_addr(u32 fb_w_sof1)
+{
+	if (fb_w_sof1 & 0x1000000)
+		// render to texture
+		return;
+	fb_w_cur = fb_w_sof1;
+}
+
+void rend_swap_frame(u32 fb_r_sof)
+{
+	if (!config::EmulateFramebuffer && fb_r_sof == fb_w_cur && rend_is_enabled())
+		pvrQueue.enqueue(PvrMessageQueue::Present);
+}
+
+void rend_disable_rollback()
+{
+	vramRollback.Reset();
+}
+
+void rend_allow_rollback()
+{
+	vramRollback.Set();
+}
+
+void rend_start_rollback()
+{
+	if (config::ThreadedRendering)
+		vramRollback.Wait();
+}
+
+void rend_enable_renderer(bool enabled) {
+	rendererEnabled = enabled;
+}
+
+bool rend_is_enabled() {
+	return rendererEnabled;
+}
+
+void rend_serialize(Serializer& ser)
+{
+	ser << fb_w_cur;
+	ser << render_called;
+	ser << fb_dirty;
+	ser << fb_watch_addr_start;
+	ser << fb_watch_addr_end;
+}
+void rend_deserialize(Deserializer& deser)
+{
+	deser >> fb_w_cur;
+	if (deser.version() >= Deserializer::V20)
+	{
+		deser >> render_called;
+		deser >> fb_dirty;
+		deser >> fb_watch_addr_start;
+		deser >> fb_watch_addr_end;
+	}
+	pend_rend = false;
+	fbAddrHistory[0] = 1;
+	fbAddrHistory[1] = 1;
+}
diff --git a/core/hw/pvr/pvr_regs.cpp b/core/hw/pvr/pvr_regs.cpp
index 0538b3c..a29677e 100644
--- a/core/hw/pvr/pvr_regs.cpp
+++ b/core/hw/pvr/pvr_regs.cpp
@@ -1,254 +1,254 @@
-#include "pvr_regs.h"
-#include "pvr_mem.h"
-#include "Renderer_if.h"
-#include "ta.h"
-#include "spg.h"
-#include <map>
-
-bool pal_needs_update=true;
-
-u8 pvr_regs[pvr_RegSize];
-
-#define PVR_REG_NAME(r) { r##_addr, #r },
-const std::map<u32, const char *> pvr_reg_names = {
-		PVR_REG_NAME(ID)
-		PVR_REG_NAME(REVISION)
-		PVR_REG_NAME(SOFTRESET)
-		PVR_REG_NAME(STARTRENDER)
-		PVR_REG_NAME(TEST_SELECT)
-		PVR_REG_NAME(PARAM_BASE)
-		PVR_REG_NAME(REGION_BASE)
-		PVR_REG_NAME(SPAN_SORT_CFG)
-		PVR_REG_NAME(VO_BORDER_COL)
-		PVR_REG_NAME(FB_R_CTRL)
-		PVR_REG_NAME(FB_W_CTRL)
-		PVR_REG_NAME(FB_W_LINESTRIDE)
-		PVR_REG_NAME(FB_R_SOF1)
-		PVR_REG_NAME(FB_R_SOF2)
-		PVR_REG_NAME(FB_R_SIZE)
-		PVR_REG_NAME(FB_W_SOF1)
-		PVR_REG_NAME(FB_W_SOF2)
-		PVR_REG_NAME(FB_X_CLIP)
-		PVR_REG_NAME(FB_Y_CLIP)
-		PVR_REG_NAME(FPU_SHAD_SCALE)
-		PVR_REG_NAME(FPU_CULL_VAL)
-		PVR_REG_NAME(FPU_PARAM_CFG)
-		PVR_REG_NAME(HALF_OFFSET)
-		PVR_REG_NAME(FPU_PERP_VAL)
-		PVR_REG_NAME(ISP_BACKGND_D)
-		PVR_REG_NAME(ISP_BACKGND_T)
-		PVR_REG_NAME(ISP_FEED_CFG)
-		PVR_REG_NAME(SDRAM_REFRESH)
-		PVR_REG_NAME(SDRAM_ARB_CFG)
-		PVR_REG_NAME(SDRAM_CFG)
-		PVR_REG_NAME(FOG_COL_RAM)
-		PVR_REG_NAME(FOG_COL_VERT)
-		PVR_REG_NAME(FOG_DENSITY)
-		PVR_REG_NAME(FOG_CLAMP_MAX)
-		PVR_REG_NAME(FOG_CLAMP_MIN)
-		PVR_REG_NAME(SPG_TRIGGER_POS)
-		PVR_REG_NAME(SPG_HBLANK_INT)
-		PVR_REG_NAME(SPG_VBLANK_INT)
-		PVR_REG_NAME(SPG_CONTROL)
-		PVR_REG_NAME(SPG_HBLANK)
-		PVR_REG_NAME(SPG_LOAD)
-		PVR_REG_NAME(SPG_VBLANK)
-		PVR_REG_NAME(SPG_WIDTH)
-		PVR_REG_NAME(TEXT_CONTROL)
-		PVR_REG_NAME(VO_CONTROL)
-		PVR_REG_NAME(VO_STARTX)
-		PVR_REG_NAME(VO_STARTY)
-		PVR_REG_NAME(SCALER_CTL)
-		PVR_REG_NAME(PAL_RAM_CTRL)
-		PVR_REG_NAME(SPG_STATUS)
-		PVR_REG_NAME(FB_BURSTCTRL)
-		PVR_REG_NAME(FB_C_SOF)
-		PVR_REG_NAME(Y_COEFF)
-		PVR_REG_NAME(PT_ALPHA_REF)
-		PVR_REG_NAME(TA_OL_BASE)
-		PVR_REG_NAME(TA_ISP_BASE)
-		PVR_REG_NAME(TA_OL_LIMIT)
-		PVR_REG_NAME(TA_ISP_LIMIT)
-		PVR_REG_NAME(TA_NEXT_OPB)
-		PVR_REG_NAME(TA_ITP_CURRENT)
-		PVR_REG_NAME(TA_GLOB_TILE_CLIP)
-		PVR_REG_NAME(TA_ALLOC_CTRL)
-		PVR_REG_NAME(TA_LIST_INIT)
-		PVR_REG_NAME(TA_YUV_TEX_BASE)
-		PVR_REG_NAME(TA_YUV_TEX_CTRL)
-		PVR_REG_NAME(TA_YUV_TEX_CNT)
-		PVR_REG_NAME(TA_LIST_CONT)
-		PVR_REG_NAME(TA_NEXT_OPB_INIT)
-		PVR_REG_NAME(SIGNATURE1)
-		PVR_REG_NAME(SIGNATURE2)
-};
-#undef PVR_REG_NAME
-
-static const char *regName(u32 paddr)
-{
-	u32 addr = paddr & pvr_RegMask;
-	static char regName[32];
-	auto it = pvr_reg_names.find(addr);
-	if (it == pvr_reg_names.end())
-	{
-		if (addr >= FOG_TABLE_START_addr && addr <= FOG_TABLE_END_addr)
-			snprintf(regName, sizeof(regName), "FOG_TABLE[%x]", addr - FOG_TABLE_START_addr);
-		else if (addr >= TA_OL_POINTERS_START_addr && addr <= TA_OL_POINTERS_END_addr)
-			snprintf(regName, sizeof(regName), "TA_OL_POINTERS[%x]", addr - TA_OL_POINTERS_START_addr);
-		else if (addr >= PALETTE_RAM_START_addr && addr <= PALETTE_RAM_END_addr)
-			snprintf(regName, sizeof(regName), "PALETTE[%x]", addr - PALETTE_RAM_START_addr);
-		else
-			snprintf(regName, sizeof(regName), "?%08x", paddr);
-		return regName;
-	}
-	else
-		return it->second;
-}
-
-u32 pvr_ReadReg(u32 addr)
-{
-	if ((addr & pvr_RegMask) != SPG_STATUS_addr)
-		DEBUG_LOG(PVR, "read %s.%c == %x", regName(addr),
-				((addr >> 26) & 7) == 2 ? 'b' : (addr & 0x2000000) ? '1' : '0',
-						PvrReg(addr, u32));
-	return PvrReg(addr,u32);
-}
-
-void pvr_WriteReg(u32 paddr,u32 data)
-{
-	u32 addr = paddr & pvr_RegMask;
-	DEBUG_LOG(PVR, "write %s.%c = %x", regName(paddr),
-			((paddr >> 26) & 7) == 2 ? 'b' : (paddr & 0x2000000) ? '1' : '0',
-					data);
-
-	switch (addr)
-	{
-	case ID_addr:
-	case REVISION_addr:
-	case TA_YUV_TEX_CNT_addr:
-		return; // read only
-
-	case STARTRENDER_addr:
-		rend_start_render();
-		YUV_init();
-		return;
-
-	case TA_LIST_INIT_addr:
-		if (data >> 31)
-		{
-			ta_vtx_ListInit(false);
-			TA_NEXT_OPB = TA_NEXT_OPB_INIT;
-			TA_ITP_CURRENT = TA_ISP_BASE;
-		}
-		return;
-
-	case SOFTRESET_addr:
-		if (data & 1)
-			ta_vtx_SoftReset();
-		return;
-
-	case TA_LIST_CONT_addr:
-		//a write of anything works ?
-		ta_vtx_ListInit(true);
-		break;
-	
-	case SPG_CONTROL_addr:
-	case SPG_LOAD_addr:
-		if (PvrReg(addr, u32) != data)
-		{
-			PvrReg(addr, u32) = data;
-			CalculateSync();
-		}
-		return;
-
-	case FB_R_CTRL_addr:
-		{
-			bool vclk_div_changed = (PvrReg(addr, u32) ^ data) & (1 << 23);
-			PvrReg(addr, u32) = data;
-			if (vclk_div_changed)
-				CalculateSync();
-		}
-		return;
-
-	case FB_R_SIZE_addr:
-		if (PvrReg(addr, u32) != data)
-		{
-			PvrReg(addr, u32) = data;
-			fb_dirty = false;
-			check_framebuffer_write();
-		}
-		return;
-
-	case TA_YUV_TEX_BASE_addr:
-		PvrReg(addr, u32) = data & 0x00FFFFF8;
-		YUV_init();
-		return;
-
-	case TA_YUV_TEX_CTRL_addr:
-		PvrReg(addr, u32) = data;
-		YUV_init();
-		return;
-
-	case FB_R_SOF1_addr:
-	case FB_R_SOF2_addr:
-		data &= 0x00fffffc;
-		rend_swap_frame(data);
-		break;
-
-	case FB_W_SOF1_addr:
-		data &= 0x01fffffc;
-		rend_set_fb_write_addr(data);
-		break;
-
-	case FB_W_SOF2_addr:
-		data &= 0x01fffffc;
-		break;
-
-	case SPG_HBLANK_INT_addr:
-		data &= 0x03FF33FF;
-		if (data != SPG_HBLANK_INT.full) {
-			SPG_HBLANK_INT.full = data;
-			rescheduleSPG();
-		}
-		return;
-
-	case PAL_RAM_CTRL_addr:
-		pal_needs_update = pal_needs_update || ((data ^ PAL_RAM_CTRL) & 3) != 0;
-		break;
-
-	default:
-		if (addr >= PALETTE_RAM_START_addr && PvrReg(addr,u32) != data)
-			pal_needs_update = true;
-		else if (addr >= FOG_TABLE_START_addr && addr <= FOG_TABLE_END_addr && PvrReg(addr,u32) != data)
-			rend_updateFogTable();
-		break;
-	}
-	PvrReg(addr, u32) = data;
-}
-
-void Regs_Reset(bool hard)
-{
-	if (hard)
-		memset(&pvr_regs[0], 0, sizeof(pvr_regs));
-	ID_Reg              = 0x17FD11DB;
-	REVISION            = 0x00000011;
-	SOFTRESET           = 0x00000007;
-	SPG_HBLANK_INT.full = 0x031D0000;
-	SPG_VBLANK_INT.full = 0x00150104;
-	FPU_PARAM_CFG       = 0x0007DF77;
-	HALF_OFFSET         = 0x00000007;
-	ISP_FEED_CFG        = 0x00402000;
-	SDRAM_REFRESH       = 0x00000020;
-	SDRAM_ARB_CFG       = 0x0000001F;
-	SDRAM_CFG           = 0x15F28997;
-	SPG_HBLANK.full     = 0x007E0345;
-	SPG_LOAD.full       = 0x01060359;
-	SPG_VBLANK.full     = 0x01500104;
-	SPG_WIDTH.full      = 0x07F1933F;
-	VO_CONTROL.full     = 0x00000108;
-	VO_STARTX.full      = 0x0000009D;
-	VO_STARTY.full      = 0x00150015;
-	SCALER_CTL.full     = 0x00000400;
-	FB_BURSTCTRL        = 0x00090639;
-	PT_ALPHA_REF        = 0x000000FF;
-}
+#include "pvr_regs.h"
+#include "pvr_mem.h"
+#include "Renderer_if.h"
+#include "ta.h"
+#include "spg.h"
+#include <map>
+
+bool pal_needs_update=true;
+
+u8 pvr_regs[pvr_RegSize];
+
+#define PVR_REG_NAME(r) { r##_addr, #r },
+const std::map<u32, const char *> pvr_reg_names = {
+		PVR_REG_NAME(ID)
+		PVR_REG_NAME(REVISION)
+		PVR_REG_NAME(SOFTRESET)
+		PVR_REG_NAME(STARTRENDER)
+		PVR_REG_NAME(TEST_SELECT)
+		PVR_REG_NAME(PARAM_BASE)
+		PVR_REG_NAME(REGION_BASE)
+		PVR_REG_NAME(SPAN_SORT_CFG)
+		PVR_REG_NAME(VO_BORDER_COL)
+		PVR_REG_NAME(FB_R_CTRL)
+		PVR_REG_NAME(FB_W_CTRL)
+		PVR_REG_NAME(FB_W_LINESTRIDE)
+		PVR_REG_NAME(FB_R_SOF1)
+		PVR_REG_NAME(FB_R_SOF2)
+		PVR_REG_NAME(FB_R_SIZE)
+		PVR_REG_NAME(FB_W_SOF1)
+		PVR_REG_NAME(FB_W_SOF2)
+		PVR_REG_NAME(FB_X_CLIP)
+		PVR_REG_NAME(FB_Y_CLIP)
+		PVR_REG_NAME(FPU_SHAD_SCALE)
+		PVR_REG_NAME(FPU_CULL_VAL)
+		PVR_REG_NAME(FPU_PARAM_CFG)
+		PVR_REG_NAME(HALF_OFFSET)
+		PVR_REG_NAME(FPU_PERP_VAL)
+		PVR_REG_NAME(ISP_BACKGND_D)
+		PVR_REG_NAME(ISP_BACKGND_T)
+		PVR_REG_NAME(ISP_FEED_CFG)
+		PVR_REG_NAME(SDRAM_REFRESH)
+		PVR_REG_NAME(SDRAM_ARB_CFG)
+		PVR_REG_NAME(SDRAM_CFG)
+		PVR_REG_NAME(FOG_COL_RAM)
+		PVR_REG_NAME(FOG_COL_VERT)
+		PVR_REG_NAME(FOG_DENSITY)
+		PVR_REG_NAME(FOG_CLAMP_MAX)
+		PVR_REG_NAME(FOG_CLAMP_MIN)
+		PVR_REG_NAME(SPG_TRIGGER_POS)
+		PVR_REG_NAME(SPG_HBLANK_INT)
+		PVR_REG_NAME(SPG_VBLANK_INT)
+		PVR_REG_NAME(SPG_CONTROL)
+		PVR_REG_NAME(SPG_HBLANK)
+		PVR_REG_NAME(SPG_LOAD)
+		PVR_REG_NAME(SPG_VBLANK)
+		PVR_REG_NAME(SPG_WIDTH)
+		PVR_REG_NAME(TEXT_CONTROL)
+		PVR_REG_NAME(VO_CONTROL)
+		PVR_REG_NAME(VO_STARTX)
+		PVR_REG_NAME(VO_STARTY)
+		PVR_REG_NAME(SCALER_CTL)
+		PVR_REG_NAME(PAL_RAM_CTRL)
+		PVR_REG_NAME(SPG_STATUS)
+		PVR_REG_NAME(FB_BURSTCTRL)
+		PVR_REG_NAME(FB_C_SOF)
+		PVR_REG_NAME(Y_COEFF)
+		PVR_REG_NAME(PT_ALPHA_REF)
+		PVR_REG_NAME(TA_OL_BASE)
+		PVR_REG_NAME(TA_ISP_BASE)
+		PVR_REG_NAME(TA_OL_LIMIT)
+		PVR_REG_NAME(TA_ISP_LIMIT)
+		PVR_REG_NAME(TA_NEXT_OPB)
+		PVR_REG_NAME(TA_ITP_CURRENT)
+		PVR_REG_NAME(TA_GLOB_TILE_CLIP)
+		PVR_REG_NAME(TA_ALLOC_CTRL)
+		PVR_REG_NAME(TA_LIST_INIT)
+		PVR_REG_NAME(TA_YUV_TEX_BASE)
+		PVR_REG_NAME(TA_YUV_TEX_CTRL)
+		PVR_REG_NAME(TA_YUV_TEX_CNT)
+		PVR_REG_NAME(TA_LIST_CONT)
+		PVR_REG_NAME(TA_NEXT_OPB_INIT)
+		PVR_REG_NAME(SIGNATURE1)
+		PVR_REG_NAME(SIGNATURE2)
+};
+#undef PVR_REG_NAME
+
+static const char *regName(u32 paddr)
+{
+	u32 addr = paddr & pvr_RegMask;
+	static char regName[32];
+	auto it = pvr_reg_names.find(addr);
+	if (it == pvr_reg_names.end())
+	{
+		if (addr >= FOG_TABLE_START_addr && addr <= FOG_TABLE_END_addr)
+			snprintf(regName, sizeof(regName), "FOG_TABLE[%x]", addr - FOG_TABLE_START_addr);
+		else if (addr >= TA_OL_POINTERS_START_addr && addr <= TA_OL_POINTERS_END_addr)
+			snprintf(regName, sizeof(regName), "TA_OL_POINTERS[%x]", addr - TA_OL_POINTERS_START_addr);
+		else if (addr >= PALETTE_RAM_START_addr && addr <= PALETTE_RAM_END_addr)
+			snprintf(regName, sizeof(regName), "PALETTE[%x]", addr - PALETTE_RAM_START_addr);
+		else
+			snprintf(regName, sizeof(regName), "?%08x", paddr);
+		return regName;
+	}
+	else
+		return it->second;
+}
+
+u32 pvr_ReadReg(u32 addr)
+{
+	if ((addr & pvr_RegMask) != SPG_STATUS_addr)
+		DEBUG_LOG(PVR, "read %s.%c == %x", regName(addr),
+				((addr >> 26) & 7) == 2 ? 'b' : (addr & 0x2000000) ? '1' : '0',
+						PvrReg(addr, u32));
+	return PvrReg(addr,u32);
+}
+
+void pvr_WriteReg(u32 paddr,u32 data)
+{
+	u32 addr = paddr & pvr_RegMask;
+	DEBUG_LOG(PVR, "write %s.%c = %x", regName(paddr),
+			((paddr >> 26) & 7) == 2 ? 'b' : (paddr & 0x2000000) ? '1' : '0',
+					data);
+
+	switch (addr)
+	{
+	case ID_addr:
+	case REVISION_addr:
+	case TA_YUV_TEX_CNT_addr:
+		return; // read only
+
+	case STARTRENDER_addr:
+		rend_start_render();
+		YUV_init();
+		return;
+
+	case TA_LIST_INIT_addr:
+		if (data >> 31)
+		{
+			ta_vtx_ListInit(false);
+			TA_NEXT_OPB = TA_NEXT_OPB_INIT;
+			TA_ITP_CURRENT = TA_ISP_BASE;
+		}
+		return;
+
+	case SOFTRESET_addr:
+		if (data & 1)
+			ta_vtx_SoftReset();
+		return;
+
+	case TA_LIST_CONT_addr:
+		//a write of anything works ?
+		ta_vtx_ListInit(true);
+		break;
+	
+	case SPG_CONTROL_addr:
+	case SPG_LOAD_addr:
+		if (PvrReg(addr, u32) != data)
+		{
+			PvrReg(addr, u32) = data;
+			CalculateSync();
+		}
+		return;
+
+	case FB_R_CTRL_addr:
+		{
+			bool vclk_div_changed = (PvrReg(addr, u32) ^ data) & (1 << 23);
+			PvrReg(addr, u32) = data;
+			if (vclk_div_changed)
+				CalculateSync();
+		}
+		return;
+
+	case FB_R_SIZE_addr:
+		if (PvrReg(addr, u32) != data)
+		{
+			PvrReg(addr, u32) = data;
+			fb_dirty = false;
+			check_framebuffer_write();
+		}
+		return;
+
+	case TA_YUV_TEX_BASE_addr:
+		PvrReg(addr, u32) = data & 0x00FFFFF8;
+		YUV_init();
+		return;
+
+	case TA_YUV_TEX_CTRL_addr:
+		PvrReg(addr, u32) = data;
+		YUV_init();
+		return;
+
+	case FB_R_SOF1_addr:
+	case FB_R_SOF2_addr:
+		data &= 0x00fffffc;
+		rend_swap_frame(data);
+		break;
+
+	case FB_W_SOF1_addr:
+		data &= 0x01fffffc;
+		rend_set_fb_write_addr(data);
+		break;
+
+	case FB_W_SOF2_addr:
+		data &= 0x01fffffc;
+		break;
+
+	case SPG_HBLANK_INT_addr:
+		data &= 0x03FF33FF;
+		if (data != SPG_HBLANK_INT.full) {
+			SPG_HBLANK_INT.full = data;
+			rescheduleSPG();
+		}
+		return;
+
+	case PAL_RAM_CTRL_addr:
+		pal_needs_update = pal_needs_update || ((data ^ PAL_RAM_CTRL) & 3) != 0;
+		break;
+
+	default:
+		if (addr >= PALETTE_RAM_START_addr && PvrReg(addr,u32) != data)
+			pal_needs_update = true;
+		else if (addr >= FOG_TABLE_START_addr && addr <= FOG_TABLE_END_addr && PvrReg(addr,u32) != data)
+			rend_updateFogTable();
+		break;
+	}
+	PvrReg(addr, u32) = data;
+}
+
+void Regs_Reset(bool hard)
+{
+	if (hard)
+		memset(&pvr_regs[0], 0, sizeof(pvr_regs));
+	ID_Reg              = 0x17FD11DB;
+	REVISION            = 0x00000011;
+	SOFTRESET           = 0x00000007;
+	SPG_HBLANK_INT.full = 0x031D0000;
+	SPG_VBLANK_INT.full = 0x00150104;
+	FPU_PARAM_CFG       = 0x0007DF77;
+	HALF_OFFSET         = 0x00000007;
+	ISP_FEED_CFG        = 0x00402000;
+	SDRAM_REFRESH       = 0x00000020;
+	SDRAM_ARB_CFG       = 0x0000001F;
+	SDRAM_CFG           = 0x15F28997;
+	SPG_HBLANK.full     = 0x007E0345;
+	SPG_LOAD.full       = 0x01060359;
+	SPG_VBLANK.full     = 0x01500104;
+	SPG_WIDTH.full      = 0x07F1933F;
+	VO_CONTROL.full     = 0x00000108;
+	VO_STARTX.full      = 0x0000009D;
+	VO_STARTY.full      = 0x00150015;
+	SCALER_CTL.full     = 0x00000400;
+	FB_BURSTCTRL        = 0x00090639;
+	PT_ALPHA_REF        = 0x000000FF;
+}
diff --git a/core/hw/sh4/dyna/driver.cpp b/core/hw/sh4/dyna/driver.cpp
index 4e1fbf3..79f48d2 100644
--- a/core/hw/sh4/dyna/driver.cpp
+++ b/core/hw/sh4/dyna/driver.cpp
@@ -1,6 +1,10 @@
 #include "types.h"
 #include <unordered_set>
 
+#ifdef __EMSCRIPTEN__
+#include <emscripten.h>
+#endif
+
 #include "hw/sh4/sh4_interpreter.h"
 #include "hw/sh4/sh4_core.h"
 #include "hw/sh4/sh4_interrupts.h"
@@ -15,6 +19,10 @@
 
 #if FEAT_SHREC != DYNAREC_NONE
 
+#if defined(__EMSCRIPTEN__) && HOST_CPU == CPU_GENERIC
+extern "C" void wasm_dynarec_init();
+#endif
+
 constexpr u32 CODE_SIZE = 10_MB;
 constexpr u32 TEMP_CODE_SIZE = 1_MB;
 constexpr u32 FULL_SIZE = CODE_SIZE + TEMP_CODE_SIZE;
@@ -342,26 +350,77 @@ void Sh4Recompiler::Reset(bool hard)
 void Sh4Recompiler::Init()
 {
 	INFO_LOG(DYNAREC, "Sh4Recompiler::Init");
+#ifdef __EMSCRIPTEN__
+	EM_ASM({ console.log('[rec_wasm] Sh4Recompiler::Init()  DIAGNOSTIC: super::Init() only, skipping rest'); });
+#endif
 	super::Init();
 	bm_Init();
-	
+
 	if (addrspace::virtmemEnabled())
 		verify(&mem_b[0] == ((u8*)getContext()->sq_buffer + sizeof(Sh4Context) + 0x0C000000));
 
+	// Call the platform-specific magic to make the pages RWX
+	CodeCache = nullptr;
+#ifdef FEAT_NO_RWX_PAGES
+	{
+		bool rc = virtmem::prepare_jit_block(SH4_TCB, FULL_SIZE, (void**)&CodeCache, &cc_rx_offset);
+		verify(rc);
+	}
+#else
+	{
+		bool rc = virtmem::prepare_jit_block(SH4_TCB, FULL_SIZE, (void**)&CodeCache);
+		verify(rc);
+	}
+#endif
+	verify(CodeCache != nullptr);
+	TempCodeCache = CodeCache + CODE_SIZE;
+
+#ifdef __EMSCRIPTEN__
+	// DIAGNOSTIC: return after bm_Init + prepare_jit_block, skip wasm_dynarec_init/sh4Dynarec->init/bm_ResetCache
+	EM_ASM({ console.log('[rec_wasm] DIAGNOSTIC: Init() returning after prepare_jit_block, skipping dynarec init + bm_ResetCache'); });
+	return;
+#endif
+	bm_Init();
+
+	if (addrspace::virtmemEnabled())
+		verify(&mem_b[0] == ((u8*)getContext()->sq_buffer + sizeof(Sh4Context) + 0x0C000000));
+
+#ifdef __EMSCRIPTEN__
+	EM_ASM({ console.log('[rec_wasm] Sh4Recompiler::Init()  step 3: prepare_jit_block()'); });
+#endif
 	// Call the platform-specific magic to make the pages RWX
 	CodeCache = nullptr;
 #ifdef FEAT_NO_RWX_PAGES
 	bool rc = virtmem::prepare_jit_block(SH4_TCB, FULL_SIZE, (void**)&CodeCache, &cc_rx_offset);
 #else
 	bool rc = virtmem::prepare_jit_block(SH4_TCB, FULL_SIZE, (void**)&CodeCache);
+#endif
+#ifdef __EMSCRIPTEN__
+	EM_ASM({ console.log('[rec_wasm] Sh4Recompiler::Init()  step 3 result: rc=' + $0 + ' CodeCache=' + $1); }, (int)rc, (int)(uintptr_t)CodeCache);
 #endif
 	verify(rc);
 	// Ensure the pointer returned is non-null
 	verify(CodeCache != nullptr);
 
 	TempCodeCache = CodeCache + CODE_SIZE;
+#if defined(__EMSCRIPTEN__) && HOST_CPU == CPU_GENERIC
+	// Ensure WASM dynarec is initialized  the static constructor may not have
+	// run if the linker stripped the translation unit from the archive.
+	wasm_dynarec_init();
+#endif
+#ifdef __EMSCRIPTEN__
+	EM_ASM({ console.log('[rec_wasm] Sh4Recompiler::Init()  step 4: sh4Dynarec->init(), sh4Dynarec=' + $0 + ' ctx=' + $1); },
+		(int)(uintptr_t)sh4Dynarec, (int)(uintptr_t)getContext());
+#endif
+	verify(sh4Dynarec != nullptr);
 	sh4Dynarec->init(*getContext(), codeBuffer);
+#ifdef __EMSCRIPTEN__
+	EM_ASM({ console.log('[rec_wasm] Sh4Recompiler::Init()  step 5: bm_ResetCache()'); });
+#endif
 	bm_ResetCache();
+#ifdef __EMSCRIPTEN__
+	EM_ASM({ console.log('[rec_wasm] Sh4Recompiler::Init()  COMPLETE'); });
+#endif
 }
 
 void Sh4Recompiler::Term()
diff --git a/core/hw/sh4/dyna/shil_canonical.h b/core/hw/sh4/dyna/shil_canonical.h
index a1be200..3727ab8 100644
--- a/core/hw/sh4/dyna/shil_canonical.h
+++ b/core/hw/sh4/dyna/shil_canonical.h
@@ -747,6 +747,22 @@ u32,f1,(f32 f1),
 	}
 	return res;
 )
+#else
+// CPU_GENERIC (Emscripten/WASM)  same behavior as ARM (NaN  0x80000000)
+shil_canonical
+(
+u32,f1,(f32 f1),
+	s32 res;
+	if (f1 > 2147483520.0f) {
+		res = 0x7fffffff;
+	}
+	else {
+		res = (s32)f1;
+		if (std::isnan(f1))
+			res = 0x80000000;
+	}
+	return res;
+)
 #endif
 
 shil_compile
diff --git a/core/hw/sh4/dyna/ssa.cpp b/core/hw/sh4/dyna/ssa.cpp
index 85c1fdf..a62439b 100644
--- a/core/hw/sh4/dyna/ssa.cpp
+++ b/core/hw/sh4/dyna/ssa.cpp
@@ -489,6 +489,11 @@ void SSAOptimizer::ConstPropPass()
 				// and if those pages are read-only, then we can directly read the memory at compile time
 				// and propagate the read value as a constant.
 				if (op.op == shop_readm  && block->read_only
+#ifdef __EMSCRIPTEN__
+						&& false  // WASM: mprotect is a no-op, so read-only pages
+						          // aren't actually protected. Compile-time reads
+						          // become stale when the page is written to.
+#endif
 						&& (op.rs1._imm >> 12) >= (block->vaddr >> 12)
 						&& (op.rs1._imm >> 12) <= ((block->vaddr + block->sh4_code_size - 1) >> 12)
 						&& op.size <= 4)
diff --git a/core/hw/sh4/sh4_core_regs.cpp b/core/hw/sh4/sh4_core_regs.cpp
index 7542f13..bfaec7d 100644
--- a/core/hw/sh4/sh4_core_regs.cpp
+++ b/core/hw/sh4/sh4_core_regs.cpp
@@ -120,6 +120,10 @@ static void setHostRoundingMode(u32 roundingMode, u32 denorm2zero)
                 : "r"(off_mask), "r"(on_mask)
 				: "x10"
             );
+    #elif defined(__EMSCRIPTEN__) || defined(__wasm__) || HOST_CPU == CPU_GENERIC
+		// WASM/generic: no hardware FPU control  rounding mode is not configurable
+		(void)roundingMode;
+		(void)denorm2zero;
     #else
 	#error "SetFloatStatusReg: Unsupported platform"
     #endif
diff --git a/core/linux/context.cpp b/core/linux/context.cpp
index 461ff26..a8ba32c 100644
--- a/core/linux/context.cpp
+++ b/core/linux/context.cpp
@@ -130,6 +130,10 @@ static void context_segfault(host_context_t* hostctx, void* segfault_ctx)
     #else
         #error "Unsupported OS"
 	#endif
+#elif HOST_CPU == CPU_GENERIC
+	// No segfault context handling for generic/WASM platform (interpreter only)
+	(void)hostctx;
+	(void)segfault_ctx;
 #else
 	#error Unsupported HOST_CPU
 #endif
diff --git a/core/linux/posix_vmem.cpp b/core/linux/posix_vmem.cpp
index 4610515..f52ac64 100644
--- a/core/linux/posix_vmem.cpp
+++ b/core/linux/posix_vmem.cpp
@@ -4,7 +4,7 @@
 // Android and OSX since they are slightly different in some areas.
 #include "types.h"
 
-#ifndef __SWITCH__
+#if !defined(__SWITCH__) && !defined(__EMSCRIPTEN__)
 #include <sys/mman.h>
 #include <sys/types.h>
 #include <sys/stat.h>
@@ -326,7 +326,50 @@ void release_jit_block(void *code_area1, void *code_area2, size_t size)
 
 } // namespace virtmem
 
-#endif // !__SWITCH__
+#endif // !__SWITCH__ && !__EMSCRIPTEN__
+
+#ifdef __EMSCRIPTEN__
+// Emscripten: no mmap/shm_open/mprotect support.
+// All virtmem functions are no-ops. addrspace::initMappings() will use
+// the malloc-based fallback path when virtmem::init() returns false.
+#include "hw/mem/addrspace.h"
+#include "hw/sh4/sh4_if.h"
+#include "oslib/virtmem.h"
+
+namespace virtmem
+{
+
+bool region_lock(void *start, size_t len) { return true; }
+bool region_unlock(void *start, size_t len) { return true; }
+bool region_set_exec(void *start, size_t len) { return true; }
+bool init(void **vmem_base_addr, void **sh4rcb_addr, size_t ramSize) { return false; }
+void destroy() {}
+void reset_mem(void *ptr, unsigned size_bytes) { memset(ptr, 0, size_bytes); }
+void ondemand_page(void *address, unsigned size_bytes) {}
+void create_mappings(const Mapping *vmem_maps, unsigned nummaps) {}
+bool prepare_jit_block(void *code_area, size_t size, void **code_area_rwx) {
+	// WASM JIT: no native code execution, but we need a valid buffer for the block manager
+	// Allocate a dummy buffer  rec_wasm doesn't write native code into it, but driver.cpp expects non-null
+	static u8* wasmJitBuffer = nullptr;
+	if (!wasmJitBuffer)
+		wasmJitBuffer = (u8*)malloc(size);
+	if (!wasmJitBuffer)
+		return false;
+	memset(wasmJitBuffer, 0, size);
+	*code_area_rwx = wasmJitBuffer;
+	return true;
+}
+bool prepare_jit_block(void *code_area, size_t size, void **code_area_rw, ptrdiff_t *rx_offset) {
+	bool rc = prepare_jit_block(code_area, size, code_area_rw);
+	if (rc && rx_offset)
+		*rx_offset = 0;
+	return rc;
+}
+void release_jit_block(void *code_area, size_t size) { /* buffer is static, leaked intentionally */ }
+void release_jit_block(void *code_area1, void *code_area2, size_t size) {}
+
+} // namespace virtmem
+#endif // __EMSCRIPTEN__
 
 namespace virtmem
 {
diff --git a/core/oslib/virtmem.h b/core/oslib/virtmem.h
index 143d093..5b72309 100644
--- a/core/oslib/virtmem.h
+++ b/core/oslib/virtmem.h
@@ -1,7 +1,10 @@
 #pragma once
 #include "types.h"
 
-#if defined(_WIN32) || defined(TARGET_IPHONE) || defined(TARGET_ARM_MAC)
+#if defined(__EMSCRIPTEN__)
+// Emscripten: no native code execution. Use a pointer (allocated via malloc in prepare_jit_block).
+#define DECLARE_CODE_CACHE(Name, Size) static u8 *Name;
+#elif defined(_WIN32) || defined(TARGET_IPHONE) || defined(TARGET_ARM_MAC)
 #define DECLARE_CODE_CACHE(Name, Size) static u8 *Name;
 #elif defined(__ANDROID__)
 #define DECLARE_CODE_CACHE(Name, Size) alignas(4096) static u8 Name[Size];
diff --git a/core/ui/gui.cpp b/core/ui/gui.cpp
index 0f29057..4f87441 100644
--- a/core/ui/gui.cpp
+++ b/core/ui/gui.cpp
@@ -17,6 +17,9 @@
     along with Flycast.  If not, see <https://www.gnu.org/licenses/>.
  */
 #include "gui.h"
+#ifdef __EMSCRIPTEN__
+#include <emscripten.h>
+#endif
 #include "rend/osd.h"
 #include "cfg/cfg.h"
 #include "imgui.h"
@@ -1716,6 +1719,11 @@ void fatal_error(const char* text, ...)
     vsnprintf(temp, sizeof(temp), text, args);
     va_end(args);
     ERROR_LOG(COMMON, "%s", temp);
+#ifdef __EMSCRIPTEN__
+    // Make fatal errors visible in browser console (ERROR_LOG and os_notify
+    // don't reach console.log on Emscripten)
+    EM_ASM({ console.error('[FATAL] ' + UTF8ToString($0)); }, temp);
+#endif
 
     os_notify("Fatal Error", 20000, temp);
 }
diff --git a/shell/cmake/DetectArchitecture.cmake b/shell/cmake/DetectArchitecture.cmake
index 9a4b855..031fd86 100644
--- a/shell/cmake/DetectArchitecture.cmake
+++ b/shell/cmake/DetectArchitecture.cmake
@@ -21,6 +21,9 @@ function(detect_architecture symbol arch)
     endif()
 endfunction()
 
+detect_architecture("__EMSCRIPTEN__" wasm32)
+detect_architecture("__wasm__" wasm32)
+
 detect_architecture("__ARM64__" arm64)
 detect_architecture("__aarch64__" arm64)
 detect_architecture("_M_ARM64" arm64)
diff --git a/shell/libretro/libretro.cpp b/shell/libretro/libretro.cpp
index 9dcc6b3..9b4e7c2 100644
--- a/shell/libretro/libretro.cpp
+++ b/shell/libretro/libretro.cpp
@@ -18,6 +18,9 @@
 #include <cstdarg>
 #include <math.h>
 #include "types.h"
+#ifdef __EMSCRIPTEN__
+#include <emscripten.h>
+#endif
 #ifndef _WIN32
 #include <sys/time.h>
 #endif
@@ -1198,6 +1201,67 @@ static void update_variables(bool first_startup)
 
 void retro_run()
 {
+#ifdef __EMSCRIPTEN__
+	// Frame pacing: cap at ~60fps regardless of display refresh rate.
+	// On 120Hz+ monitors, rAF fires faster than 60Hz, causing 2x+ game speed.
+	{
+		static double last_frame_ms = 0;
+		static int real_frames = 0;
+		static int skipped_frames = 0;
+		static double hud_last_update = 0;
+
+		double now = emscripten_get_now();
+
+		if (last_frame_ms > 0 && (now - last_frame_ms) < 15.0) {
+			skipped_frames++;
+			video_cb(0, framebufferWidth, framebufferHeight, 0);
+			// Update HUD even on skipped frames so skip count stays current
+			if (now - hud_last_update >= 1000.0) {
+				double speed_pct = (real_frames / 60.0) * 100.0;
+				EM_ASM({
+					var el = document.getElementById('fc-hud');
+					if (!el) {
+						el = document.createElement('div');
+						el.id = 'fc-hud';
+						el.style.cssText = 'position:fixed;top:8px;left:8px;z-index:99999;'
+							+ 'background:rgba(0,0,0,0.7);color:#fff;font:12px monospace;'
+							+ 'padding:4px 8px;pointer-events:none;border-radius:3px;';
+						document.body.appendChild(el);
+					}
+					el.textContent = 'FPS:' + $0 + ' Skip:' + $1 + ' Speed:' + $2.toFixed(0) + '%';
+				}, real_frames, skipped_frames, speed_pct);
+				real_frames = 0;
+				skipped_frames = 0;
+				hud_last_update = now;
+			}
+			return;
+		}
+		last_frame_ms = now;
+		real_frames++;
+
+		// Update HUD once per second
+		if (hud_last_update == 0) hud_last_update = now;
+		if (now - hud_last_update >= 1000.0) {
+			double speed_pct = (real_frames / 60.0) * 100.0;
+			EM_ASM({
+				var el = document.getElementById('fc-hud');
+				if (!el) {
+					el = document.createElement('div');
+					el.id = 'fc-hud';
+					el.style.cssText = 'position:fixed;top:8px;left:8px;z-index:99999;'
+						+ 'background:rgba(0,0,0,0.7);color:#fff;font:12px monospace;'
+						+ 'padding:4px 8px;pointer-events:none;border-radius:3px;';
+					document.body.appendChild(el);
+				}
+				el.textContent = 'FPS:' + $0 + ' Skip:' + $1 + ' Speed:' + $2.toFixed(0) + '%';
+			}, real_frames, skipped_frames, speed_pct);
+			real_frames = 0;
+			skipped_frames = 0;
+			hud_last_update = now;
+		}
+	}
+#endif
+
 	bool updated = false;
 	if (environ_cb(RETRO_ENVIRONMENT_GET_VARIABLE_UPDATE, &updated) && updated)
 		update_variables(false);
@@ -1275,6 +1339,22 @@ void retro_run()
 		environ_cb(RETRO_ENVIRONMENT_SET_SYSTEM_AV_INFO, &avinfo);
 	}
 
+#ifdef __EMSCRIPTEN__
+	{
+		static int videocb_count = 0;
+		static int first_non_dupe = 0;
+		videocb_count++;
+		if (!is_dupe && first_non_dupe == 0) {
+			first_non_dupe = videocb_count;
+			EM_ASM({ console.log('[retro] FIRST REAL FRAME at video_cb #' + $0 + ' w=' + $1 + ' h=' + $2); },
+				videocb_count, framebufferWidth, framebufferHeight);
+		}
+		if (videocb_count <= 5 || (videocb_count % 10) == 0) {
+			EM_ASM({ console.log('[retro] video_cb #' + $0 + ': is_dupe=' + $1 + ' w=' + $2 + ' h=' + $3); },
+				videocb_count, is_dupe ? 1 : 0, framebufferWidth, framebufferHeight);
+		}
+	}
+#endif
 	video_cb(is_dupe ? 0 : RETRO_HW_FRAME_BUFFER_VALID, framebufferWidth, framebufferHeight, 0);
 
 	if (!config::ThreadedRendering || config::LimitFPS)
@@ -3579,24 +3659,30 @@ static void retro_keyboard_event(bool down, unsigned keycode, uint32_t character
 
 void fatal_error(const char* text, ...)
 {
+	va_list args;
+	char temp[2048];
+	va_start(args, text);
+	vsprintf(temp, text, args);
+	va_end(args);
+	strcat(temp, "\n");
 	if (log_cb)
-	{
-		va_list args;
-		char temp[2048];
-		va_start(args, text);
-		vsprintf(temp, text, args);
-		va_end(args);
-		strcat(temp, "\n");
 		log_cb(RETRO_LOG_ERROR, temp);
-	}
+#ifdef __EMSCRIPTEN__
+	EM_ASM({ console.error('[FATAL] ' + UTF8ToString($0)); }, temp);
+#endif
 }
 
 [[noreturn]] void os_DebugBreak()
 {
 	ERROR_LOG(COMMON, "DEBUGBREAK!");
+#ifdef __EMSCRIPTEN__
+	EM_ASM({ console.error('[os_DebugBreak] called! Stack: ' + new Error().stack); });
+#endif
 	//exit(-1);
 #ifdef __SWITCH__
 	svcExitProcess();
+#elif defined(__EMSCRIPTEN__)
+	abort();
 #else
 	__builtin_trap();
 #endif
